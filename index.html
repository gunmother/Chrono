<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chrono</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">
<style>
  :root{
    --bg:#e3eaf2; --ink:#42586d;
    --icon-inactive:#42586d; --icon-active:#4ff7ff;
    --pressed-navy:#355169; --turq-glow: rgba(79,247,255,.75);

    --off:5px; --blur:9px; --hi:#ffffff; --lo:#b7c3d1;
    --gap:24px; --radius:12px;

    --border:#c6cfda; --grid-line:#cfd9e5;
    --chart-bg:#d1dce8; --mask-surface: var(--bg);

    --hour-col:64px; --dow-h:32px; --label-size:12px;

    --marquee-border:5px;
    --marquee-shadow:0 0 12px 6px var(--turq-glow);

    --handle-stroke:#5e7286;
    --chev-stroke-w:2.2;
    --handle-gap:10px;
    --top-handle-extra:10px;
    --handle-height-mult:1.6;

    --stamp-gap:6px; --stamp-h:26px;

    --neu-shadow-outer:
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       var(--off)         var(--off)         var(--blur) var(--lo);
    --neu-shadow-inner:
       inset calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       inset var(--off)         var(--off)         var(--blur) var(--lo);
    --neu-offset-shadow: 8px 10px 20px rgba(0,0,0,.22);
  }

  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--ink);
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; overflow:hidden;
    -webkit-tap-highlight-color: transparent;
  }
  *{box-sizing:border-box}

  .app{
    width:clamp(320px, 96vw, 520px);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(16px, env(safe-area-inset-bottom)));
    margin:max(16px, env(safe-area-inset-top)) auto;
    display:flex; flex-direction:column; gap:var(--gap); padding:0 var(--gap);
  }

  #screen{
    flex:1; min-height:420px; border-radius:var(--radius); background:var(--bg);
    box-shadow: var(--neu-shadow-outer);
    position:relative; overflow:hidden;
  }

  /* Controls */
  .controls{ display:flex; gap:var(--gap); padding-bottom:2px; }
  .neu-btn{
    --btn-d: calc((100% - (3 * var(--gap))) / 4);
    flex:0 0 var(--btn-d); width:var(--btn-d); aspect-ratio:1/1;
    border-radius:50%; border:none; outline:none; cursor:pointer;
    background:var(--bg); display:grid; place-items:center;
    box-shadow: var(--neu-shadow-outer);
    transition: box-shadow .2s ease, background .2s ease, transform .06s ease;
  }
  .neu-btn svg{
    width:86%; height:auto; stroke:var(--icon-inactive); stroke-width:1.25;
    fill:none; stroke-linecap:round; stroke-linejoin:round;
    filter: drop-shadow(-0.6px -0.6px 0 var(--hi)) drop-shadow(0.6px 0.6px 0 var(--lo));
  }
  .neu-btn.is-pressed{
    background:
      radial-gradient(circle at 82% 82%, rgba(79,247,255,.12) 0%, rgba(79,247,255,.07) 34%, rgba(79,247,255,0) 60%),
      var(--pressed-navy);
    box-shadow:
       var(--off)         var(--off)         var(--blur) var(--hi),
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--lo);
  }
  .neu-btn.is-pressed svg{
    stroke:var(--icon-active);
    filter:drop-shadow(0 0 2px var(--turq-glow)) drop-shadow(0 0 10px var(--turq-glow));
  }
  .neu-btn:active{ transform:scale(.985); }
  .neu-btn--sm{ width:44px; height:44px; border-radius:12px; background:var(--bg); border:none; cursor:pointer; box-shadow:var(--neu-shadow-outer); display:grid; place-items:center; }
  .neu-btn--sm svg{ width:22px; height:22px; stroke:var(--icon-inactive); stroke-width:1.25; fill:none; stroke-linecap:round; stroke-linejoin:round; filter: drop-shadow(-0.6px -0.6px 0 var(--hi)) drop-shadow(0.6px 0.6px 0 var(--lo)); }
  .neu-btn--sm.is-pressed{ background:radial-gradient(circle at 82% 82%, rgba(79,247,255,.12) 0%, rgba(79,247,255,.07) 34%, rgba(79,247,255,0) 60%), var(--pressed-navy); }

  .wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; min-width:0 }
  .head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:8px 10px; }
  .title{ text-align:center; font-weight:800; font-size:16px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

  .grid-area{ position:relative; overflow:hidden }
  .hours{ position:absolute; top:var(--dow-h); bottom:0; left:0; width:var(--hour-col); pointer-events:none; z-index:0 }
  .hour-stamp{ position:absolute; right:8px; transform:translateY(-50%); font-size:var(--label-size); color:var(--ink); opacity:.95; white-space:nowrap; text-align:right; }

  .top-row{ position:absolute; top:0; left:var(--hour-col); right:0; height:var(--dow-h); display:grid; align-items:center; min-width:0 }
  .top-row.week{ grid-template-columns:repeat(7,1fr); column-gap:8px; padding:0 6px }
  .day-pill{ justify-self:center; border:none; padding:0 2px; text-align:center; font-size:clamp(11px, 2vw, 13px); background:transparent; color:var(--ink) }

  .grid{
    position:absolute; top:var(--dow-h); left:var(--hour-col); right:0; bottom:0;
    background:var(--chart-bg);
    border-left:1px solid var(--grid-line); border-right:1px solid var(--grid-line);
    z-index:0;
  }

  /* Blocks: UNDER mask, no outlines/shadows, but clickable */
  .blocksHost{ position:absolute; inset:0; pointer-events:auto; z-index:0; }
  .blockRect{
    position:absolute; border-radius:10px; box-shadow:none; border:none; cursor:pointer;
  }

  .mask{ position:absolute; inset:0; pointer-events:none; shape-rendering:crispEdges; z-index:1 }

  /* Selection marquee & handles */
  .selHost{ position:absolute; inset:0; overflow:visible; pointer-events:none; z-index:2; }
  .marqueeRect{
    position:absolute; box-sizing:border-box; background:transparent;
    border:var(--marquee-border) solid #fff; border-radius:12px;
    pointer-events:none; box-shadow: var(--marquee-shadow);
  }

  /* NEW: chevron handles rendered ABOVE grid & mask */
  .handle{ position:absolute; left:0; width:100%; pointer-events:auto; cursor:ns-resize; z-index:5; touch-action:none; display:grid; place-items:center; }
  .chev-chip{ width:100%; height:100%; border-radius:14px; background:var(--bg); box-shadow:var(--neu-shadow-outer); display:grid; place-items:center; }
  .chev path{ fill:none; stroke:var(--handle-stroke); stroke-width:var(--chev-stroke-w); stroke-linecap:round; stroke-linejoin:round; filter: drop-shadow(-0.6px -0.6px 0 var(--hi)) drop-shadow(0.6px 0.6px 0 var(--lo)); }

  /* NEW: selector time stamps (24h only, narrower) */
  .stamp{ position:absolute; left:50%; transform:translateX(-50%); background:var(--pressed-navy); color:var(--icon-active);
    border:1px solid #273b4d; border-radius:8px; padding:2px 6px; font-size:12px; font-variant-numeric:tabular-nums; font-weight:900; letter-spacing:.02em; white-space:nowrap; pointer-events:none; z-index:6; height:22px; display:grid; place-items:center; min-width:56px }

  .overlayRoot{ position:fixed; inset:0; z-index:7; pointer-events:none; }
  .ov-group{ position:absolute; pointer-events:none; }

  /* Ghosts for drag/copy */
  .ghost{ position:absolute; border:2px dashed; border-radius:10px; pointer-events:none; opacity:.5; }
  .ghost.green{ border-color:#16a34a; box-shadow:0 0 0 2px rgba(22,163,74,.3) inset; }
  .ghost.red{ border-color:#dc2626; box-shadow:0 0 0 2px rgba(220,38,38,.25) inset; }

  .selBtns{ position:fixed; z-index:8; display:grid; gap:8px; pointer-events:auto; }
  .selBtnHidden{ display:none !important; }
  .placeBtn{ position:fixed; z-index:9; display:none; }

  /* Month unchanged */
  .month-wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto auto 1fr; }
  .month-dow{ display:grid; grid-template-columns:repeat(7,1fr); padding:6px 10px 0 10px; gap:6px; font-size:12px; letter-spacing:0.05em; color:var(--ink) }
  .month-grid{ height:100%; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; gap:8px; padding:10px; }
  .mcell{ position:relative; background:var(--bg); color:var(--ink); border-radius:8px; box-shadow:-1px -1px 0 0 var(--hi), 1px 1px 0 0 var(--lo); }
  .mcell.muted{ color:#8da0b3 }
  .mcell.today{ box-shadow:var(--neu-shadow-outer); }
  .mcell.today::before{ content:""; position:absolute; top:6px; right:6px; width:24px; height:24px; border-radius:50%; background:var(--pressed-navy); box-shadow:0 0 2px rgba(79,247,255,.35), 0 0 10px rgba(79,247,255,.35); }
  .mcell.today .date{ position:absolute; top:6px; right:6px; width:24px; height:24px; display:grid; place-items:center; color:var(--icon-active); }

  /* Modal (neumorphic with offset shadow) */
  .veil{ position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:10; }
  .modal{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(92vw, 360px); background:var(--bg); color:var(--ink);
    border-radius:12px; box-shadow: var(--neu-shadow-outer), var(--neu-offset-shadow); z-index:11;
    display:grid; grid-template-rows:auto 1fr auto; max-height:88vh; overflow:hidden;
  }
  .modal .head{ padding:12px 14px; font-weight:800; background:var(--bg); box-shadow: var(--neu-shadow-inner); display:flex; align-items:center; justify-content:center; }
  .modal .foot{ padding:10px 14px; display:flex; justify-content:flex-end; gap:10px; background:var(--bg); box-shadow: var(--neu-shadow-inner); }
  .btn{ border:none; background:var(--bg); border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; box-shadow:var(--neu-shadow-outer); }
  .btn.icon{ width:44px; height:44px; display:grid; place-items:center; }
  .btn.icon svg{ width:18px; height:18px; stroke:var(--icon-inactive); fill:none; stroke-width:1.5; filter: drop-shadow(-0.6px -0.6px 0 var(--hi)) drop-shadow(0.6px 0.6px 0 var(--lo)); }

  .settings-wrap{ padding:14px; display:grid; gap:14px; overflow:auto; }
  .neu-field{ background:var(--bg); border-radius:12px; padding:10px; box-shadow:var(--neu-shadow-inner); display:grid; gap:8px; }
  .neu-select{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; background:var(--bg); box-shadow:var(--neu-shadow-outer); cursor:pointer; user-select:none; }
  .neu-select .ph{ opacity:.7; }
  .neu-select svg{ width:18px; height:18px; stroke:var(--icon-inactive); fill:none; stroke-width:1.5; filter: drop-shadow(-0.6px -0.6px 0 var(--hi)) drop-shadow(0.6px 0.6px 0 var(--lo)); }
  .neu-menu{ display:none; }
  .neu-menu.open{ display:block; }
  .menu-card{ margin-top:8px; background:var(--bg); border-radius:12px; box-shadow:var(--neu-shadow-outer); overflow:hidden; }
  .menu-item{ padding:10px 12px; cursor:pointer; display:flex; align-items:center; gap:10px; }
  .menu-item:not(:last-child){ border-bottom:1px solid var(--grid-line); }
  .menu-dot{ width:14px; height:14px; border-radius:50%; box-shadow:none; } /* exact color, no overlay */

  .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .chip{ display:flex; align-items:center; gap:8px; border-radius:999px; padding:6px 10px; background:var(--bg); box-shadow:var(--neu-shadow-outer); font-weight:800; width:fit-content; }
  .dot{ width:12px; height:12px; border-radius:50%; border:1px solid #273b4d; box-shadow:var(--neu-shadow-inner); }
  .chip .edit{ border:none; background:transparent; display:grid; place-items:center; cursor:pointer; }
  .chip .edit svg{ width:16px; height:16px; stroke:var(--icon-inactive); fill:none; stroke-width:1.6; filter: drop-shadow(-0.6px -0.6px 0 var(--hi)) drop-shadow(0.6px 0.6px 0 var(--lo)); }

  .note-input{ background:var(--bg); border:none; outline:none; border-radius:12px; padding:10px 12px; font-weight:700; box-shadow:var(--neu-shadow-inner); }

  .row4{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .time-row{ display:grid; gap:8px; }
  .time-pair{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; background:var(--bg); box-shadow:var(--neu-shadow-outer); }
  .time-btn{ border:none; background:transparent; font-weight:800; cursor:pointer; user-select:none; }
  .time-day{ font-weight:900; letter-spacing:.02em; opacity:.85; }

  .stat-line{ display:flex; justify-content:space-between; font-weight:800; padding:8px 0; border-bottom:1px solid #d8e1ec; }
  .pct{ font-weight:900; }
  .pct.green{ color:#15a05c; } .pct.yellow{ color:#b18a00; } .pct.orange{ color:#c85b00; } .pct.red{ color:#bf1b1b; }
</style>
</head>
<body>
  <main class="app">
    <section id="screen" aria-live="polite" aria-label="Content area"></section>

    <nav class="controls" role="group" aria-label="Primary views">
      <button class="neu-btn" aria-label="Day view" aria-pressed="false" data-view="day" title="Day">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="5.5"/>
          <line x1="12" y1="2"  x2="12" y2="5"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="2"  y1="12" x2="5"  y2="12"/>
          <line x1="19" y1="12" x2="22" y2="12"/>
          <line x1="17" y1="7"  x2="19" y2="5"/>
          <line x1="7"  y1="17" x2="5"  y2="19"/>
          <line x1="7"  y1="7"  x2="5"  y2="5"/>
          <line x1="17" y1="17" x2="19" y2="19"/>
        </svg>
      </button>

      <button class="neu-btn" aria-label="Week view" aria-pressed="false" data-view="week" title="Week">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="4.5" width="18" height="15" rx="3"/>
          <line x1="3" y1="8" x2="21" y2="8"/>
          <line x1="6" y1="10" x2="6" y2="18.5"/>
          <line x1="9" y1="10" x2="9" y2="18.5"/>
          <line x1="12" y1="10" x2="12" y2="18.5"/>
          <line x1="15" y1="10" x2="15" y2="18.5"/>
          <line x1="18" y1="10" x2="18" y2="18.5"/>
        </svg>
      </button>

      <button class="neu-btn" aria-label="Month view" aria-pressed="false" data-view="month" title="Month">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="4.5" width="18" height="15" rx="3"/>
          <line x1="3" y1="8" x2="21" y2="8"/>
          <g>
            <circle cx="7" cy="11" r="0.8"/><circle cx="11" cy="11" r="0.8"/><circle cx="15" cy="11" r="0.8"/>
            <circle cx="7" cy="14" r="0.8"/><circle cx="11" cy="14" r="0.8"/><circle cx="15" cy="14" r="0.8"/>
            <circle cx="7" cy="17" r="0.8"/><circle cx="11" cy="17" r="0.8"/><circle cx="15" cy="17" r="0.8"/>
          </g>
        </svg>
      </button>

      <button class="neu-btn" aria-label="To-Do list" aria-pressed="false" data-view="todo" title="To-Do">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="3"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <polyline points="7,14 10,17 17,10"/>
        </svg>
      </button>
    </nav>
  </main>

<script>
console.info('Chrono r73 — 24h selector stamps; tap-through fix; handles above grid; hard-wall collisions; drag/copy ghost + Place; assignment header + weekly total; exact hex; stale-label fix.');

const screenEl = document.getElementById('screen');
const buttons = [...document.querySelectorAll('.neu-btn')];

let activeView = null;
let activeDayISO = toISO(new Date());
let visibleWeekFirst = weekStart(new Date());

let modalOpen = false;              // tap-through guard
let mode = 'none';                  // 'none' | 'drag' | 'copy'
let ghostEl = null;                 // ghost outline element
let placeBtn = null;                // Place button element

const SHORT_DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTH_INIT=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function toISO(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function weekStart(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function snap15(n){ return 15 * Math.round((+n||0)/15); }
function HHMM_24(min){ const m=((Math.round(min)|0)+1440)%1440; const h=Math.floor(m/60), r=m%60; return `${String(h).padStart(2,'0')}:${String(r).padStart(2,'0')}`; } // 24h
function hourToAMPM(h){ return h===0? '12 AM' : h<12? `${h} AM` : h===12? '12 PM' : `${h-12} PM`; }
function HHMM_ampm(min){ const m=((Math.round(min)|0)+1440)%1440; let h=Math.floor(m/60), r=m%60; const am=h<12; h=(h%12)||12; return `${String(h).padStart(2,'0')}:${String(r).padStart(2,'0')} ${am?'AM':'PM'}`; } // kept for non-selector UI

const DAY_MS = 86400000;
function weekStamp(d){ return +weekStart(d); }
function stampToDate(st){ return new Date(st); }
function getVisibleWeekStamp(){ return weekStamp(visibleWeekFirst); }

new ResizeObserver(()=> {
  const w = screenEl.getBoundingClientRect().width;
  document.documentElement.style.setProperty('--panelW', Math.max(320, Math.floor(w))+'px');
}).observe(screenEl);

/* storage */
const DB_NAME='chronoDB', DB_VERSION=29;
let dbPromise=null, STORAGE_MODE='idb';
function idbSupported(){ try { return !!window.indexedDB; } catch { return false; } }
function idbOpen(){
  if(!idbSupported()){ STORAGE_MODE='ls'; return Promise.resolve(null); }
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv',{keyPath:'k'});
      if(!db.objectStoreNames.contains('blocks')) db.createObjectStore('blocks',{keyPath:'id'});
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror   = ()=>reject(req.error);
  });
  return dbPromise.catch(()=>{ STORAGE_MODE='ls'; return null; });
}
async function storageSet(k,v){
  if(STORAGE_MODE==='ls'){ if(v===undefined) localStorage.removeItem(k); else localStorage.setItem(k, JSON.stringify(v)); return true; }
  const db = await idbOpen(); if(!db){ STORAGE_MODE='ls'; return storageSet(k,v); }
  return new Promise((res,rej)=>{
    const tx=db.transaction('kv','readwrite');
    const store=tx.objectStore('kv');
    if(v===undefined) store.delete(k); else store.put({k,v});
    tx.oncomplete=()=>res(true); tx.onerror = ()=>rej(tx.error);
  });
}
async function storageGet(k){
  if(STORAGE_MODE==='ls'){ const s=localStorage.getItem(k); return s? JSON.parse(s):undefined; }
  const db = await idbOpen(); if(!db){ STORAGE_MODE='ls'; return storageGet(k); }
  return new Promise((res,rej)=>{
    const tx=db.transaction('kv','readonly');
    const req=tx.objectStore('kv').get(k);
    req.onsuccess=()=>res(req.result? req.result.v:undefined);
    req.onerror=()=>rej(req.error);
  });
}

/* blocks store */
async function putBlock(b){
  const db = await idbOpen(); if(!db) return;
  return new Promise((res,rej)=>{
    const tx=db.transaction('blocks','readwrite');
    tx.objectStore('blocks').put(b);
    tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error);
  });
}
async function getBlocksAll(){
  const db = await idbOpen(); if(!db) return [];
  return new Promise((res,rej)=>{
    const tx=db.transaction('blocks','readonly');
    const req=tx.objectStore('blocks').getAll();
    req.onsuccess=()=>res(req.result||[]);
    req.onerror=()=>rej(req.error);
  });
}

/* exact palette (row-major from swatch) */
const COLORS = [
  '#F7D6D0', '#D6EEF5', '#BFD9CF', '#F7E08C',
  '#E77D7A', '#4EA1D6', '#4FA684', '#E5B21A',
  '#E3423A', '#1E6FB6', '#187245', '#D79516',
  '#7F1D2D', '#0E3B5C', '#0A3A34', '#C1730D'
];

/* Activities with mutable labels (persisted) */
let ACTIVITY_LIST = [
  {key:'work', label:'Work',       color: COLORS[8]},
  {key:'school', label:'School',   color: COLORS[9]},
  {key:'commute', label:'Commute', color: COLORS[7]},
  {key:'chores', label:'Chores',   color: COLORS[4]},
  {key:'errands', label:'Errands', color: COLORS[11]},
  {key:'meal', label:'Meal Time',  color: COLORS[3]},
  {key:'hygiene', label:'Hygiene', color: COLORS[1]},
  {key:'childcare', label:'Child Care', color: COLORS[12]},
  {key:'selfcare', label:'Self Care',   color: COLORS[6]},
  {key:'exercise', label:'Exercise',    color: COLORS[10]},
  {key:'family', label:'Family Time',   color: COLORS[15]},
  {key:'hobbies', label:'Hobbies',      color: COLORS[14]},
  {key:'projects', label:'Projects',    color: COLORS[13]},
  {key:'rr', label:'R & R',             color: COLORS[2]},
  {key:'free', label:'Free Time',       color: COLORS[0]},
  {key:'sleep', label:'Sleep',          color: COLORS[9]}
];
const ACT_STORE_KEY='activities_v1';

async function loadActivities(){
  const saved = await storageGet(ACT_STORE_KEY);
  if(saved && Array.isArray(saved)){
    // merge by key to preserve colors
    ACTIVITY_LIST = ACTIVITY_LIST.map(a=> {
      const m = saved.find(s=>s.key===a.key);
      return m ? {...a, label:m.label} : a;
    });
  }
}
async function saveActivities(){ await storageSet(ACT_STORE_KEY, ACTIVITY_LIST.map(({key,label})=>({key,label}))); }

function getActivityByKey(k){ return ACTIVITY_LIST.find(a=>a.key===k) || ACTIVITY_LIST[0]; }
function defaultFlexForActivity(key){ return (key==='work'||key==='commute'||key==='school'||key==='childcare')?'firm':'flexible'; }

/* selection chain (placeholder, preserved) */
const CHAIN_KEY='selChain_v12';
async function saveChain(c){ await storageSet(CHAIN_KEY, c||undefined); }
async function loadChain(){ return (await storageGet(CHAIN_KEY)) || null; }

let chain = null;
let weekGeom=null, overlayRoot=null;
let selectedBlock=null;     // currently focused existing block

document.querySelector('.controls').addEventListener('click', e=>{
  const b=e.target.closest('.neu-btn'); if(!b) return;
  const v=b.dataset.view;

  const wasPressed = b.classList.contains('is-pressed');
  buttons.forEach(x=>{ x.classList.remove('is-pressed'); x.setAttribute('aria-pressed','false'); });
  if(!wasPressed){ b.classList.add('is-pressed'); b.setAttribute('aria-pressed','true'); }

  if(activeView===v){
    activeView=null; buttons.forEach(x=>x.setAttribute('aria-pressed','false')); screenEl.innerHTML='';
    destroySelButtons(); destroyOverlay(); teardownGhost();
  }else{
    activeView=v; render();
  }
  saveSoon(200);
});

/* ---- Week view ---- */
function buildWeekView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head">
        <button id="prevWeekBtn" class="neu-btn--sm" aria-label="Previous week" title="Previous">
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="15,5 8,12 15,19"/></svg>
        </button>
        <div class="title" id="weekTitle"></div>
        <button id="nextWeekBtn" class="neu-btn--sm" aria-label="Next week" title="Next">
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="9,5 16,12 9,19"/></svg>
        </button>
      </div>

      <div class="grid-area">
        <div class="top-row week" id="dowPills"></div>
        <div class="grid" id="weekGrid" aria-label="Weekly grid" role="grid">
          <div class="blocksHost" id="blocksHost"></div>
          <svg class="mask" id="maskSVG" aria-hidden="true"></svg>
          <div class="selHost" id="selHost"></div>
        </div>
        <div class="hours" id="weekHours"></div>
      </div>
    </div>
  `;

  document.getElementById('prevWeekBtn').onclick = async ()=>{
    visibleWeekFirst=addDays(visibleWeekFirst,-7); repaintWeek(); await drawBlocks(); if(selectedBlock) positionBlockButtons(selectedBlock);
  };
  document.getElementById('nextWeekBtn').onclick = async ()=>{
    visibleWeekFirst=addDays(visibleWeekFirst, 7); repaintWeek(); await drawBlocks(); if(selectedBlock) positionBlockButtons(selectedBlock);
  };

  ensureOverlay();
  repaintWeek();

  new ResizeObserver(()=>{ repaintWeek(true); drawBlocks(); if(selectedBlock) focusBlock(selectedBlock); }).observe(document.getElementById('weekGrid'));
  window.addEventListener('scroll', ()=>{ if(activeView==='week' && selectedBlock) positionBlockButtons(selectedBlock); }, {passive:true});

  drawBlocks();
}

/* geometry + mask */
function computeGeometry(gridEl, cols){
  const r=gridEl.getBoundingClientRect();
  const totalW=Math.max(0, Math.round(r.width));
  const totalH=Math.max(0, Math.round(r.height));
  const colWBase=Math.floor(totalW/cols), extraW=totalW-colWBase*cols;
  const rowHBase=Math.floor(totalH/24), extraH=totalH-rowHBase*24;

  const colW=[], colX=[0]; for(let c=0;c<cols;c++){ const w=colWBase+(c<extraW?1:0); colW.push(w); colX.push(colX[c]+w); }
  const rowH=[], rowY=[0]; for(let i=0;i<24;i++){ const h=rowHBase+(i<extraH?1:0); rowH.push(h); rowY.push(rowY[i]+h); }

  const slotY=[0];
  for(let hr=0;hr<24;hr++){
    const h=rowH[hr];
    const base=Math.floor(h/4); let rem=h-base*4;
    const parts=[base,base,base,base]; for(let k=0;k<rem;k++) parts[k]+=1;
    for(let q=0;q<4;q++) slotY.push(slotY[slotY.length-1]+parts[q]);
  }
  return {totalW,totalH,colW,colX,rowH,rowY,slotY, rect:r};
}
function buildMask(geom, cols){
  const svg=document.getElementById('maskSVG'); svg.innerHTML='';
  const { totalW, totalH, colX, rowY } = geom;
  if(totalW<=0 || totalH<=0) return;
  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  svg.setAttribute('preserveAspectRatio','none');

  const NS='http://www.w3.org/2000/svg';
  const defs=document.createElementNS(NS,'defs');
  const sym=document.createElementNS(NS,'symbol');
  sym.setAttribute('id','tile900x300'); sym.setAttribute('viewBox','0 0 900 300'); sym.setAttribute('preserveAspectRatio','none');

  const surface=getComputedStyle(document.documentElement).getPropertyValue('--mask-surface')||'#e3eaf2';
  const rct=(x,y,w,h)=>{const e=document.createElementNS(NS,'rect'); e.setAttribute('x',x); e.setAttribute('y',y); e.setAttribute('width',w); e.setAttribute('height',h); e.setAttribute('fill',surface); return e;};
  const poly=(pts)=>{const e=document.createElementNS(NS,'polygon'); e.setAttribute('points',pts); e.setAttribute('fill',surface); return e;};
  sym.appendChild(rct(0,0,900,24)); sym.appendChild(rct(0,276,900,24));
  sym.appendChild(rct(0,0,24,300)); sym.appendChild(rct(876,0,24,300));
  sym.appendChild(rct(24,69,852,24)); sym.appendChild(rct(24,138,852,24)); sym.appendChild(rct(24,207,852,24));
  sym.appendChild(poly('23,23 61,23 23,61')); sym.appendChild(poly('877,23 839,23 877,61')); sym.appendChild(poly('23,277 61,277 23,239')); sym.appendChild(poly('877,277 839,277 877,239'));
  defs.appendChild(sym); svg.appendChild(defs);

  for(let rI=0;rI<24;rI++){
    for(let cI=0;cI<cols;cI++){
      const use=document.createElementNS(NS,'use');
      use.setAttribute('href','#tile900x300');
      use.setAttribute('x',colX[cI]); use.setAttribute('y',rowY[rI]);
      use.setAttribute('width',colX[cI+1]-colX[cI]);
      use.setAttribute('height',rowY[rI+1]-rowY[rI]);
      svg.appendChild(use);
    }
  }
}
function repaintWeek(skipSel=false){
  const first=visibleWeekFirst, last=addDays(first,6);
  document.getElementById('weekTitle').textContent = `${MONTH_INIT[first.getMonth()]} ${first.getDate()} – ${MONTH_INIT[last.getMonth()]} ${last.getDate()}`;

  const pills=document.getElementById('dowPills'); pills.innerHTML='';
  for(let i=0;i<7;i++){ const el=document.createElement('div'); el.className='day-pill'; el.textContent = SHORT_DOW[i]; pills.appendChild(el); }

  const gh=document.getElementById('weekHours'); gh.innerHTML='';
  const gridEl=document.getElementById('weekGrid');
  weekGeom=computeGeometry(gridEl,7);
  for(let i=0;i<24;i++){
    const s=document.createElement('div'); s.className='hour-stamp';
    s.textContent = hourToAMPM(i); // leave grid stamps as am/pm
    s.style.top=((weekGeom.rowY[i]+weekGeom.rowY[i+1])/2)+'px';
    gh.appendChild(s);
  }
  buildMask(weekGeom,7);
}

/* ---- Blocks rendering + click select ---- */
async function getInstancesForWeek(allBlocks){
  const wst = getVisibleWeekStamp();
  const instances = [];
  for(const b of allBlocks){
    if(b.recurrence==='none'){
      if(b.weekSt===wst) instances.push(b);
    }else if(b.recurrence==='weekly'){
      if(wst>=b.weekSt) instances.push({...b, weekSt:wst});
    }else if(b.recurrence==='monthly'){
      if(b.weekSt===wst) instances.push(b);
    }
  }
  return instances;
}
function boundsFromSeg(seg){
  const colLeft = weekGeom.colX[seg.dayIdx];
  const colRight= weekGeom.colX[seg.dayIdx+1];
  const colWidth= (colRight - colLeft) - (seg.dayIdx===6?1:0);
  const idx = clamp(Math.round(seg.startMin/15), 0, 96);
  const idx2= clamp(Math.round(seg.endMin/15), 0, 96);
  const topY  = weekGeom.slotY[idx];
  const botY  = weekGeom.slotY[idx2];
  const height= Math.max(1, botY - topY);
  return {offsetLeft:colLeft, colWidth, topY, botY, height};
}
async function drawBlocks(){
  const host=document.getElementById('blocksHost'); if(!host || !weekGeom) return;
  host.innerHTML='';

  const blocks = await getBlocksAll();
  const inst = await getInstancesForWeek(blocks);

  for(const seg of inst){
    const b=boundsFromSeg(seg);
    const el=document.createElement('div');
    el.className='blockRect';
    el.dataset.id = seg.id;
    el.style.left = `${b.offsetLeft}px`;
    el.style.top = `${b.topY}px`;
    el.style.width = `${b.colWidth}px`;
    el.style.height = `${b.height}px`;
    el.style.background = seg.colorHex || getActivityByKey(seg.activityKey)?.color || COLORS[8];

    el.addEventListener('click', (ev)=>{ ev.stopPropagation(); selectExistingBlock(seg); });
    host.appendChild(el);
  }

  // clicking empty grid clears selection (but NOT when a modal is open)
  document.getElementById('weekGrid').onclick = ()=>{ if(modalOpen) return; clearBlockFocus(); };
}

/* ---- Existing block selection UI ---- */
function ensureOverlay(){ if(overlayRoot && document.body.contains(overlayRoot)) return; overlayRoot=document.createElement('div'); overlayRoot.className='overlayRoot'; overlayRoot.id='overlayRoot'; document.body.appendChild(overlayRoot); }
function destroyOverlay(){ overlayRoot?.remove(); overlayRoot=null; }
function clearSelHost(){ document.getElementById('selHost')?.replaceChildren(); }

function drawFocusMarquee(seg){
  clearSelHost();
  const host=document.getElementById('selHost'); if(!host || !weekGeom) return;
  const b=boundsFromSeg(seg);
  const rectEl=document.createElement('div');
  rectEl.className='marqueeRect';
  rectEl.style.left   = `${weekGeom.colX[seg.dayIdx]}px`;
  rectEl.style.top    = `${b.topY}px`;
  rectEl.style.width  = `${b.colWidth}px`;
  rectEl.style.height = `${b.height}px`;
  host.appendChild(rectEl);

  // 24h selector stamps (top/bottom)
  const topStamp=document.createElement('div'); topStamp.className='stamp';
  const botStamp=document.createElement('div'); botStamp.className='stamp';
  topStamp.textContent = HHMM_24(seg.startMin);
  botStamp.textContent = HHMM_24(seg.endMin);
  topStamp.style.top = (b.topY - 26)+'px';
  botStamp.style.top = (b.botY + 4)+'px';
  topStamp.style.left = botStamp.style.left = (weekGeom.colX[seg.dayIdx]+(b.colWidth/2))+'px';
  // stamps must be above everything; attach to overlay
  const og = document.getElementById('overlayRoot') || (ensureOverlay(), document.getElementById('overlayRoot'));
  og.appendChild(topStamp); og.appendChild(botStamp);

  // keep references to clear later
  drawFocusMarquee._stamps && drawFocusMarquee._stamps.forEach(n=>n.remove());
  drawFocusMarquee._stamps = [topStamp, botStamp];
}
function clearFocusStamps(){ if(drawFocusMarquee._stamps){ drawFocusMarquee._stamps.forEach(n=>n.remove()); drawFocusMarquee._stamps=null; } }

function selectExistingBlock(seg){
  selectedBlock = {...seg}; // copy for editing/dragging
  drawFocusMarquee(seg);
  showBlockButtons(seg);
}
function clearBlockFocus(){
  selectedBlock=null; destroySelButtons(); clearSelHost(); clearFocusStamps(); teardownGhost(); mode='none';
}

/* ---- Block buttons (drag/copy/settings/close) ---- */
function buttonEl(iconPath, label){
  const b=document.createElement('button'); b.className='neu-btn--sm'; b.title=label;
  b.innerHTML=`<svg viewBox="0 0 24 24" aria-hidden="true"><path d="${iconPath}" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  return b;
}
function showBlockButtons(seg){
  destroySelButtons();
  const wrap=document.createElement('div'); wrap.className='selBtns'; wrap.id='blockBtns';
  // drag (four arrows)
  const dragBtn = buttonEl("M12 2v6M12 16v6M2 12h6M16 12h6M7 7l5-5 5 5M7 17l5 5 5-5M7 7l-5 5 5 5M17 7l5 5-5 5","Move");
  // copy
  const copyBtn = buttonEl("M9 9h9v9H9z M6 6h9v9H6z","Copy");
  // settings (gear)
  const gearBtn = buttonEl("M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm0-5v3M12 17.5v3M4.9 4.9l2.1 2.1M17 17l2.1 2.1M2 12h3M19 12h3M4.9 19.1 7 17M17 7l2.1-2.1","Settings");
  // close (X)
  const closeBtn = buttonEl("M6 6l12 12M18 6L6 18","Close");

  wrap.appendChild(dragBtn); wrap.appendChild(copyBtn); wrap.appendChild(gearBtn); wrap.appendChild(closeBtn);
  document.body.appendChild(wrap);

  dragBtn.onclick = (e)=>{ e.stopPropagation(); toggleDrag(seg, dragBtn); };
  copyBtn.onclick = (e)=>{ e.stopPropagation(); toggleCopy(seg, copyBtn); };
  gearBtn.onclick = (e)=>{ e.stopPropagation(); openSettingsForBlock(seg, /*reopenGuard*/false); };
  closeBtn.onclick = (e)=>{ e.stopPropagation(); clearBlockFocus(); };

  positionBlockButtons(seg);
}
function destroySelButtons(){ document.getElementById('blockBtns')?.remove(); if(placeBtn){ placeBtn.remove(); placeBtn=null; } }
function positionBlockButtons(seg){
  const b=boundsFromSeg(seg);
  const margin=8, btnW=44, totalH=(44*4)+8*3;
  let left = weekGeom.rect.left + weekGeom.colX[seg.dayIdx] + b.colWidth + margin;
  if(left + btnW > window.innerWidth - margin){
    left = Math.max(margin, weekGeom.rect.left + weekGeom.colX[seg.dayIdx] - margin - btnW);
  }
  let top = weekGeom.rect.top + b.topY + (b.height/2) - (totalH/2);
  top = Math.max(margin, Math.min(window.innerHeight - margin - totalH, top));
  const wrap=document.getElementById('blockBtns'); if(wrap){ wrap.style.left=`${Math.round(left)}px`; wrap.style.top=`${Math.round(top)}px`; }
}

/* ---- Collision helpers (hard walls) ---- */
function segmentsOverlap(a,b){
  if(a.dayIdx!==b.dayIdx) return false;
  return !(a.endMin<=b.startMin || b.endMin<=a.startMin);
}
async function isPlacementValid(seg, ignoreId){
  const blocks = await getBlocksAll();
  const inst = await getInstancesForWeek(blocks);
  for(const other of inst){
    if(other.id===ignoreId) continue;
    if(segmentsOverlap(seg, other)) return false;
  }
  // within bounds
  if(seg.startMin<0 || seg.endMin>1440 || seg.startMin>=seg.endMin) return false;
  return true;
}

/* ---- Ghost + Place mechanics ---- */
function ensurePlaceButton(){
  if(placeBtn) return placeBtn;
  placeBtn=document.createElement('button');
  placeBtn.className='neu-btn--sm placeBtn';
  placeBtn.innerHTML = `<svg viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg>`;
  document.body.appendChild(placeBtn);
  return placeBtn;
}
function positionPlaceButton(b){
  const margin=8;
  const x = weekGeom.rect.left + weekGeom.colX[b.dayIdx] + b.colWidth - 52;
  const y = weekGeom.rect.top + b.botY + margin;
  placeBtn.style.left = Math.max(8, Math.min(window.innerWidth-52, x))+'px';
  placeBtn.style.top  = Math.max(8, Math.min(window.innerHeight-52, y))+'px';
}

function createGhost(){ teardownGhost(); ghostEl=document.createElement('div'); ghostEl.className='ghost red'; document.body.appendChild(ghostEl); return ghostEl; }
function teardownGhost(){ ghostEl?.remove(); ghostEl=null; placeBtn?.style.setProperty('display','none'); }

/* ---- Drag existing block (toggle) ---- */
function toggleDrag(seg, btn){
  if(mode==='drag'){ mode='none'; btn.classList.remove('is-pressed'); teardownGhost(); return; }
  mode='drag'; btn.classList.add('is-pressed');
  // ensure copy not active
  const copyBtn=document.querySelector('#blockBtns button:nth-child(2)');
  copyBtn?.classList.remove('is-pressed');

  // build ghost
  const g=createGhost();
  const onMove=async (e)=>{
    if(mode!=='drag' || !weekGeom) return;
    const x = clamp(e.clientX - weekGeom.rect.left, 0, weekGeom.totalW-1);
    const y = clamp(e.clientY - weekGeom.rect.top, 0, weekGeom.totalH-1);
    let dayIdx=0; for(let i=0;i<7;i++){ if(x>=weekGeom.colX[i] && x<weekGeom.colX[i+1]){ dayIdx=i; break; } }
    const mins = snap15((y/weekGeom.totalH)*1440);
    const dur = seg.endMin - seg.startMin;
    const startMin = clamp(mins, 0, 1440 - dur);
    const temp={...seg, dayIdx, startMin, endMin:startMin+dur};
    const b=boundsFromSeg(temp);
    Object.assign(g.style, {left:(weekGeom.rect.left+b.offsetLeft)+'px', top:(weekGeom.rect.top+b.topY)+'px', width:b.colWidth+'px', height:b.height+'px'});

    const ok = await isPlacementValid(temp, seg.id);
    g.classList.toggle('green', ok); g.classList.toggle('red', !ok);

    const pb = ensurePlaceButton();
    if(ok){ pb.style.display='block'; positionPlaceButton({...b, dayIdx}); pb.onclick=async(ev)=>{ ev.stopPropagation(); if(mode!=='drag') return; await putBlock(temp); await drawBlocks(); selectExistingBlock(temp); mode='none'; teardownGhost(); btn.classList.remove('is-pressed'); }; }
    else { pb.style.display='none'; }
  };
  const onUp=()=>{ if(mode==='drag'){ /* stay active until Place or toggle off */ } };
  window.addEventListener('pointermove', onMove, {passive:true});
  window.addEventListener('pointerup', onUp, {passive:true});
}

/* ---- Copy existing block (toggle) ---- */
function toggleCopy(seg, btn){
  if(mode==='copy'){ mode='none'; btn.classList.remove('is-pressed'); teardownGhost(); return; }
  mode='copy'; btn.classList.add('is-pressed');
  // ensure drag not active
  const dragBtn=document.querySelector('#blockBtns button:nth-child(1)');
  dragBtn?.classList.remove('is-pressed');

  const g=createGhost();
  const onMove=async (e)=>{
    if(mode!=='copy' || !weekGeom) return;
    const x = clamp(e.clientX - weekGeom.rect.left, 0, weekGeom.totalW-1);
    const y = clamp(e.clientY - weekGeom.rect.top, 0, weekGeom.totalH-1);
    let dayIdx=0; for(let i=0;i<7;i++){ if(x>=weekGeom.colX[i] && x<weekGeom.colX[i+1]){ dayIdx=i; break; } }
    const mins = snap15((y/weekGeom.totalH)*1440);
    const dur = seg.endMin - seg.startMin;
    const startMin = clamp(mins, 0, 1440 - dur);
    const temp={...seg, id:'b'+(Date.now()), dayIdx, startMin, endMin:startMin+dur}; // clone candidate
    const b=boundsFromSeg(temp);
    Object.assign(g.style, {left:(weekGeom.rect.left+b.offsetLeft)+'px', top:(weekGeom.rect.top+b.topY)+'px', width:b.colWidth+'px', height:b.height+'px'});

    const ok = await isPlacementValid(temp, /*ignoreId*/null);
    g.classList.toggle('green', ok); g.classList.toggle('red', !ok);

    const pb = ensurePlaceButton();
    if(ok){ pb.style.display='block'; positionPlaceButton({...b, dayIdx}); pb.onclick=async(ev)=>{ ev.stopPropagation(); if(mode!=='copy') return; await putBlock(temp); await drawBlocks(); selectExistingBlock(temp); mode='none'; teardownGhost(); btn.classList.remove('is-pressed'); }; }
    else { pb.style.display='none'; }
  };
  const onUp=()=>{ if(mode==='copy'){ /* remain until Place or toggle off */ } };
  window.addEventListener('pointermove', onMove, {passive:true});
  window.addEventListener('pointerup', onUp, {passive:true});
}

/* ---- Open settings for existing block ---- */
function openSettingsForBlock(seg, reopenGuard){
  modalOpen = true;

  const veil = document.createElement('div'); veil.className='veil';
  const modal = document.createElement('div'); modal.className='modal';

  const baseSeg = seg;

  const startDay = new Date(baseSeg.weekSt + baseSeg.dayIdx*DAY_MS);
  const startDow = SHORT_DOW[startDay.getDay()];

  // compute weekly total for activity (current visible week)
  const act = getActivityByKey(seg.activityKey);
  let weeklyTotalText = '—';
  computeWeeklyTotalMinutes(seg.activityKey).then(min=>{
    weeklyTotalText = fmtHM(min);
    const wtEl = modal.querySelector?.('#weeklyTotal');
    if(wtEl) wtEl.textContent = weeklyTotalText;
  });

  modal.innerHTML = `
    <div class="head">Settings</div>
    <div class="settings-wrap" id="settingsWrap">
      <div class="neu-field" id="assignField">
        <!-- NEW header row (dot + name on left, weekly total + pencil on right). Taps: header opens menu; pencil = rename -->
        <div class="row" id="assignHeader" style="justify-content:space-between; align-items:center;">
          <div class="row" id="assignHeaderLeft" style="gap:10px; align-items:center; cursor:pointer;">
            <span class="menu-dot" id="assignDot" style="background:${seg.colorHex || act.color};"></span>
            <strong id="assignName">${seg.activityName || act.label}</strong>
          </div>
          <div class="row" style="gap:10px; align-items:center;">
            <span id="weeklyTotal" style="font-weight:800;">—</span>
            <button class="btn icon" id="pencilBtn" title="Rename"><svg viewBox="0 0 24 24"><path d="M4 20h4l10-10-4-4L4 16v4zM14 6l4 4"/></svg></button>
          </div>
        </div>

        <div class="neu-select" id="assignSelect" role="button" aria-expanded="false" style="display:none">
          <span class="ph" id="assignLabel">Assign Activity</span>
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="6,9 12,15 18,9"/></svg>
        </div>
        <div class="neu-menu" id="assignMenu">
          <div class="menu-card" id="assignList"></div>
        </div>

        <input class="note-input" id="noteInput" maxlength="80" placeholder="Add a note (e.g., Walk the dog, Bank run)" value="${(seg.note||'').replace(/"/g,'&quot;')}" />
      </div>

      <div class="neu-field">
        <div class="time-row">
          <div class="time-pair"><span class="time-day" id="fromDay">${startDow}</span><button class="time-btn" id="fromBtn" type="button">${HHMM_ampm(seg.startMin)}</button></div>
          <div class="time-pair"><span class="time-day" id="toDay">${startDow}</span><button class="time-btn" id="toBtn"   type="button">${HHMM_ampm(seg.endMin)}</button></div>
        </div>
        <input id="fromPicker" type="time" step="900" style="position:absolute;opacity:0;width:0;height:0;border:0;padding:0" />
        <input id="toPicker"   type="time" step="900" style="position:absolute;opacity:0;width:0;height:0;border:0;padding:0" />
      </div>

      <div class="neu-field">
        <div class="row4">
          <div class="neu-select" id="recurringSel"><span>${seg.recurrence==='weekly'?'Reoccurring':seg.recurrence==='none'?'This week':'This month'}</span><svg viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg></div>
          <div class="neu-menu" id="recurringMenu"><div class="menu-card">
            <div class="menu-item" data-val="reoccurring">Reoccurring</div>
            <div class="menu-item" data-val="week">This week</div>
            <div class="menu-item" data-val="month">This month</div>
          </div></div>

          <div class="neu-select" id="flexSel"><span>${seg.flexibility==='firm'?'Firm':'Flexible'}</span><svg viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg></div>
          <div class="neu-menu" id="flexMenu"><div class="menu-card">
            <div class="menu-item" data-val="flexible">Flexible</div>
            <div class="menu-item" data-val="firm">Firm</div>
          </div></div>

          <div class="neu-select" id="notifSel"><span>${(seg.notifications||'reoccurring')[0].toUpperCase() + (seg.notifications||'reoccurring').slice(1)}</span><svg viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg></div>
          <div class="neu-menu" id="notifMenu"><div class="menu-card">
            <div class="menu-item" data-val="reoccurring">Reoccurring</div>
            <div class="menu-item" data-val="week">This week</div>
            <div class="menu-item" data-val="month">This month</div>
            <div class="menu-item" data-val="off">Off</div>
          </div></div>

          <div class="neu-select" id="privacySel"><span>${seg.privacy==='visible'?'Visible to connected accounts':'Private'}</span><svg viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg></div>
          <div class="neu-menu" id="privacyMenu"><div class="menu-card">
            <div class="menu-item" data-val="private">Private</div>
            <div class="menu-item" data-val="visible">Visible to connected accounts</div>
          </div></div>
        </div>
      </div>

      <div class="row"><button class="btn" id="statsBtn">Statistics</button></div>
    </div>

    <div class="foot">
      <button class="btn" id="exitBtn">Exit</button>
      <button class="btn ok" id="saveBtn">Save</button>
    </div>
  `;
  document.body.appendChild(veil); document.body.appendChild(modal);

  // Close guards
  const closeModal = ()=>{ modalOpen=false; veil.remove(); modal.remove(); };
  veil.addEventListener('click', (e)=>{ e.stopPropagation(); confirmExit(closeModal); });

  // Activity list with exact hex colors
  const listEl = modal.querySelector('#assignList');
  ACTIVITY_LIST.forEach(a=>{
    const row = document.createElement('div'); row.className='menu-item'; row.dataset.key=a.key;
    const dot = document.createElement('span'); dot.className='menu-dot'; dot.style.background = a.color; // exact
    const label = document.createElement('span'); label.textContent = a.label;
    row.appendChild(dot); row.appendChild(label);
    row.addEventListener('click', async ()=>{
      seg.activityKey = a.key;
      seg.colorHex = a.color;
      seg.activityName = a.label;
      modal.querySelector('#assignDot').style.background = a.color;
      modal.querySelector('#assignName').textContent = a.label;
      modal.querySelector('#assignMenu').classList.remove('open');
      await computeWeeklyTotalMinutes(a.key).then(min=> modal.querySelector('#weeklyTotal').textContent = fmtHM(min));
    });
    listEl.appendChild(row);
  });

  // Header interactions
  modal.querySelector('#assignHeaderLeft').addEventListener('click', ()=>{
    modal.querySelector('#assignMenu').classList.toggle('open');
  });
  modal.querySelector('#pencilBtn').addEventListener('click', async ()=>{
    const cur = modal.querySelector('#assignName').textContent;
    const next = prompt('Rename activity (max 14 chars):', cur)?.slice(0,14);
    if(next && next.trim()){
      const key = seg.activityKey;
      const idx = ACTIVITY_LIST.findIndex(a=>a.key===key);
      if(idx>=0){ ACTIVITY_LIST[idx] = {...ACTIVITY_LIST[idx], label: next.trim()}; await saveActivities(); }
      seg.activityName = next.trim();
      modal.querySelector('#assignName').textContent = next.trim();
      await drawBlocks(); // labels not drawn on blocks, but keep consistent
    }
  });

  // dropdowns
  hookMenu(modal, '#recurringSel','#recurringMenu', (v,l)=>{ seg.recurrence = (v==='reoccurring'?'weekly':v==='week'?'none':'monthly'); modal.querySelector('#recurringSel span').textContent=l; });
  hookMenu(modal, '#flexSel','#flexMenu', (v,l)=>{ seg.flexibility=v; modal.querySelector('#flexSel span').textContent=l; });
  hookMenu(modal, '#notifSel','#notifMenu', (v,l)=>{ seg.notifications=v; modal.querySelector('#notifSel span').textContent=l; });
  hookMenu(modal, '#privacySel','#privacyMenu', (v,l)=>{ seg.privacy=v; modal.querySelector('#privacySel span').textContent=l; });

  // time pickers (keep AM/PM labels in buttons; pickers 24h input step=900)
  const fromBtn = modal.querySelector('#fromBtn');
  const toBtn   = modal.querySelector('#toBtn');
  const fromPk  = modal.querySelector('#fromPicker');
  const toPk    = modal.querySelector('#toPicker');
  function setPickerValue(input, minutes){ const h=Math.floor(minutes/60), m=minutes%60; input.value=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
  setPickerValue(fromPk, seg.startMin); setPickerValue(toPk, seg.endMin);
  fromBtn.onclick=(ev)=>{ ev.stopPropagation(); fromPk.showPicker?.(); };
  toBtn.onclick  =(ev)=>{ ev.stopPropagation(); toPk.showPicker?.(); };
  fromPk.onchange=()=>{ const [h,m]=fromPk.value.split(':').map(Number); const mins=snap15(h*60+m); if(seg.endMin<=mins) seg.endMin=clamp(mins+15,0,1440); seg.startMin=mins; fromBtn.textContent=HHMM_ampm(seg.startMin); toBtn.textContent=HHMM_ampm(seg.endMin); drawFocusMarquee(seg); };
  toPk.onchange  =()=>{ const [h,m]=toPk.value.split(':').map(Number); let mins=snap15(h*60+m); if(mins<=seg.startMin) mins=clamp(seg.startMin+15,0,1440); seg.endMin=mins; toBtn.textContent=HHMM_ampm(seg.endMin); drawFocusMarquee(seg); };

  // stats
  modal.querySelector('#statsBtn').onclick=async()=>{ await openStatsModal(seg.activityName || getActivityByKey(seg.activityKey).label); };

  // exit/save
  modal.querySelector('#exitBtn').onclick=(e)=>{ e.stopPropagation(); confirmExit(closeModal); };
  modal.querySelector('#saveBtn').onclick=async(e)=>{
    e.stopPropagation();
    if(!(seg.endMin>seg.startMin)){ alert('End time must be after start time.'); return; }
    seg.note = modal.querySelector('#noteInput').value.trim();

    await putBlock(seg);
    await drawBlocks();
    // Reopen Settings immediately with UPDATED labels (fix stale label bug)
    closeModal();
    setTimeout(()=> openSettingsForBlock(seg, /*reopenGuard*/true), 0);
  };
}

function hookMenu(root, selSel, menuSel, onPick){
  const trigger = root.querySelector(selSel);
  const menu = root.querySelector(menuSel);
  trigger?.addEventListener('click', (e)=>{ e.stopPropagation(); const open = menu.classList.toggle('open'); trigger.setAttribute('aria-expanded', open?'true':'false'); });
  menu.querySelectorAll('.menu-item').forEach(mi=> mi.addEventListener('click', (e)=>{ e.stopPropagation(); onPick(mi.dataset.val, mi.textContent.trim()); menu.classList.remove('open'); trigger?.setAttribute('aria-expanded','false'); }));
}

function confirmExit(done){
  modalConfirm('Are you sure you want to exit without saving?').then(ok=>{ if(ok) done(); });
}
function modalConfirm(text){
  return new Promise((resolve)=>{
    const veil=document.createElement('div'); veil.className='veil';
    const modal=document.createElement('div'); modal.className='modal';
    modal.innerHTML=`<div class="head">${text}</div><div class="settings-wrap" style="padding:16px"></div><div class="foot"><button class="btn" data-a="no">Cancel</button><button class="btn ok" data-a="yes">OK</button></div>`;
    modalOpen = true;
    document.body.appendChild(veil); document.body.appendChild(modal);
    const close=(val)=>{ modalOpen=false; veil.remove(); modal.remove(); resolve(val); };
    modal.addEventListener('click', e=>{ const b=e.target.closest('button'); if(!b) return; e.stopPropagation(); b.dataset.a==='yes'? close(true):close(false); });
    veil.addEventListener('click', (e)=>{ e.stopPropagation(); close(false); });
  });
}

/* Stats modal (minimal) */
async function openStatsModal(activityName){
  const veil=document.createElement('div'); veil.className='veil';
  const modal=document.createElement('div'); modal.className='modal';
  modal.innerHTML = `
    <div class="head">Statistics — ${activityName}</div>
    <div class="settings-wrap" id="statsWrap">
      <div class="stat-line"><span>Average hours / week</span><span id="avgW">—</span></div>
      <div class="stat-line"><span>Average hours / month</span><span id="avgM">—</span></div>
      <div class="stat-line"><span>Average hours / year</span><span id="avgY">—</span></div>
      <div class="stat-line"><span>Completion</span><span id="pct" class="pct">—</span></div>
    </div>
    <div class="foot"><button class="btn ok" id="closeStats">Close</button></div>
  `;
  modalOpen = true;
  document.body.appendChild(veil); document.body.appendChild(modal);

  const s = await computeActivityStats(activityName);
  modal.querySelector('#avgW').textContent = s.avgWeek.toFixed(2);
  modal.querySelector('#avgM').textContent = s.avgMonth.toFixed(2);
  modal.querySelector('#avgY').textContent = s.avgYear.toFixed(2);
  const pctEl = modal.querySelector('#pct'); const p = Math.round(s.completionPct||100);
  pctEl.textContent = `${p}%`; pctEl.classList.add(p>=75?'green':p>=50?'yellow':p>=25?'orange':'red');

  modal.querySelector('#closeStats').onclick=(e)=>{ e.stopPropagation(); modalOpen=false; veil.remove(); modal.remove(); };
  veil.addEventListener('click', (e)=>{ e.stopPropagation(); modalOpen=false; veil.remove(); modal.remove(); });
}
async function computeActivityStats(activityName){ return {avgWeek:0, avgMonth:0, avgYear:0, completionPct:100}; }

/* Weekly total minutes for current week by activity key */
async function computeWeeklyTotalMinutes(actKey){
  const blocks = await getBlocksAll();
  const inst = await getInstancesForWeek(blocks);
  let sum=0;
  for(const b of inst){ if(b.activityKey===actKey) sum += Math.max(0, b.endMin - b.startMin); }
  return sum;
}
function fmtHM(min){ const h=Math.floor(min/60), m=min%60; return `${h}h ${String(m).padStart(2,'0')}m`; }

/* init */
async function init(){
  try{
    await loadActivities();
    const snap = await storageGet('state');
    if(snap){ activeView = snap.activeView ?? null; activeDayISO = snap.activeDayISO || activeDayISO; if(typeof snap.visibleWeekFirst==='number') visibleWeekFirst = new Date(snap.visibleWeekFirst); if(activeView){ const btn = document.querySelector(`.neu-btn[data-view="${activeView}"]`); btn?.classList.add('is-pressed'); btn?.setAttribute('aria-pressed','true'); } }
  }catch{}
  render();
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden'){ saveAll().catch(()=>{}); } });
  window.addEventListener('beforeunload', ()=>{ saveAll().catch(()=>{}); });
}
function render(){
  if(activeView==='week'){ buildWeekView(); }
  else if(activeView==='day'){ screenEl.innerHTML=`<div class="wrap"><div class="head"><div></div><div class="title">Day</div><div></div></div><div class="grid-area" style="display:grid;place-items:center;color:#666"><div class="watermark">Chrono r73</div></div></div>`; destroyOverlay(); }
  else if(activeView==='month'){ buildMonthView(); }
  else { screenEl.innerHTML=''; destroyOverlay(); }
}

function saveSoon(ms=300){ clearTimeout(saveSoon._t); saveSoon._t=setTimeout(()=>{ saveAll().catch(()=>{}); }, ms); }
async function saveAll(){ await storageSet('state', { activeView, activeDayISO, visibleWeekFirst:+visibleWeekFirst }); await saveChain(chain); }

/* Month view (minimal for completeness) */
function buildMonthView(){
  const base = new Date(); activeDayISO = toISO(base);
  const first = new Date(base.getFullYear(), base.getMonth(), 1);
  const label = first.toLocaleDateString(undefined,{month:'long', year:'numeric'});
  screenEl.innerHTML = `
    <div class="month-wrap">
      <div class="head">
        <button id="prevMon" class="neu-btn--sm" aria-label="Prev month" title="Prev">
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="15,5 8,12 15,19"/></svg>
        </button>
        <div class="title">${label}</div>
        <button id="nextMon" class="neu-btn--sm" aria-label="Next month" title="Next">
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="9,5 16,12 9,19"/></svg>
        </button>
      </div>
      <div class="month-dow"><span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span></div>
      <div class="month-grid" id="monthGrid"></div>
    </div>`;
  const prev=document.getElementById('prevMon'), next=document.getElementById('nextMon');
  prev.onclick=()=>renderMonth(base, -1); next.onclick=()=>renderMonth(base, +1);
  renderMonth(base, 0); destroyOverlay();
}
function renderMonth(base, delta){
  const d = new Date(base.getFullYear(), base.getMonth()+delta, 1);
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const last  = new Date(d.getFullYear(), d.getMonth()+1, 0);
  document.querySelector('.head .title').textContent = first.toLocaleDateString(undefined,{month:'long',year:'numeric'});
  const g=document.getElementById('monthGrid'); g.innerHTML='';
  const firstWeekday = first.getDay(); const prevLast = new Date(d.getFullYear(), d.getMonth(), 0).getDate();
  for(let i=firstWeekday-1;i>=0;i--){ g.insertAdjacentHTML('beforeend', `<div class="mcell muted"><span class="date">${prevLast - i}</span></div>`); }
  const todayISO = toISO(new Date());
  for(let day=1; day<=last.getDate(); day++){ const iso = toISO(new Date(d.getFullYear(), d.getMonth(), day)); g.insertAdjacentHTML('beforeend', `<div class="mcell ${iso===todayISO?'today':''}"><span class="date">${day}</span></div>`); }
  const used = firstWeekday + last.getDate(); const rem = (Math.ceil(used/7)*7) - used;
  for(let i=1;i<=rem;i++){ g.insertAdjacentHTML('beforeend', `<div class="mcell muted"><span class="date">${i}</span></div>`); }
}

init();
</script>

<!-- Service worker registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.error('SW registration failed', err));
  });
}
</script>

</body>
</html>