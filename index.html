<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Betterly – R55 (Weekly • Monthly • Selector)</title>
<style>
  :root{
    /* SURFACE + TOKENS (locked) */
    --bg:#e3eaf2;
    --ink:#42586d;
    --ink-muted: color-mix(in srgb, var(--ink) 65%, transparent);
    --turq:#27e6f2;
    --navy:#355169;

    /* Neumorphic shadows */
    --off:8px; --blur:12px;
    --hi:#ffffff;       /* white highlight */
    --lo:#b3bfcd;       /* bluish-gray shadow */

    /* Layout */
    --gap:24px;         /* uniform ruler = approved left margin */
    --panel-radius:24px;

    /* Button */
    --btnD:84px;

    /* Grid */
    --hour-h:48px;      /* 60min = 48px → 15min = 12px */
    --slot-h:12px;      /* 15-min slot height */
    --dow-h:36px;

    /* Z */
    --z-grid-bg: 1;
    --z-selection-glow: 2;
    --z-selection: 3;
    --z-handles: 4;
    --z-grid-lines: 5;      /* lines above special effects */
    --z-midpoint: 6;        /* gear/X */
    --z-lens: 7;            /* present-time lens */
    --z-dialog: 20;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;}

  /* Remove UA tap/focus chrome on touch; keep keyboard focus only */
  *{-webkit-tap-highlight-color: transparent;}
  :focus{outline:none;}
  :focus-visible{outline:2px dashed var(--ink-muted); outline-offset:4px;}

  .frame{
    min-height:100%;
    padding:var(--gap);
    display:flex; flex-direction:column; gap:var(--gap);
    box-sizing:border-box;
  }

  /* Header row (week range + view toggle) */
  .header{
    display:flex; justify-content:space-between; align-items:center;
    padding-inline:2px;
  }
  .week-range{font-weight:700; letter-spacing:.2px;}

  /* Button row — exactly as approved */
  .btn-row{width:100%; display:flex; gap:var(--gap);}
  .neu-btn{
    --d: calc((100% - (3 * var(--gap))) / 4);
    flex:0 0 var(--d); width:var(--d); aspect-ratio:1/1; border:none; border-radius:50%;
    background:var(--bg); display:grid; place-items:center; cursor:pointer;
    box-shadow:
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       var(--off)         var(--off)         var(--blur) var(--lo);
    transition: box-shadow .2s ease, background .2s ease, transform .06s ease;
  }
  .neu-btn svg{width:44%;height:auto;stroke:var(--ink);stroke-width:6;fill:none;
    stroke-linecap:round;stroke-linejoin:round; filter:none; transition:stroke .2s;}
  .neu-btn.is-pressed{
    background:
      radial-gradient(circle at 82% 82%, rgba(39,230,242,.10) 0%, rgba(39,230,242,.05) 34%, rgba(39,230,242,0) 60%),
      var(--navy);
    box-shadow:
       var(--off)         var(--off)         var(--blur) var(--hi),
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--lo);
  }
  .neu-btn.is-pressed svg{stroke:var(--turq);
    filter: drop-shadow(0 0 1px rgba(39,230,242,.55)) drop-shadow(0 0 6px rgba(39,230,242,.55));}
  .neu-btn:active{transform:scale(.98)}

  /* CENTER PANEL (weekly calendar surface) */
  .panel{
    flex:1; width:100%; border-radius:var(--panel-radius); position:relative; overflow:hidden;
    background:var(--bg);
    box-shadow:
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       var(--off)         var(--off)         var(--blur) var(--lo);
    display:flex; flex-direction:column;
  }

  /* View switch container (Weekly / Monthly) inside panel */
  .tabs{display:flex; gap:12px; padding:12px var(--gap) 0 var(--gap); align-items:center;}
  .tabs button{border:none; background:transparent; color:var(--ink); font-weight:600; padding:8px 10px; border-radius:12px; cursor:pointer}
  .tabs button.is-active{background:rgba(66,88,109,.08)}

  /* WEEKLY VIEW */
  .weekly{
    position:relative; flex:1; display:flex; flex-direction:column; gap:8px; padding:8px var(--gap) var(--gap);
  }
  .dow{display:grid; grid-template-columns: 56px repeat(7, 1fr); align-items:center; height:var(--dow-h); font-size:13px; opacity:.9; }
  .dow div{ text-align:center;}
  .dow div:first-child{text-align:left;}
  .grid-wrap{
    position:relative; flex:1; overflow:auto; border-radius:16px;
    background:var(--bg);
  }

  /* background slots (under everything) */
  .grid-bg{position:relative; z-index:var(--z-grid-bg);
    display:grid; grid-template-columns: 56px repeat(7, 1fr);
    grid-auto-rows: var(--slot-h);
    min-height: calc(var(--hour-h) * 24);  /* 24 hours */
  }

  .hour-label{position:sticky; left:0; background:linear-gradient(to right, var(--bg), var(--bg)); z-index:10; padding-left:6px; font-size:12px; color:var(--ink-muted); display:flex; align-items:center;}
  .slot{border-top:1px solid rgba(0,0,0,.04);}
  .slot.hr{border-top:1px solid rgba(0,0,0,.12);} /* each hour line */

  /* separate overlay for grid lines so they stay above effects */
  .grid-lines{
    pointer-events:none; position:absolute; inset:0; z-index:var(--z-grid-lines);
    display:grid; grid-template-columns: 56px repeat(7, 1fr); grid-auto-rows: var(--slot-h);
  }
  .grid-lines .ln{border-top:1px solid rgba(0,0,0,.18);}
  .grid-lines .ln.q{border-top:1px solid rgba(0,0,0,.08);} /* quarter lines */

  /* SELECTION (white block) */
  .selection{
    position:absolute; width:calc((100% - 56px) / 7); /* width of one day column */
    background:#fff; border-radius:12px; z-index:var(--z-selection);
    box-shadow:
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       var(--off)         var(--off)         var(--blur) var(--lo);
  }
  /* Outside-only turquoise halo (no interior overlay) */
  .selection::after{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none; z-index:var(--z-selection-glow);
    box-shadow:
      0 0 12px rgba(39,230,242,.28),
      0 0 26px rgba(39,230,242,.20),
      6px 6px 16px rgba(39,230,242,.18); /* directional BR */
  }

  /* Rounded neuromorphic triangle handles (SVG) */
  .handle{
    position:absolute; left:50%; transform:translateX(-50%); width:30px; height:18px; z-index:var(--z-handles);
    display:grid; place-items:center; cursor:ns-resize; touch-action:none;
  }
  .handle svg{width:100%; height:100%; filter:
      drop-shadow(calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi))
      drop-shadow(var(--off) var(--off) var(--blur) var(--lo));}
  .handle.top{top:-14px; rotate:180deg;}
  .handle.bottom{bottom:-14px;}

  /* Midpoint gear / X (docks to right; auto-flip in JS near edge) */
  .mid-tools{position:absolute; z-index:var(--z-midpoint); display:flex; flex-direction:column; gap:var(--gap);}
  .tool-btn{
    width:44px; aspect-ratio:1/1; border:none; border-radius:50%; background:var(--bg); cursor:pointer;
    box-shadow:
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       var(--off)         var(--off)         var(--blur) var(--lo);
  }
  .tool-btn svg{width:58%; height:auto; stroke:var(--ink); stroke-width:5; fill:none; stroke-linecap:round; stroke-linejoin:round;}
  .tool-btn:active{transform:scale(.98)}
  .tool-btn.is-pressed{
    background: var(--navy);
    box-shadow:
       var(--off)         var(--off)         var(--blur) var(--hi),
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--lo);
  }
  .tool-btn.is-pressed svg{stroke:var(--turq); filter:
    drop-shadow(0 0 1px rgba(39,230,242,.55)) drop-shadow(0 0 6px rgba(39,230,242,.55));}

  /* Present-time lens (outer glow ring only; interior stays clean) */
  .present-lens{
    position:absolute; z-index:var(--z-lens); pointer-events:none;
    width:calc((100% - 56px)); left:56px; /* span all day columns */
    height:var(--hour-h); /* one hour */
    border-radius:12px; /* base */
    /* beveled 45° corners look: clip-path diamond-cut */
    clip-path:polygon(4% 0, 96% 0, 100% 8%, 100% 92%, 96% 100%, 4% 100%, 0 92%, 0 8%);
  }
  .present-lens::before{
    content:""; position:absolute; inset:-2px; border-radius:inherit; clip-path:inherit;
    box-shadow:
      0 0 0 2px rgba(39,230,242,.85),
      0 0 16px 6px rgba(39,230,242,.28),
      0 0 36px 16px rgba(39,230,242,.20);
  }

  /* MONTHLY VIEW */
  .monthly{position:relative; flex:1; display:none; padding:var(--gap); }
  .month-grid{
    width:100%; height:100%;
    display:grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(6, 1fr); gap:10px;
  }
  .day-tile{
    position:relative; display:flex; align-items:flex-start; justify-content:flex-end; padding:8px; color:var(--ink);
    background:var(--bg); border-radius:12px;
    /* Single outline with two-tone edges: TL white, BR gray — simulated via dual shadows tightly clipped */
    box-shadow:
      -1px -1px 0 0 var(--hi) inset,
       1px  1px 0 0 var(--lo) inset;
  }
  .day-tile.muted{color: color-mix(in srgb, var(--ink) 60%, transparent);}
  .day-num{font-size:12px; font-weight:700;}
  /* Today gets full raised neumorphic treatment */
  .day-tile.today{
    box-shadow:
      calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi),
       var(--off)         var(--off)         var(--blur) var(--lo);
  }

  /* SPILLOVER DIALOG */
  .dialog{
    position:fixed; inset:auto var(--gap) var(--gap) var(--gap);
    margin:auto; max-width:520px; background:var(--bg); border-radius:16px; padding:16px;
    box-shadow:
      calc(-1*var(--off)) calc(-1*var(--off)) 18px var(--hi),
       var(--off)         var(--off)         18px var(--lo);
    z-index:var(--z-dialog); display:none;
  }
  .dialog h3{margin:0 0 6px 0; font-size:16px;}
  .dialog p{margin:0 0 12px 0; font-size:14px; color:var(--ink);}
  .dialog .actions{display:flex; gap:12px; justify-content:flex-end;}
  .btn{border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;}
  .btn.primary{background:var(--navy); color:#fff;
    box-shadow: var(--off) var(--off) var(--blur) var(--hi), calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--lo);}
  .btn.secondary{background:var(--bg); color:var(--ink);
    box-shadow: calc(-1*var(--off)) calc(-1*var(--off)) var(--blur) var(--hi), var(--off) var(--off) var(--blur) var(--lo);}
</style>
</head>
<body>
  <div class="frame">
    <div class="header">
      <div class="week-range" id="weekRange">—</div>
      <div class="tabs">
        <button id="tabWeekly" class="is-active" aria-pressed="true">Weekly</button>
        <button id="tabMonthly" aria-pressed="false">Monthly</button>
      </div>
    </div>

    <div class="panel">
      <!-- TABS -->
      <div class="weekly" id="weeklyView" role="region" aria-label="Weekly calendar">
        <div class="dow" id="dow">
          <div></div>
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>

        <div class="grid-wrap" id="gridWrap">
          <!-- Background grid (labels + slots) -->
          <div class="grid-bg" id="gridBg"></div>

          <!-- Selection block + handles + midpoint tools -->
          <div class="selection" id="selection" aria-label="Selected time range">
            <!-- Handles -->
            <div class="handle top" id="handleTop" aria-label="Resize start" role="button">
              <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
                <path d="M10,55 Q50,5 90,55" fill="#fff" stroke="rgba(0,0,0,.05)" stroke-width="0"/>
              </svg>
            </div>
            <div class="handle bottom" id="handleBottom" aria-label="Resize end" role="button">
              <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
                <path d="M10,55 Q50,5 90,55" fill="#fff" stroke="rgba(0,0,0,.05)" stroke-width="0"/>
              </svg>
            </div>
          </div>

          <!-- Midpoint tools -->
          <div class="mid-tools" id="midTools" aria-hidden="false">
            <button class="tool-btn" id="btnGear" aria-label="Edit selection">
              <svg viewBox="0 0 24 24"><path d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Zm8 3.5l-1.6.3a6.7 6.7 0 0 1-.7 1.6l.9 1.3-1.7 1.7-1.3-.9a6.7 6.7 0 0 1-1.6.7L13.9 20h-3.8l-.3-1.6a6.7 6.7 0 0 1-1.6-.7l-1.3.9-1.7-1.7.9-1.3a6.7 6.7 0 0 1-.7-1.6L4 12.1V9.9l1.6-.3a6.7 6.7 0 0 1 .7-1.6l-.9-1.3L7 4.9l1.3.9c.5-.3 1.1-.5 1.6-.7L10.1 3h3.8l.3 1.6c.6.2 1.1.4 1.6.7l1.3-.9 1.7 1.7-.9 1.3c.3.5.5 1.1.7 1.6L20 9.9v2.1Z"/></svg>
            </button>
            <button class="tool-btn" id="btnDelete" aria-label="Delete selection">
              <svg viewBox="0 0 24 24"><path d="M6 7h12M10 7V5h4v2m-6 3v9m4-9v9m4-9v9"/></svg>
            </button>
          </div>

          <!-- Grid lines overlay (kept above effects) -->
          <div class="grid-lines" id="gridLines"></div>

          <!-- Present-time lens -->
          <div class="present-lens" id="presentLens" aria-hidden="true"></div>
        </div>
      </div>

      <div class="monthly" id="monthlyView" role="region" aria-label="Monthly calendar">
        <div class="month-grid" id="monthGrid"></div>
      </div>
    </div>

    <!-- Bottom control buttons (mutually exclusive press) -->
    <nav class="btn-row" aria-label="Actions">
      <button class="neu-btn" aria-pressed="false" title="Action 1">
        <svg viewBox="0 0 100 100"><path d="M22 52 L44 74 L78 28"/></svg>
      </button>
      <button class="neu-btn" aria-pressed="false" title="Action 2">
        <svg viewBox="0 0 100 100"><path d="M50 22 V78 M22 50 H78"/></svg>
      </button>
      <button class="neu-btn" aria-pressed="false" title="Action 3">
        <svg viewBox="0 0 100 100"><path d="M30 30 H70 V70 H30 Z M30 50 H70"/></svg>
      </button>
      <button class="neu-btn" aria-pressed="false" title="Action 4">
        <svg viewBox="0 0 100 100"><path d="M24 76 L50 24 L76 76 Z"/></svg>
      </button>
    </nav>
  </div>

  <!-- Spillover dialog -->
  <div class="dialog" id="spillDialog" role="dialog" aria-modal="true" aria-labelledby="spillTitle">
    <h3 id="spillTitle">Spill over to next period?</h3>
    <p id="spillText">—</p>
    <div class="actions">
      <button class="btn secondary" id="spillCancel">Cancel</button>
      <button class="btn primary" id="spillContinue">Continue</button>
    </div>
  </div>

<script>
/* ===========================================================
   UTILITIES & STATE
=========================================================== */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

const gridWrap = $('#gridWrap');
const gridBg = $('#gridBg');
const gridLines = $('#gridLines');
const selection = $('#selection');
const handleTop = $('#handleTop');
const handleBottom = $('#handleBottom');
const midTools = $('#midTools');
const btnGear = $('#btnGear'), btnDelete = $('#btnDelete');
const presentLens = $('#presentLens');
const weekRangeEl = $('#weekRange');
const tabWeekly = $('#tabWeekly'), tabMonthly = $('#tabMonthly');
const weeklyView = $('#weeklyView'), monthlyView = $('#monthlyView');
const monthGrid = $('#monthGrid');
const spillDialog = $('#spillDialog');
const spillText = $('#spillText');
const spillCancel = $('#spillCancel');
const spillContinue = $('#spillContinue');

const slotH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--slot-h')) || 12;
const hourH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hour-h')) || 48;
const dowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--dow-h')) || 36;

let weekStart = startOfWeek(new Date());    // Sunday
let currentView = 'weekly';
let selectionState = {
  dayIndex: 1,                 // default Monday column (0=Sun..6=Sat)
  startSlot: 8*4,              // 08:00 -> 32
  endSlot: 10*4,               // 10:00 -> 40
};
let drag = null;               // {mode:'move'|'resizeTop'|'resizeBot', startY, startState}
let pendingSpill = null;       // {dir:'prev'|'next', type:'day'|'week'}

function startOfWeek(d){
  const x = new Date(d); const day = x.getDay();
  x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x;
}
function fmtRangeLabel(start){
  // Visible week: Sunday..Saturday (7 days)
  const end = new Date(start); end.setDate(end.getDate()+6);
  const sameMonth = start.getMonth()===end.getMonth() && start.getFullYear()===end.getFullYear();
  const sameYear = start.getFullYear()===end.getFullYear();
  const sm = start.toLocaleString(undefined,{month:'short'});
  const em = end.toLocaleString(undefined,{month:'short'});
  if(sameMonth) return `${sm} ${start.getDate()}–${end.getDate()}, ${start.getFullYear()}`;
  if(sameYear)  return `${sm} ${start.getDate()}–${em} ${end.getDate()}, ${start.getFullYear()}`;
  return `${sm} ${start.getDate()}, ${start.getFullYear()}–${em} ${end.getDate()}, ${end.getFullYear()}`;
}
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

/* ===========================================================
   BUILD WEEKLY GRID
=========================================================== */
function buildWeekly(){
  weekRangeEl.textContent = fmtRangeLabel(weekStart);

  // Build background grid (labels + day columns)
  gridBg.innerHTML = '';
  for(let r=0;r<24*4;r++){ // 96 rows (15min)
    // hour label col
    const lab = document.createElement('div');
    lab.className = 'hour-label';
    if(r%4===0){ // each hour row
      const hr = r/4;
      lab.style.height = slotH+'px';
      lab.textContent = String(hr).padStart(2,'0')+':00';
    }else{
      lab.style.height = slotH+'px';
      lab.textContent = '';
    }
    gridBg.appendChild(lab);

    // 7 day cols
    for(let c=0;c<7;c++){
      const cell = document.createElement('div');
      cell.className = 'slot'+(r%4===0?' hr':'');
      gridBg.appendChild(cell);
    }
  }

  // Overlay lines (kept above effects)
  gridLines.innerHTML = '';
  for(let r=0;r<24*4;r++){
    const lab = document.createElement('div');
    lab.className = (r%4===0)?'ln':'ln q';
    gridLines.appendChild(lab);
    for(let c=0;c<7;c++){
      const d = document.createElement('div');
      d.className = (r%4===0)?'ln':'ln q';
      gridLines.appendChild(d);
    }
  }

  // Place selection & helpers
  layoutSelection();
  placePresentLens();
}

/* Position selection by state */
function layoutSelection(){
  const wrapRect = gridWrap.getBoundingClientRect();
  const gridRect = gridBg.getBoundingClientRect();
  const colW = (gridRect.width - 56) / 7; // subtract label col
  const left = 56 + selectionState.dayIndex * colW;
  const top = selectionState.startSlot * slotH;
  const h = (selectionState.endSlot - selectionState.startSlot) * slotH;

  selection.style.left = left + 'px';
  selection.style.top = top + 'px';
  selection.style.height = Math.max(slotH, h) + 'px';
  selection.style.width = colW + 'px';

  // Handles
  handleTop.style.left = '50%';
  handleBottom.style.left = '50%';

  // Midpoint tool positioning
  const midSlot = Math.round((selectionState.startSlot + selectionState.endSlot)/2);
  const midY = midSlot * slotH;
  const toolsXRight = left + colW + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
  const toolsXLeft  = left - parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) - 44;
  let toolsX = toolsXRight;
  const gwRect = gridWrap.getBoundingClientRect();
  if (toolsX + 44 > gwRect.left + gwRect.width) toolsX = toolsXLeft; // flip if near edge
  midTools.style.left = toolsX + 'px';
  midTools.style.top  = (midY - 22) + 'px'; // center of pair straddles midpoint
}

/* Present-time lens (highlights current hour; outer glow only) */
function placePresentLens(){
  const now = new Date();
  // vertical position = current hour start
  const hour = now.getHours();
  const y = hour * hourH;
  presentLens.style.top = y + dowH + 8 + 'px'; // account row header + weekly padding (8)
}

/* Drag logic */
function yToSlot(y){
  // convert page Y to slot index within the scrollable grid
  const r = gridBg.getBoundingClientRect();
  const scrollY = gridWrap.scrollTop;
  const yIn = y - r.top + scrollY;
  return clamp( Math.round(yIn/slotH), 0, 24*4 );
}
function startDrag(mode, ev){
  ev.preventDefault();
  const pageY = (ev.touches?.[0]?.pageY) ?? ev.pageY;
  drag = {mode, startY:pageY, startState: {...selectionState} };
}
function onDrag(ev){
  if(!drag) return;
  const pageY = (ev.touches?.[0]?.pageY) ?? ev.pageY;
  const slot = yToSlot(pageY);
  if(drag.mode==='move'){
    const dur = drag.startState.endSlot - drag.startState.startSlot;
    let newStart = slot - Math.floor(dur/2);
    let newEnd = newStart + dur;
    // spillover detection
    if(newStart < 0){ showSpill('prev','day'); return; }
    if(newEnd > 24*4){ showSpill('next','day'); return; }
    selectionState.startSlot = clamp(newStart, 0, 24*4 - dur);
    selectionState.endSlot = selectionState.startSlot + dur;
  }else if(drag.mode==='resizeTop'){
    let s = clamp(slot, 0, selectionState.endSlot - 1);
    selectionState.startSlot = s;
  }else if(drag.mode==='resizeBot'){
    let e = clamp(slot, selectionState.startSlot + 1, 24*4);
    selectionState.endSlot = e;
  }
  layoutSelection();
}
function endDrag(ev){
  drag = null;
}

/* Spillover dialog */
function showSpill(dir,type){
  pendingSpill = {dir,type};
  spillText.textContent = (dir==='next')
    ? (type==='day' ? 'Continue into next day?' : 'Continue into next week?')
    : (type==='day' ? 'Continue into previous day?' : 'Continue into previous week?');
  spillDialog.style.display = 'block';
}
spillCancel.addEventListener('click', ()=>{
  spillDialog.style.display='none'; pendingSpill=null;
});
spillContinue.addEventListener('click', ()=>{
  if(!pendingSpill){spillDialog.style.display='none';return;}
  if(pendingSpill.type==='week'){
    // update weekStart
    weekStart.setDate(weekStart.getDate() + (pendingSpill.dir==='next'?7:-7));
    buildWeekly();
  }else{
    // move selection into adjacent day
    selectionState.dayIndex = clamp(selectionState.dayIndex + (pendingSpill.dir==='next'?1:-1), 0, 6);
    if((pendingSpill.dir==='next' && selectionState.dayIndex===0) ||
       (pendingSpill.dir==='prev' && selectionState.dayIndex===6)){
      // crossed week boundary → also shift week
      weekStart.setDate(weekStart.getDate() + (pendingSpill.dir==='next'?7:-7));
      buildWeekly();
    }else{
      layoutSelection();
    }
  }
  pendingSpill=null; spillDialog.style.display='none';
});

/* Events: drag */
selection.addEventListener('pointerdown', e=>startDrag('move', e));
selection.addEventListener('touchstart', e=>startDrag('move', e), {passive:false});
handleTop.addEventListener('pointerdown', e=>startDrag('resizeTop', e));
handleBottom.addEventListener('pointerdown', e=>startDrag('resizeBot', e));
window.addEventListener('pointermove', onDrag);
window.addEventListener('pointerup', endDrag);
window.addEventListener('touchmove', onDrag, {passive:false});
window.addEventListener('touchend', endDrag);

/* Midpoint buttons follow selection (already placed in layoutSelection); actions */
btnGear.addEventListener('click', ()=>{ btnGear.classList.toggle('is-pressed'); });
btnDelete.addEventListener('click', ()=>{
  // clear selection (collapse to 1 hour at noon)
  selectionState.startSlot = 12*4; selectionState.endSlot = 13*4;
  layoutSelection();
});

/* ===========================================================
   MONTHLY GRID (42 tiles, two-tone single outline; today raised)
=========================================================== */
function buildMonthGrid(date = new Date()){
  monthGrid.innerHTML='';
  const year = date.getFullYear(), month = date.getMonth();
  const first = new Date(year,month,1);
  const start = startOfWeek(first); // Sunday before/at 1st
  const todayKey = new Date().toDateString();

  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const tile = document.createElement('div');
    tile.className = 'day-tile';
    if(d.getMonth()!==month) tile.classList.add('muted');
    if(d.toDateString()===todayKey) tile.classList.add('today');
    const num = document.createElement('div');
    num.className = 'day-num'; num.textContent = d.getDate();
    tile.appendChild(num);
    monthGrid.appendChild(tile);
  }
}

/* ===========================================================
   WEEK/MONTH TABS
=========================================================== */
function setView(v){
  currentView = v;
  if(v==='weekly'){
    tabWeekly.classList.add('is-active'); tabWeekly.setAttribute('aria-pressed','true');
    tabMonthly.classList.remove('is-active'); tabMonthly.setAttribute('aria-pressed','false');
    weeklyView.style.display='flex'; monthlyView.style.display='none';
  }else{
    tabMonthly.classList.add('is-active'); tabMonthly.setAttribute('aria-pressed','true');
    tabWeekly.classList.remove('is-active'); tabWeekly.setAttribute('aria-pressed','false');
    weeklyView.style.display='none'; monthlyView.style.display='block';
  }
}
tabWeekly.addEventListener('click', ()=>setView('weekly'));
tabMonthly.addEventListener('click', ()=>setView('monthly'));

/* ===========================================================
   MUTUALLY EXCLUSIVE BOTTOM BUTTONS
=========================================================== */
const actionBtns = $$('.neu-btn');
actionBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const already = btn.classList.contains('is-pressed');
    actionBtns.forEach(b=>{ b.classList.remove('is-pressed'); b.setAttribute('aria-pressed','false'); });
    if(!already){ btn.classList.add('is-pressed'); btn.setAttribute('aria-pressed','true'); }
  });
});

/* ===========================================================
   INIT
=========================================================== */
function init(){
  buildWeekly();
  buildMonthGrid();
  setView('weekly');

  // Place selection initially in Monday 08:00–10:00
  layoutSelection();

  // Update present lens on load and hourly tick
  placePresentLens();
  setInterval(placePresentLens, 60*1000); // keep aligned

  // Prevent blue flash on SVGs (Android)
  $$('#gridWrap svg, .neu-btn svg, .tool-btn svg').forEach(el=>{
    el.style.webkitTapHighlightColor = 'transparent';
  });
}
init();
</script>
</body>
</html>