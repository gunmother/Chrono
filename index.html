<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Minimal Scheduler</title>
<style>
  :root{
    --bg:#ffffff;
    --ink:#333;
    --border:#B8B8B8;
    --pressed:#E0E0E0;

    --gap:12px;
    --btn:60px;
    --r-lg:12px;

    --gridLine:#E1E1E1;
    --chartBg:#f3f3f3;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
  body{font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial;-webkit-tap-highlight-color:transparent}

  .app{
    height:100%;
    width:100%;
    display:grid;
    grid-template-rows: 1fr auto;
    row-gap: var(--gap);
    padding: var(--gap);
    box-sizing:border-box;
  }

  #screen{
    width:100%;
    height:100%;
    border:1px solid var(--border);
    border-radius:var(--r-lg);
    box-sizing:border-box;
    overflow:auto;
    position:relative;
    background:#fff;
  }

  .controls{
    display:flex; justify-content:space-between; align-items:center; width:100%;
  }
  .btn{
    width:var(--btn); height:var(--btn); flex:0 0 var(--btn);
    border-radius:50%; border:1px solid var(--border); background:#fff; color:var(--ink);
    display:grid; place-items:center; cursor:pointer; outline:none; padding:0; margin:0;
  }
  .btn[aria-pressed="true"]{ background:var(--pressed); }
  .btn:focus-visible{ outline:2px solid var(--ink); outline-offset:2px; }
  .icon{ width:60%; height:60%; display:block }
  .icon *{ fill:none; stroke:currentColor; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:round; vector-effect:non-scaling-stroke }

  /* ===== WEEK / DAY common ===== */
  .grid-wrap{ position:relative; min-height:420px }
  .hours{ position:absolute; top:22px; bottom:0; left:0; width:62px; pointer-events:none }
  .hour{ position:absolute; left:8px; transform:translateY(-50%); font-size:12px; color:#555; opacity:.95; white-space:nowrap }

  .dow{ position:absolute; top:0; left:62px; right:0; height:22px; display:grid; grid-template-columns:repeat(7,1fr); align-items:center; font-size:12px; pointer-events:none }
  .dow div{ text-align:center; font-weight:600 }

  .grid{
    position:absolute; top:22px; left:62px; right:0; bottom:0;
    overflow:hidden;
    background:var(--chartBg);
    border-left:1px solid var(--gridLine); border-right:1px solid var(--gridLine);
  }
  .mask{ position:absolute; inset:0; pointer-events:none; shape-rendering:crispEdges }
  .blocks{ position:absolute; inset:0 }
  .blk{ position:absolute; border:1px solid var(--border) }

  .now{ position:absolute; border:2px solid #0EA5E9; border-radius:999px; background:rgba(0,0,0,0.03); display:none; pointer-events:none }

  /* Week header */
  .week{ display:grid; grid-template-rows:auto 1fr; height:100% }
  .week-head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--gridLine) }
  .w-title{ text-align:center; font-weight:700 }
  .w-btn{ border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer }

  /* Day header */
  .day{ display:grid; grid-template-rows:auto 1fr; height:100% }
  .day-head{ padding:8px 10px; border-bottom:1px solid var(--gridLine); font-weight:700 }
  .day .grid{ left:62px; right:0 } /* single column */

  /* Month */
  .month{ display:grid; grid-template-rows:auto 1fr; height:100% }
  .month-head{ padding:8px 10px; border-bottom:1px solid var(--gridLine); font-weight:700 }
  .month-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:10px; box-sizing:border-box }
  .m-tile{ border:1px solid var(--gridLine); border-radius:8px; min-height:72px; padding:6px; font-size:12px; cursor:pointer; background:#fff }
  .m-tile.today{ outline:2px solid #bbb; outline-offset:1px }

  /* ===== Overlay: task menu ===== */
  #taskOverlay{ position:fixed; inset:0; display:none; z-index:100 }
  #taskOverlay .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.25) }
  #taskOverlay .panel{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(92vw,520px); background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;
    display:grid; gap:10px;
  }
  .taskRow{ display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--gridLine); border-radius:10px; cursor:pointer; }
  .dot{ width:14px; height:14px; border-radius:50%; border:1px solid #999 }

  /* ===== Settings editor ===== */
  #settingsOverlay{ position:fixed; inset:0; display:none; z-index:140 }
  #settingsOverlay .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.25) }
  #settingsOverlay .card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(92vw,680px); background:#fff; border:1px solid var(--border); border-radius:12px; display:grid; grid-template-rows:auto 1fr auto; max-height:min(86vh,720px)
  }
  .ed-head{ display:flex; gap:10px; align-items:center; padding:10px; border-bottom:1px solid var(--gridLine) }
  .ed-body{ padding:10px; overflow:auto; display:grid; gap:14px }
  .ed-foot{ padding:10px; border-top:1px solid var(--gridLine); display:flex; gap:10px; justify-content:flex-end }
  .ed-row{ display:grid; gap:8px }
  .in{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; font:inherit }
  .chk{ display:flex; align-items:center; gap:8px; font-size:14px }
  .dayRow{ border:1px solid var(--gridLine); border-radius:10px; padding:10px; display:grid; gap:10px }
  .slots{ display:grid; gap:8px }
  .slot{ display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center }
  .del{ border:1px solid var(--border); background:#fff; border-radius:8px; width:36px; height:36px; cursor:pointer }
  .add{ border:1px solid var(--border); background:#fff; border-radius:8px; width:36px; height:36px; cursor:pointer }
</style>
</head>
<body>
  <main class="app">
    <section id="screen" aria-live="polite" aria-label="Content area"></section>

    <nav class="controls" role="group" aria-label="Primary views">
      <button class="btn" aria-label="Day view" aria-pressed="false" data-name="day" title="Day">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/>
          <line x1="12" y1="2"  x2="12" y2="5"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="2"  y1="12" x2="5"  y2="12"/>
          <line x1="19" y1="12" x2="22" y2="12"/>
          <line x1="17" y1="7"  x2="19" y2="5"/>
          <line x1="7"  y1="17" x2="5"  y2="19"/>
          <line x1="7"  y1="7"  x2="5"  y2="5"/>
          <line x1="17" y1="17" x2="19" y2="19"/>
        </svg>
      </button>

      <button class="btn" aria-label="Week view" aria-pressed="true" data-name="week" title="Week">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <line x1="6" y1="10" x2="6" y2="18"/>
          <line x1="8" y1="10" x2="8" y2="18"/>
          <line x1="10" y1="10" x2="10" y2="18"/>
          <line x1="12" y1="10" x2="12" y2="18"/>
          <line x1="14" y1="10" x2="14" y2="18"/>
          <line x1="16" y1="10" x2="16" y2="18"/>
          <line x1="18" y1="10" x2="18" y2="18"/>
        </svg>
      </button>

      <button class="btn" aria-label="Month view" aria-pressed="false" data-name="month" title="Month">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <circle cx="7"  cy="11" r="0.7"/>
          <circle cx="11" cy="11" r="0.7"/>
          <circle cx="15" cy="11" r="0.7"/>
          <circle cx="19" cy="11" r="0.7"/>
          <circle cx="7"  cy="14" r="0.7"/>
          <circle cx="11" cy="14" r="0.7"/>
          <circle cx="15" cy="14" r="0.7"/>
          <circle cx="19" cy="14" r="0.7"/>
          <circle cx="7"  cy="17" r="0.7"/>
          <circle cx="11" cy="17" r="0.7"/>
          <circle cx="15" cy="17" r="0.7"/>
          <circle cx="19" cy="17" r="0.7"/>
        </svg>
      </button>

      <button class="btn" aria-label="To-Do list" aria-pressed="false" data-name="todo" title="To-Do">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <polyline points="7,14 10,17 17,10"/>
        </svg>
      </button>
    </nav>
  </main>

  <!-- Task Menu -->
  <div id="taskOverlay" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel" role="dialog" aria-label="Pick category" id="taskList"></div>
  </div>

  <!-- Settings Editor -->
  <div id="settingsOverlay" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="edTitle">
      <div class="ed-head">
        <strong id="edTitle">Edit</strong>
        <input id="edName" class="in" placeholder="Name (14 max)" maxlength="14" style="flex:1"/>
        <input id="edColor" type="color" class="in" style="width:54px;padding:0;height:36px"/>
        <label class="chk"><input type="checkbox" id="edHard"/> Hard time</label>
      </div>
      <div class="ed-body" id="edBody"></div>
      <div class="ed-foot">
        <button id="edCancel" class="w-btn">Cancel</button>
        <button id="edSave" class="w-btn">Save</button>
      </div>
    </div>
  </div>

<script>
/* ===== helpers/state ===== */
const screenEl = document.getElementById('screen');
const buttons = Array.from(document.querySelectorAll('.btn'));
let activeView = 'week';
let activeDayISO = toISO(new Date());
let visibleWeekFirst = weekStart(new Date());

function toISO(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function fromISO(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function weekStart(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const SHORT_DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const SLOTS_PER_DAY=96; // 15-min
let allSlots = Array.from({length:7}, ()=>Array(SLOTS_PER_DAY).fill(null)); // computed paint buffer

// Categories (no placeholders; user will create/edit)
let TASKS = [
  {key:'work', label:'Work', color:'#e06a6a', hard:false},
  {key:'commute', label:'Commute', color:'#f1a652', hard:false},
  {key:'chores', label:'Chores', color:'#7aa2ff', hard:false},
  {key:'exercise', label:'Exercise', color:'#6bd68b', hard:false},
  {key:'sleep', label:'Sleep', color:'#9db8ff', hard:false},
  {key:'family', label:'Family', color:'#e971a3', hard:false},
  {key:'free', label:'Free', color:'#d0d0d0', hard:false},
  {key:'study', label:'Study', color:'#6fc7d9', hard:false},
];

// User schedule (recurring weekly template only here)
const EXACT = Object.fromEntries(TASKS.map(t=>[t.key, Array.from({length:7},()=>[])]));
const ORDER = { recurring:{} }; let SAVE_SEQ=1; // first-writer-wins

/* ===== view switching ===== */
document.querySelector('.controls').addEventListener('click', e=>{
  const b=e.target.closest('.btn'); if(!b) return;
  activeView = b.dataset.name;
  buttons.forEach(x=>x.setAttribute('aria-pressed', String(x===b)));
  render();
});

/* ===== WEEK ===== */
function buildWeekView(){
  screenEl.innerHTML = `
    <div class="week">
      <div class="week-head">
        <button class="w-btn" id="prevWeekBtn">Prev</button>
        <div class="w-title" id="weekTitle"></div>
        <button class="w-btn" id="nextWeekBtn">Next</button>
      </div>
      <div class="grid-wrap">
        <div class="dow" id="dowLabels"></div>
        <div class="grid" id="weekGrid">
          <div class="blocks" id="blocksLayer"></div>
          <svg class="mask" id="maskSVG" aria-hidden="true"></svg>
          <div class="now" id="nowMagnify" aria-hidden="true"></div>
        </div>
        <div class="hours" id="weekHours"></div>
      </div>
    </div>
  `;

  document.getElementById('prevWeekBtn').onclick=()=>{ visibleWeekFirst=addDays(visibleWeekFirst,-7); repaintWeek(); };
  document.getElementById('nextWeekBtn').onclick=()=>{ visibleWeekFirst=addDays(visibleWeekFirst, 7); repaintWeek(); };

  // Tap to open task menu
  document.getElementById('weekGrid').addEventListener('click', showTaskMenu);

  requestAnimationFrame(()=>repaintWeek());
  new ResizeObserver(()=>repaintWeek()).observe(document.getElementById('weekGrid'));
}

function repaintWeek(){
  const first=visibleWeekFirst, last=addDays(first,6);
  const m=new Intl.DateTimeFormat(undefined,{month:'short'});
  const title = (first.getFullYear()===last.getFullYear())
    ? (first.getMonth()===last.getMonth()
        ? `${m.format(first)} ${first.getDate()} ‚Äì ${last.getDate()}, ${first.getFullYear()}`
        : `${m.format(first)} ${first.getDate()} ‚Äì ${m.format(last)} ${last.getDate()}, ${first.getFullYear()}`)
    : `${m.format(first)} ${first.getDate()}, ${first.getFullYear()} ‚Äì ${m.format(last)} ${last.getDate()}, ${last.getFullYear()}`;
  document.getElementById('weekTitle').textContent = title;

  const dl=document.getElementById('dowLabels'); dl.innerHTML='';
  SHORT_DOW.forEach(d=>{ const div=document.createElement('div'); div.textContent=d; dl.appendChild(div); });

  const gh=document.getElementById('weekHours'); gh.innerHTML='';
  const geom=computeGeometry(document.getElementById('weekGrid'), 7);
  for(let i=0;i<24;i++){
    const d=document.createElement('div'); d.className='hour';
    d.textContent = `${String(i).padStart(2,'0')}:00`;
    d.style.top=((geom.rowY[i]+geom.rowY[i+1])/2)+'px';
    gh.appendChild(d);
  }

  rebuildSlots();
  paintBlocks(geom, 7);
  buildMask(geom, 7);
  paintNowMagnifier(geom);
}

function computeGeometry(gridEl, cols){
  const r=gridEl.getBoundingClientRect();
  const totalW=Math.max(0, Math.round(r.width));
  const totalH=Math.max(0, Math.round(r.height));
  const colWBase=Math.floor(totalW/cols), extraW=totalW-colWBase*cols;
  const rowHBase=Math.floor(totalH/24), extraH=totalH-rowHBase*24;
  const colW=[], colX=[0]; for(let c=0;c<cols;c++){ const w=colWBase+(c<extraW?1:0); colW.push(w); colX.push(colX[c]+w); }
  const rowH=[], rowY=[0]; for(let i=0;i<24;i++){ const h=rowHBase+(i<extraH?1:0); rowH.push(h); rowY.push(rowY[i]+h); }
  const slotY=[0];
  for(let hr=0;hr<24;hr++){
    const h=rowH[hr]; const base=Math.floor(h/4); let rem=h-base*4;
    const parts=[base,base,base,base]; for(let k=0;k<rem;k++) parts[k]+=1;
    for(let q=0;q<4;q++) slotY.push(slotY[slotY.length-1]+parts[q]);
  }
  return {totalW,totalH,colW,colX,rowH,rowY,slotY};
}

function buildMask(geom, cols){
  const svg=document.getElementById('maskSVG'); svg.innerHTML='';
  const { totalW, totalH, colX, rowY } = geom;
  if(totalW<=0 || totalH<=0) return;
  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  svg.setAttribute('preserveAspectRatio','none');

  const NS='http://www.w3.org/2000/svg';
  const defs=document.createElementNS(NS,'defs');
  const sym=document.createElementNS(NS,'symbol');
  sym.setAttribute('id','tile900x300');
  sym.setAttribute('viewBox','0 0 900 300');
  sym.setAttribute('preserveAspectRatio','none');

  const surface='rgba(255,255,255,0.55)';
  const r=(x,y,w,h)=>{const e=document.createElementNS(NS,'rect'); e.setAttribute('x',x); e.setAttribute('y',y); e.setAttribute('width',w); e.setAttribute('height',h); e.setAttribute('fill',surface); return e;};
  const p=(pts)=>{const e=document.createElementNS(NS,'polygon'); e.setAttribute('points',pts); e.setAttribute('fill',surface); return e;};

  sym.appendChild(r(0,0,900,24));   // top
  sym.appendChild(r(0,276,900,24)); // bottom
  sym.appendChild(r(0,0,24,300));   // left
  sym.appendChild(r(876,0,24,300)); // right
  sym.appendChild(r(24,69,852,24));
  sym.appendChild(r(24,138,852,24));
  sym.appendChild(r(24,207,852,24));
  sym.appendChild(p('23,23 61,23 23,61'));
  sym.appendChild(p('877,23 839,23 877,61'));
  sym.appendChild(p('23,277 61,277 23,239'));
  sym.appendChild(p('877,277 839,277 877,239'));

  defs.appendChild(sym); svg.appendChild(defs);

  for(let rI=0;rI<24;rI++){
    for(let cI=0;cI<cols;cI++){
      const use=document.createElementNS(NS,'use');
      use.setAttribute('href','#tile900x300');
      use.setAttribute('x',colX[cI]);
      use.setAttribute('y',rowY[rI]);
      use.setAttribute('width',colX[cI+1]-colX[cI]);
      use.setAttribute('height',rowY[rI+1]-rowY[rI]);
      svg.appendChild(use);
    }
  }
}

function rebuildSlots(){
  // clear
  allSlots = Array.from({length:7}, ()=>Array(SLOTS_PER_DAY).fill(null));
  // first-writer-wins by ORDER.recurring
  const seqFor = key => ORDER.recurring[key] ?? 1e9;
  const keys = Object.keys(EXACT).sort((a,b)=>seqFor(a)-seqFor(b));
  for(const key of keys){
    const week=EXACT[key];
    for(let d=0; d<7; d++){
      for(const r of week[d]){
        let a=Math.round(r.startMin/15), b=Math.round(r.endMin/15);
        if(b>a){
          for(let s=a; s<b; s++) if(allSlots[d][s]==null) allSlots[d][s]=key;
        } else if(b<a){
          for(let s=a; s<96; s++) if(allSlots[d][s]==null) allSlots[d][s]=key;
          const dn=(d+1)%7; for(let s=0; s<b; s++) if(allSlots[dn][s]==null) allSlots[dn][s]=key;
        }
      }
    }
  }
}

function paintBlocks(geom, cols){
  const layer=document.getElementById('blocksLayer'); layer.innerHTML='';
  const {colX, slotY} = geom;
  for(let d=0; d<7; d++){
    let s=0;
    while(s<SLOTS_PER_DAY){
      const key=allSlots[d][s];
      if(!key){ s++; continue; }
      let e=s+1; while(e<SLOTS_PER_DAY && allSlots[d][e]===key) e++;
      const left=colX[d], right=colX[d+1];
      const top=slotY[s], bottom=slotY[e];
      const div=document.createElement('div'); div.className='blk';
      div.style.left=left+'px';
      div.style.top=top+'px';
      div.style.width=Math.max(0,(d===6?right-left-1:right-left))+'px';
      div.style.height=(bottom-top)+'px';
      div.style.background = colorOf(key);
      div.title = labelOf(key);
      layer.appendChild(div);
      s=e;
    }
  }
}

function paintNowMagnifier(geom){
  const nowEl=document.getElementById('nowMagnify');
  const today=new Date(); const visStart=visibleWeekFirst; const visEnd=addDays(visStart,6);
  if(+startOfDay(today) < +startOfDay(visStart) || +startOfDay(today) > +startOfDay(visEnd)){
    nowEl.style.display='none'; return;
  }
  const {colX,rowY} = geom;
  const dow=today.getDay(); const mins=today.getHours()*60 + today.getMinutes();
  const hour=Math.floor(mins/60);
  const hourTop=rowY[hour]; const hourH=rowY[hour+1]-rowY[hour];
  const extra=Math.min(10, Math.floor(hourH*0.25));
  const top=Math.max(0, hourTop - Math.floor(extra/2));
  const height=Math.max(2, hourH + extra);
  nowEl.style.left=colX[dow]+'px';
  nowEl.style.top=top+'px';
  nowEl.style.width=(colX[dow+1]-colX[dow] - (dow===6?1:0))+'px';
  nowEl.style.height=height+'px';
  nowEl.style.display='block';
}

/* ===== DAY ===== */
function buildDayView(){
  const d = fromISO(activeDayISO);
  screenEl.innerHTML = `
    <div class="day">
      <div class="day-head" id="dayHead"></div>
      <div class="grid-wrap">
        <div class="grid" id="dayGrid">
          <div class="blocks" id="dayBlocks"></div>
          <svg class="mask" id="dayMask" aria-hidden="true"></svg>
        </div>
        <div class="hours" id="dayHours"></div>
      </div>
    </div>
  `;
  document.getElementById('dayHead').textContent =
    d.toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'});

  document.getElementById('dayGrid').addEventListener('click', showTaskMenu);

  requestAnimationFrame(()=>repaintDay());
  new ResizeObserver(()=>repaintDay()).observe(document.getElementById('dayGrid'));
}

function repaintDay(){
  // Ensure slots correspond to day‚Äôs week
  const d=fromISO(activeDayISO); const ws=weekStart(d);
  if(toISO(ws)!==toISO(visibleWeekFirst)){ visibleWeekFirst=ws; rebuildSlots(); }

  const gh=document.getElementById('dayHours'); gh.innerHTML='';
  const grid=document.getElementById('dayGrid');
  const geom=computeGeometry(grid, 1);

  for(let i=0;i<24;i++){
    const el=document.createElement('div'); el.className='hour';
    el.textContent = `${String(i).padStart(2,'0')}:00`;
    el.style.top=((geom.rowY[i]+geom.rowY[i+1])/2)+'px';
    gh.appendChild(el);
  }

  // same mask, but single column
  buildMask(geom, 1);

  // paint single-column blocks for selected day
  const layer=document.getElementById('dayBlocks'); layer.innerHTML='';
  const dow=fromISO(activeDayISO).getDay();
  let s=0; while(s<SLOTS_PER_DAY){
    const key=allSlots[dow][s];
    if(!key){ s++; continue; }
    let e=s+1; while(e<SLOTS_PER_DAY && allSlots[dow][e]===key) e++;
    const left=0, right=geom.colX[1];
    const top=geom.slotY[s], bottom=geom.slotY[e];
    const div=document.createElement('div'); div.className='blk';
    div.style.left=left+'px';
    div.style.top=top+'px';
    div.style.width=(right-left-1)+'px';
    div.style.height=(bottom-top)+'px';
    div.style.background = colorOf(key);
    div.title = labelOf(key);
    layer.appendChild(div);
    s=e;
  }
}

/* ===== MONTH ===== */
function buildMonthView(){
  const d = fromISO(activeDayISO);
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const last  = new Date(d.getFullYear(), d.getMonth()+1, 0);
  const label = first.toLocaleDateString(undefined,{month:'long', year:'numeric'});

  const firstWeekday = first.getDay();
  screenEl.innerHTML = `
    <div class="month">
      <div class="month-head">${label}</div>
      <div class="month-grid" id="monthGrid"></div>
    </div>
  `;
  const grid=document.getElementById('monthGrid');
  for(let i=0;i<firstWeekday;i++) grid.appendChild(document.createElement('div'));
  for(let day=1; day<=last.getDate(); day++){
    const tile=document.createElement('div'); tile.className='m-tile'; tile.textContent=day;
    const iso = toISO(new Date(d.getFullYear(), d.getMonth(), day));
    if(iso===toISO(new Date())) tile.classList.add('today');
    tile.addEventListener('click', ()=>{ activeDayISO = iso; });
    grid.appendChild(tile);
  }
}

/* ===== Task menu overlay ===== */
const overlay=document.getElementById('taskOverlay');
const listEl=document.getElementById('taskList');
let currentTaskKey=null;

function showTaskMenu(){
  listEl.innerHTML='';
  TASKS.forEach(t=>{
    const row=document.createElement('div'); row.className='taskRow'; row.dataset.key=t.key;
    row.innerHTML = `<span class="dot" style="background:${t.color}"></span> <strong>${t.label}</strong>`;
    row.addEventListener('click', ()=>{ currentTaskKey=t.key; openEditor(t); });
    listEl.appendChild(row);
  });
  overlay.style.display='block';
}
overlay.querySelector('.backdrop').addEventListener('click', ()=>overlay.style.display='none');

/* ===== Settings editor (recurring week; 6 ranges max/day; hard/soft) ===== */
const edOverlay=document.getElementById('settingsOverlay');
const edBody=document.getElementById('edBody');
const edTitle=document.getElementById('edTitle');
const edName=document.getElementById('edName');
const edColor=document.getElementById('edColor');
const edHard=document.getElementById('edHard');

function openEditor(task){
  overlay.style.display='none';
  edTitle.textContent = `Edit: ${task.label}`;
  edName.value = task.label;
  edColor.value = toHex(task.color);
  edHard.checked = !!task.hard;

  // build day rows
  edBody.innerHTML='';
  for(let d=0; d<7; d++){
    const wrap=document.createElement('div'); wrap.className='dayRow'; wrap.dataset.day=d;
    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${DAY_NAMES[d]}</strong>
        <button class="add" title="Add range">+</button>
      </div>
      <div class="slots"></div>
    `;
    const slots=wrap.querySelector('.slots');
    const addBtn=wrap.querySelector('.add');
    addBtn.addEventListener('click', ()=>addSlot(slots));

    // load existing ranges
    (EXACT[task.key]?.[d]||[]).forEach(r=>addSlot(slots, r.startMin, r.endMin));
    edBody.appendChild(wrap);
  }
  edOverlay.style.display='block';
}

function addSlot(slotsEl, startMin=7*60, endMin=22*60){
  if(slotsEl.children.length>=6) return;
  const row=document.createElement('div'); row.className='slot';
  row.innerHTML = `
    <input type="time" class="in" step="900" value="${toHHMM(startMin)}">
    <input type="time" class="in" step="900" value="${toHHMM(endMin)}">
    <button class="del" title="Delete">üóëÔ∏è</button>
  `;
  row.querySelector('.del').addEventListener('click', ()=>row.remove());
  slotsEl.appendChild(row);
}

document.getElementById('edCancel').addEventListener('click', ()=>{ edOverlay.style.display='none'; });
document.getElementById('edSave').addEventListener('click', ()=>{
  const key=currentTaskKey;
  // update task meta
  const t = TASKS.find(x=>x.key===key);
  t.label = (edName.value||'').slice(0,14) || t.label;
  t.color = edColor.value;
  t.hard = !!edHard.checked;

  // collect ranges
  const week = Array.from({length:7},()=>[]);
  edBody.querySelectorAll('.dayRow').forEach((wrap,d)=>{
    const rows=[...wrap.querySelectorAll('.slot')];
    rows.slice(0,6).forEach(row=>{
      const [a,b]=row.querySelectorAll('input');
      const s=toMin(a.value), e=toMin(b.value);
      if(s===e) return;
      if(e>s){ week[d].push({startMin:round15(s), endMin:round15(e)}); }
      else { // overnight
        week[d].push({startMin:round15(s), endMin:round15(24*60)});
        const dn=(d+1)%7; week[dn].push({startMin:0, endMin:round15(e)});
      }
    });
    // merge & cap 6
    week[d].sort((A,B)=>A.startMin-B.startMin);
    const merged=[]; for(const r of week[d]){ if(!merged.length){ merged.push(r); } else { const L=merged[merged.length-1]; if(r.startMin<=L.endMin){ L.endMin=Math.max(L.endMin,r.endMin);} else merged.push(r);} }
    week[d]=merged.slice(0,6);
  });

  // persist
  EXACT[key] = week;
  ORDER.recurring[key] = ORDER.recurring[key] || (SAVE_SEQ++);

  // repaint current view
  if(activeView==='week') repaintWeek();
  if(activeView==='day') repaintDay();

  edOverlay.style.display='none';
});

/* ===== utilities for editor ===== */
function toHex(c){ // accepts hex or rgb()
  const s=String(c).trim();
  if(/^#([0-9a-f]{6})$/i.test(s)) return s;
  const m=s.match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i); if(m){
    const r=+m[1],g=+m[2],b=+m[3];
    return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  }
  return '#999999';
}
function toHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function toMin(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
function round15(min){ return Math.round(min/15)*15; }
function colorOf(key){ const t=TASKS.find(x=>x.key===key); return t ? t.color : '#ddd'; }
function labelOf(key){ const t=TASKS.find(x=>x.key===key); return t ? t.label : key; }

/* ===== root render ===== */
function render(){
  if(activeView==='week') buildWeekView();
  else if(activeView==='day') buildDayView();
  else if(activeView==='month') buildMonthView();
  else screenEl.innerHTML='';
}
render();

/* quick weekday selection from header ‚Üí set activeDayISO (useful before switching to Day) */
screenEl.addEventListener('click', (e)=>{
  if(activeView!=='week') return;
  const labels = screenEl.querySelector('#dowLabels');
  if(!labels) return;
  const idx = [...labels.children].indexOf(e.target);
  if(idx>=0){ activeDayISO = toISO(addDays(visibleWeekFirst, idx)); }
});
</script>
</body>
</html>