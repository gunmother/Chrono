<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Minimal Scheduler</title>
<style>
  :root{
    --r-lg:12px; --r-pill:999px;
    --border:#bdbdbd; --grid-line:#e1e1e1;
    --ink:#222; --bg:#fff; --chart-bg:#f3f3f3;

    --hour-col:56px;
    --dow-h:32px;
    --label-size:12px;
    --btn:60px;

    --panelW:520px;   /* will be synced to center screen width */
    --slot-gap:8px;
    --icon-btn:36px;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
  *{box-sizing:border-box}

  .app{
    width:clamp(320px, 96vw, 520px);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(16px, env(safe-area-inset-bottom)));
    margin: max(16px, env(safe-area-inset-top)) auto;
    display:grid; grid-template-rows: 1fr auto; gap:12px; padding:0 12px;
  }

  /* Center screen */
  #screen{
    border:1px solid var(--border);
    border-radius:var(--r-lg);
    background:#fff;
    position:relative; overflow:hidden; min-height:420px;
  }

  /* Four buttons */
  .controls{ display:flex; justify-content:space-between; align-items:center; }
  .btn{
    width:var(--btn); height:var(--btn); border-radius:50%;
    border:1px solid var(--border); background:#fff; color:#000;
    display:grid; place-items:center; cursor:pointer; padding:0;
  }
  .btn[aria-pressed="true"]{ background:#e6e6e6; }

  .icon{ width:60%; height:60% }
  .icon *{ fill:none; stroke:currentColor; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; vector-effect:non-scaling-stroke }

  /* Shared scaffold */
  .wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; min-width:0 }
  .head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--grid-line) }
  .title{ text-align:center; font-weight:800; font-size:16px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

  .grid-area{ position:relative; overflow:hidden }
  .hours{ position:absolute; top:var(--dow-h); bottom:0; left:0; width:var(--hour-col); pointer-events:none }
  .hour-stamp{ position:absolute; left:8px; transform:translateY(-50%); font-size:var(--label-size); color:#444; opacity:.95; white-space:nowrap }

  .top-row{ position:absolute; top:0; left:var(--hour-col); right:0; height:var(--dow-h); display:grid; align-items:center; min-width:0 }
  .top-row.week{ grid-template-columns:repeat(7,1fr); column-gap:6px; padding:0 0; }
  .top-row.day{ grid-template-columns:1fr; padding:0 4px; }

  /* Unboxed weekday labels centered above their columns */
  .day-pill{
    justify-self:center;
    /* removed border/background to drop the "box" */
    border:none; border-radius:0; padding:0 2px;
    text-align:center; font-size:clamp(10px, 1.9vw, 12px);
    background:transparent; color:#000; white-space:nowrap;
  }

  .grid{
    position:absolute; top:var(--dow-h); left:var(--hour-col); right:0; bottom:0;
    background:var(--chart-bg);
    border-left:1px solid var(--grid-line); border-right:1px solid var(--grid-line);
  }
  .blocks{ position:absolute; inset:0 }
  .blk{ position:absolute; border:1px solid var(--border) }
  .mask{ position:absolute; inset:0; pointer-events:none; shape-rendering:crispEdges }
  .now{ position:absolute; border:2px solid #0EA5E9; border-radius:999px; background:rgba(0,0,0,.03); display:none; pointer-events:none }

  /* Week chevrons */
  .chev{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900; min-width:44px }
  .chev:disabled{ opacity:.5; cursor:not-allowed }

  /* Month view */
  .month-wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr }
  .month-grid{ height:100%; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; gap:6px; padding:10px; }
  .mcell{ border:1px solid var(--grid-line); border-radius:8px; padding:6px; font-size:12px; background:#fff; display:flex; align-items:flex-start; justify-content:flex-start }
  .mcell.today{ outline:2px solid #bdbdbd; outline-offset:1px }
  .mcell.muted{ color:#9c9c9c }

  /* Task overlay ‚Äì single vertical stack (no white card) */
  #taskOverlay{ position:fixed; inset:0; display:none; z-index:60 }
  #taskOverlay .stack{
    position:absolute; left:50%; top:calc(8px + 40px); transform:translateX(-50%);  /* sit under title bar */
    width:min(96vw, var(--panelW)); max-height:min(86vh, 680px);
    display:grid; grid-auto-rows:minmax(34px, 1fr); grid-template-columns:1fr; gap:8px; padding:8px;
    pointer-events:auto; overflow:auto;
  }
  .taskRow{
    border:1px solid var(--border); border-radius:12px; background:#ffffff;  /* fully opaque */
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:8px 10px; cursor:pointer;
    min-height:34px;
  }
  .taskRow .dot{ width:14px; height:14px; border-radius:50%; border:1px solid #777 }
  .taskRow .name{ font-weight:800; overflow:hidden; white-space:nowrap; text-overflow:ellipsis }
  .taskRow .dur{ font-variant-numeric:tabular-nums; }

  /* Dim background when task list open */
  #taskOverlay::before{
    content:""; position:absolute; inset:0; background:rgba(0,0,0,.25);
  }

  /* Settings editor (aligned, constrained to screen width) */
  #settingsOverlay{ position:fixed; inset:0; display:none; z-index:80 }
  #settingsOverlay .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.25) }
  .card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(96vw, var(--panelW)); max-height:min(92vh, 760px);
    background:#fff; border:1px solid var(--border); border-radius:14px;
    display:grid; grid-template-rows:auto 1fr auto; overflow:hidden;
  }
  .ed-head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:10px; border-bottom:1px solid var(--grid-line) }
  .ed-title{ font-weight:900; white-space:nowrap }
  .in{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; font:inherit; width:100% }
  .ed-body{ padding:10px; overflow:auto; display:grid; gap:10px; min-width:0 }
  .dayRow{ border:1px solid var(--grid-line); border-radius:10px; padding:10px; display:grid; gap:10px; min-width:0 }
  .dayHead{ display:flex; justify-content:space-between; align-items:center; background:#fff;
    border:1px solid var(--border); border-radius:10px; padding:6px 10px; font-weight:800 }
  .slots{ display:grid; gap:12px; min-width:0 }
  .slot{
    display:grid; gap: var(--slot-gap);
    grid-template-columns: 1fr 1fr var(--icon-btn) var(--icon-btn);
    grid-template-areas:
      "start end mic del"
      "scope scope remind remind";
    align-items:center; width:100%;
  }
  .slot .start{ grid-area:start }
  .slot .end{ grid-area:end }
  .slot .mic{ grid-area:mic }
  .slot .trash{ grid-area:del }
  .slot .scope{ grid-area:scope }
  .slot .remind{ grid-area:remind }
  .select{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font:inherit; width:100% }
  .iconBtn{ width:var(--icon-btn); height:var(--icon-btn); display:grid; place-items:center; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer; line-height:1 }
  .addRow{ display:flex; }
  .addBtn{ border:1px solid var(--border); border-radius:8px; background:#fff; padding:8px 10px; cursor:pointer; font-weight:700 }

  .ed-foot{ padding:10px; border-top:1px solid var(--grid-line); display:flex; gap:10px; justify-content:space-between }
  .btnText{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; min-width:96px; text-align:center }
</style>
</head>
<body>
  <main class="app">
    <!-- Center screen: starts blank -->
    <section id="screen" aria-live="polite" aria-label="Content area"></section>

    <!-- Four round buttons -->
    <nav class="controls" role="group" aria-label="Primary views">
      <button class="btn" aria-label="Day view" aria-pressed="false" data-view="day" title="Day">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/>
          <line x1="12" y1="2"  x2="12" y2="5"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="2"  y1="12" x2="5"  y2="12"/>
          <line x1="19" y1="12" x2="22" y2="12"/>
          <line x1="17" y1="7"  x2="19" y2="5"/>
          <line x1="7"  y1="17" x2="5"  y2="19"/>
          <line x1="7"  y1="7"  x2="5"  y2="5"/>
          <line x1="17" y1="17" x2="19" y2="19"/>
        </svg>
      </button>

      <button class="btn" aria-label="Week view" aria-pressed="false" data-view="week" title="Week">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y1="8"/>
          <line x1="6" y1="10" x2="6" y2="18"/>
          <line x1="8" y1="10" x2="8" y2="18"/>
          <line x1="10" y1="10" x2="10" y2="18"/>
          <line x1="12" y1="10" x2="12" y2="18"/>
          <line x1="14" y1="10" x2="14" y2="18"/>
          <line x1="16" y1="10" x2="16" y2="18"/>
          <line x1="18" y1="10" x2="18" y2="18"/>
        </svg>
      </button>

      <button class="btn" aria-label="Month view" aria-pressed="false" data-view="month" title="Month">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <circle cx="7"  cy="11" r="0.7"/><circle cx="11" cy="11" r="0.7"/><circle cx="15" cy="11" r="0.7"/><circle cx="19" cy="11" r="0.7"/>
          <circle cx="7"  cy="14" r="0.7"/><circle cx="11" cy="14" r="0.7"/><circle cx="15" cy="14" r="0.7"/><circle cx="19" cy="14" r="0.7"/>
          <circle cx="7"  cy="17" r="0.7"/><circle cx="11" cy="17" r="0.7"/><circle cx="15" cy="17" r="0.7"/><circle cx="19" cy="17" r="0.7"/>
        </svg>
      </button>

      <button class="btn" aria-label="To-Do list" aria-pressed="false" data-view="todo" title="To-Do">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <polyline points="7,14 10,17 17,10"/>
        </svg>
      </button>
    </nav>
  </main>

  <!-- Task picker (opaque items; screen dimmed via ::before) -->
  <div id="taskOverlay" aria-hidden="true"></div>

  <!-- Settings editor -->
  <div id="settingsOverlay" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="edTitle">
      <div class="ed-head">
        <div class="ed-title" id="edTitle">Edit</div>
        <input id="edName" class="in" placeholder="Name (14 max)" maxlength="14"/>
        <input id="edColor" type="color" class="in" style="width:54px;padding:0;height:36px"/>
        <!-- Removed "Hard time" control per latest design; keeping layout intact -->
      </div>
      <div class="ed-body" id="edBody"></div>
      <div class="ed-foot">
        <button id="edCancel" class="btnText">Cancel</button>
        <button id="edSave" class="btnText">Save</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers / State ---------- */
const screenEl = document.getElementById('screen');
const buttons = [...document.querySelectorAll('.btn')];

let activeView = null;               // starts blank
let activeDayISO = toISO(new Date());
let visibleWeekFirst = weekStart(new Date());

const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const SHORT_DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const ORD = (n)=>{ const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); };

function toISO(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function fromISO(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function weekStart(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function round15(min){ return Math.round(min/15)*15; }

/* Categories (16 items) */
let TASKS = [
  {key:'work',      label:'Work',        color:'#d33c36', hard:false},
  {key:'commute',   label:'Commute',     color:'#e86a13', hard:false},
  {key:'chores',    label:'Chores',      color:'#3b41c5', hard:false},
  {key:'errands',   label:'Errands',     color:'#1d8f2e', hard:false},
  {key:'meals',     label:'Meal Time',   color:'#e0b21b', hard:false},
  {key:'hygiene',   label:'Hygiene',     color:'#0ea5e9', hard:false},
  {key:'selfcare',  label:'Self Care',   color:'#888888', hard:false},
  {key:'exercise',  label:'Exercise',    color:'#1db954', hard:false},
  {key:'family',    label:'Family Time', color:'#e3326b', hard:false},
  {key:'hobbies',   label:'Hobbies',     color:'#f39c12', hard:false},
  {key:'projects',  label:'Projects',    color:'#6a5acd', hard:false},
  {key:'school',    label:'School',      color:'#3269e6', hard:true},
  {key:'relax',     label:'Relaxation',  color:'#24c3d6', hard:false},
  {key:'free',      label:'Free Time',   color:'#a4a4a4', hard:false},
  {key:'childcare', label:'Child Care',  color:'#7a5c2e', hard:false},
  {key:'sleep',     label:'Sleep',       color:'#6aa6ff', hard:false}
];
const COLORS = ()=>Object.fromEntries(TASKS.map(t=>[t.key,t.color]));
const LABELS = ()=>Object.fromEntries(TASKS.map(t=>[t.key,t.label]));

/* Data stores */
const SLOTS_PER_DAY=96; // 15-min
let allSlots = Array.from({length:7}, ()=>Array(SLOTS_PER_DAY).fill(null));
const EXACT = Object.fromEntries(TASKS.map(t=>[t.key, Array.from({length:7},()=>[])]));
const ORDER = { recurring:{} }; let SAVE_SEQ = 1;

/* Sync editor width to screen */
function syncPanelWidthVar(){
  const w = screenEl.getBoundingClientRect().width;
  document.documentElement.style.setProperty('--panelW', Math.max(320, Math.floor(w))+'px');
}
new ResizeObserver(syncPanelWidthVar).observe(screenEl);
syncPanelWidthVar();

/* ---------- PERSISTENCE (IndexedDB) ---------- */
const DB_NAME = 'chronoDB';
const DB_VERSION = 1;
let dbPromise = null;

function idbOpen(){
  if (dbPromise) return dbPromise;
  dbPromise = new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if (!db.objectStoreNames.contains('kv')){
        db.createObjectStore('kv', { keyPath: 'k' });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
  return dbPromise;
}

async function idbSet(key, value){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction('kv','readwrite');
    tx.objectStore('kv').put({k:key, v:value});
    tx.oncomplete = ()=>resolve(true);
    tx.onerror = ()=>reject(tx.error);
  });
}

async function idbGet(key){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction('kv','readonly');
    const req = tx.objectStore('kv').get(key);
    req.onsuccess = ()=>resolve(req.result? req.result.v : undefined);
    req.onerror = ()=>reject(req.error);
  });
}

/* Serialize current state to plain JSON-friendly object */
function snapshotState(){
  return {
    TASKS,
    EXACT,
    ORDER,
    SAVE_SEQ,
    activeDayISO,
    visibleWeekFirstISO: toISO(visibleWeekFirst)
  };
}

/* Apply loaded state safely */
function hydrateState(snap){
  try{
    if(!snap || typeof snap!=='object') return;
    if (Array.isArray(snap.TASKS)) TASKS = snap.TASKS.map(t=>({
      key:String(t.key), label:String(t.label), color:String(t.color), hard:!!t.hard
    }));
    if (snap.EXACT){
      for (const k of Object.keys(EXACT)){
        if (snap.EXACT[k] && Array.isArray(snap.EXACT[k]) && snap.EXACT[k].length===7){
          EXACT[k] = snap.EXACT[k].map(dayArr => Array.isArray(dayArr) ? dayArr.map(r => ({
            startMin: Number(r.startMin)||0,
            endMin: Number(r.endMin)||0
          })) : []);
        }
      }
    }
    if (snap.ORDER && typeof snap.ORDER==='object') Object.assign(ORDER, snap.ORDER);
    if (typeof snap.SAVE_SEQ === 'number') SAVE_SEQ = snap.SAVE_SEQ;
    if (typeof snap.activeDayISO === 'string') activeDayISO = snap.activeDayISO;
    if (typeof snap.visibleWeekFirstISO === 'string') visibleWeekFirst = weekStart(fromISO(snap.visibleWeekFirstISO));
  }catch(e){
    console.warn('Hydrate failed:', e);
  }
}

/* Save immediately (used after edits) */
async function saveAll(){
  try{
    await idbSet('state', snapshotState());
  }catch(e){
    console.warn('Save failed:', e);
  }
}

/* Debounced safeguard save (e.g., on view/nav) */
let saveTimer=null;
function saveSoon(ms=800){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveAll, ms);
}

/* ---------- Button toggles ---------- */
document.querySelector('.controls').addEventListener('click', e=>{
  const b=e.target.closest('.btn'); if(!b) return;
  const v=b.dataset.view;
  if(activeView===v){
    activeView=null; buttons.forEach(x=>x.setAttribute('aria-pressed','false')); screenEl.innerHTML='';
  }else{
    activeView=v; buttons.forEach(x=>x.setAttribute('aria-pressed', String(x===b))); render();
  }
  saveSoon();
});

/* ---------- Week View ---------- */
function buildWeekView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head">
        <button id="prevWeekBtn" class="chev" aria-label="Previous week">‚óÄ</button>
        <div class="title" id="weekTitle"></div>
        <button id="nextWeekBtn" class="chev" aria-label="Next week">‚ñ∂</button>
      </div>

      <div class="grid-area">
        <div class="top-row week" id="dowPills"></div>
        <div class="grid" id="weekGrid">
          <div class="blocks" id="blocksLayer"></div>
          <svg class="mask" id="maskSVG" aria-hidden="true"></svg>
          <div class="now" id="nowMagnify" aria-hidden="true"></div>
        </div>
        <div class="hours" id="weekHours"></div>
      </div>
    </div>
  `;
  document.getElementById('prevWeekBtn').onclick = ()=>{ visibleWeekFirst=addDays(visibleWeekFirst,-7); repaintWeek(); saveSoon(300); };
  document.getElementById('nextWeekBtn').onclick = ()=>{ visibleWeekFirst=addDays(visibleWeekFirst, 7); repaintWeek(); saveSoon(300); };
  document.getElementById('weekGrid').addEventListener('click', openTaskStack);

  repaintWeek();
  new ResizeObserver(repaintWeek).observe(document.getElementById('weekGrid'));
}

function repaintWeek(){
  const first=visibleWeekFirst, last=addDays(first,6);
  const m=new Intl.DateTimeFormat(undefined,{month:'short'});
  const title = (first.getFullYear()===last.getFullYear())
    ? (first.getMonth()===last.getMonth()
        ? `${m.format(first)} ${first.getDate()} ‚Äì ${last.getDate()}, ${first.getFullYear()}`
        : `${m.format(first)} ${first.getDate()} ‚Äì ${m.format(last)} ${last.getDate()}, ${first.getFullYear()}`)
    : `${m.format(first)} ${first.getDate()}, ${first.getFullYear()} ‚Äì ${m.format(last)} ${last.getDate()}, ${last.getFullYear()}`;
  document.getElementById('weekTitle').textContent = title;

  const pills=document.getElementById('dowPills'); pills.innerHTML='';
  for(let i=0;i<7;i++){
    const d=addDays(first,i);
    const pill=document.createElement('div');
    pill.className='day-pill';
    pill.textContent = `${SHORT_DOW[i]}, ${d.getDate()}`;
    pills.appendChild(pill);
  }

  const gh=document.getElementById('weekHours'); gh.innerHTML='';
  const geom=computeGeometry(document.getElementById('weekGrid'), 7);
  for(let i=0;i<24;i++){
    const el=document.createElement('div'); el.className='hour-stamp';
    el.textContent = `${String(i).padStart(2,'0')}:00`;
    el.style.top=((geom.rowY[i]+geom.rowY[i+1])/2)+'px';
    gh.appendChild(el);
  }

  rebuildSlots();
  paintBlocksWeek(geom);
  buildMask(geom, 7);
  paintNowMagnifier(geom);
}

function computeGeometry(gridEl, cols){
  const r=gridEl.getBoundingClientRect();
  const totalW=Math.max(0, Math.round(r.width));
  const totalH=Math.max(0, Math.round(r.height));
  const colWBase=Math.floor(totalW/cols), extraW=totalW-colWBase*cols;
  const rowHBase=Math.floor(totalH/24), extraH=totalH-rowHBase*24;
  const colW=[], colX=[0]; for(let c=0;c<cols;c++){ const w=colWBase+(c<extraW?1:0); colW.push(w); colX.push(colX[c]+w); }
  const rowH=[], rowY=[0]; for(let i=0;i<24;i++){ const h=rowHBase+(i<extraH?1:0); rowH.push(h); rowY.push(rowY[i]+h); }
  const slotY=[0];
  for(let hr=0;hr<24;hr++){
    const h=rowH[hr]; const base=Math.floor(h/4); let rem=h-base*4;
    const parts=[base,base,base,base]; for(let k=0;k<rem;k++) parts[k]+=1;
    for(let q=0;q<4;q++) slotY.push(slotY[slotY.length-1]+parts[q]);
  }
  return {totalW,totalH,colW,colX,rowH,rowY,slotY};
}

function buildMask(geom, cols){
  const svg=document.getElementById(activeView==='day'?'dayMask':'maskSVG'); svg.innerHTML='';
  const { totalW, totalH, colX, rowY } = geom;
  if(totalW<=0 || totalH<=0) return;
  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  svg.setAttribute('preserveAspectRatio','none');

  const NS='http://www.w3.org/2000/svg';
  const defs=document.createElementNS(NS,'defs');
  const sym=document.createElementNS(NS,'symbol');
  sym.setAttribute('id','tile900x300');
  sym.setAttribute('viewBox','0 0 900 300');
  sym.setAttribute('preserveAspectRatio','none');

  const surface='rgba(255,255,255,0.55)';
  const r=(x,y,w,h)=>{const e=document.createElementNS(NS,'rect'); e.setAttribute('x',x); e.setAttribute('y',y); e.setAttribute('width',w); e.setAttribute('height',h); e.setAttribute('fill',surface); return e;};
  const p=(pts)=>{const e=document.createElementNS(NS,'polygon'); e.setAttribute('points',pts); e.setAttribute('fill',surface); return e;};

  sym.appendChild(r(0,0,900,24)); sym.appendChild(r(0,276,900,24));
  sym.appendChild(r(0,0,24,300)); sym.appendChild(r(876,0,24,300));
  sym.appendChild(r(24,69,852,24)); sym.appendChild(r(24,138,852,24)); sym.appendChild(r(24,207,852,24));
  sym.appendChild(p('23,23 61,23 23,61')); sym.appendChild(p('877,23 839,23 877,61')); sym.appendChild(p('23,277 61,277 23,239')); sym.appendChild(p('877,277 839,277 877,239'));

  defs.appendChild(sym); svg.appendChild(defs);

  for(let rI=0;rI<24;rI++){
    for(let cI=0;cI<cols;cI++){
      const use=document.createElementNS(NS,'use');
      use.setAttribute('href','#tile900x300');
      use.setAttribute('x',colX[cI]); use.setAttribute('y',rowY[rI]);
      use.setAttribute('width',colX[cI+1]-colX[cI]);
      use.setAttribute('height',rowY[rI+1]-rowY[rI]);
      svg.appendChild(use);
    }
  }
}

function rebuildSlots(){
  const keys = Object.keys(EXACT).sort((a,b)=>(ORDER.recurring[a]??1e9)-(ORDER.recurring[b]??1e9));
  allSlots = Array.from({length:7}, ()=>Array(SLOTS_PER_DAY).fill(null));
  for(const key of keys){
    const week=EXACT[key];
    for(let d=0; d<7; d++){
      for(const r of week[d]){
        let a=Math.round(r.startMin/15), b=Math.round(r.endMin/15);
        if(b>a){
          for(let s=a; s<b; s++) if(allSlots[d][s]==null) allSlots[d][s]=key;
        } else if(b<a){
          for(let s=a; s<96; s++) if(allSlots[d][s]==null) allSlots[d][s]=key;
          const dn=(d+1)%7; for(let s=0; s<b; s++) if(allSlots[dn][s]==null) allSlots[dn][s]=key;
        }
      }
    }
  }
}

function paintBlocksWeek(geom){
  const layer=document.getElementById('blocksLayer'); layer.innerHTML='';
  const colors=COLORS();
  const {colX, slotY} = geom;
  for(let d=0; d<7; d++){
    let s=0;
    while(s<SLOTS_PER_DAY){
      const key=allSlots[d][s];
      if(!key){ s++; continue; }
      let e=s+1; while(e<SLOTS_PER_DAY && allSlots[d][e]===key) e++;
      const left=colX[d], right=colX[d+1];
      const top=slotY[s], bottom=slotY[e];
      const div=document.createElement('div'); div.className='blk';
      div.style.left=left+'px'; div.style.top=top+'px';
      div.style.width=Math.max(0,(d===6?right-left-1:right-left))+'px';
      div.style.height=(bottom-top)+'px';
      div.style.background = colors[key] || '#ddd';
      div.title = LABELS()[key];
      layer.appendChild(div);
      s=e;
    }
  }
}
function paintNowMagnifier(geom){
  const nowEl=document.getElementById('nowMagnify');
  const today=new Date(); const visStart=visibleWeekFirst; const visEnd=addDays(visStart,6);
  if(+startOfDay(today) < +startOfDay(visStart) || +startOfDay(today) > +startOfDay(visEnd)){
    nowEl.style.display='none'; return;
  }
  const {colX,rowY} = geom;
  const dow=today.getDay(); const mins=today.getHours()*60 + today.getMinutes();
  const hour=Math.floor(mins/60);
  const hourTop=rowY[hour]; const hourH=rowY[hour+1]-rowY[hour];
  const extra=Math.min(10, Math.floor(hourH*0.25));
  const top=Math.max(0, hourTop - Math.floor(extra/2));
  const height=Math.max(2, hourH + extra);
  nowEl.style.left=colX[dow]+'px';
  nowEl.style.top=top+'px';
  nowEl.style.width=(colX[dow+1]-colX[dow] - (dow===6?1:0))+'px';
  nowEl.style.height=height+'px';
  nowEl.style.display='block';
}

/* ---------- Day View ---------- */
function buildDayView(){
  const d = fromISO(activeDayISO);
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head"><div></div>
        <div class="title" id="dayTitle"></div><div></div>
      </div>
      <div class="grid-area">
        <div class="top-row day">
          <div class="day-pill" id="dayPill"></div>
        </div>
        <div class="grid" id="dayGrid">
          <div class="blocks" id="dayBlocks"></div>
          <svg class="mask" id="dayMask" aria-hidden="true"></svg>
        </div>
        <div class="hours" id="dayHours"></div>
      </div>
    </div>
  `;
  document.getElementById('dayTitle').textContent =
    d.toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'});
  document.getElementById('dayPill').textContent =
    d.toLocaleDateString(undefined,{weekday:'short'}) + ', ' + d.getDate();

  document.getElementById('dayGrid').addEventListener('click', openTaskStack);
  repaintDay();
  new ResizeObserver(repaintDay).observe(document.getElementById('dayGrid'));
}

function repaintDay(){
  rebuildSlots();
  const gh=document.getElementById('dayHours'); if(!gh) return;
  gh.innerHTML='';
  const grid=document.getElementById('dayGrid');
  const geom=computeGeometry(grid, 1);

  for(let i=0;i<24;i++){
    const el=document.createElement('div'); el.className='hour-stamp';
    el.textContent = `${String(i).padStart(2,'0')}:00`;
    el.style.top=((geom.rowY[i]+geom.rowY[i+1])/2)+'px';
    gh.appendChild(el);
  }
  buildMask(geom, 1);

  const layer=document.getElementById('dayBlocks'); layer.innerHTML='';
  const colors=COLORS();
  const dow=fromISO(activeDayISO).getDay();
  let s=0; while(s<SLOTS_PER_DAY){
    const key=allSlots[dow][s];
    if(!key){ s++; continue; }
    let e=s+1; while(e<SLOTS_PER_DAY && allSlots[dow][e]===key) e++;
    const left=0, right=grid.getBoundingClientRect().width;
    const top=geom.slotY[s], bottom=geom.slotY[e];
    const div=document.createElement('div'); div.className='blk';
    div.style.left=left+'px';
    div.style.top=top+'px';
    div.style.width=(right-left-1)+'px';
    div.style.height=(bottom-top)+'px';
    div.style.background = colors[key] || '#ddd';
    div.title = LABELS()[key];
    layer.appendChild(div);
    s=e;
  }
}

/* ---------- Month View ---------- */
function buildMonthView(){
  const base = fromISO(activeDayISO);
  const first = new Date(base.getFullYear(), base.getMonth(), 1);
  const last  = new Date(base.getFullYear(), base.getMonth()+1, 0);
  const label = first.toLocaleDateString(undefined,{month:'long', year:'numeric'});

  screenEl.innerHTML = `
    <div class="month-wrap">
      <div class="head">
        <button id="prevMon" class="chev" aria-label="Prev month">‚óÄ</button>
        <div class="title">${label}</div>
        <button id="nextMon" class="chev" aria-label="Next month">‚ñ∂</button>
      </div>
      <div class="month-grid" id="monthGrid"></div>
    </div>
  `;
  document.getElementById('prevMon').onclick=()=>{ activeDayISO = toISO(new Date(base.getFullYear(), base.getMonth()-1, 1)); buildMonthView(); saveSoon(300); };
  document.getElementById('nextMon').onclick=()=>{ activeDayISO = toISO(new Date(base.getFullYear(), base.getMonth()+1, 1)); buildMonthView(); saveSoon(300); };

  const g=document.getElementById('monthGrid'); g.innerHTML='';
  const firstWeekday = first.getDay();
  const prevLast = new Date(base.getFullYear(), base.getMonth(), 0).getDate();
  for(let i=firstWeekday-1;i>=0;i--){ const el=document.createElement('div'); el.className='mcell muted'; el.textContent=(prevLast - i); g.appendChild(el); }
  for(let day=1; day<=last.getDate(); day++){
    const tile=document.createElement('div'); tile.className='mcell'; tile.textContent=day;
    const iso = toISO(new Date(base.getFullYear(), base.getMonth(), day));
    if(iso===toISO(new Date())) tile.classList.add('today');
    g.appendChild(tile);
  }
  const used = firstWeekday + last.getDate();
  const rem = (Math.ceil(used/7)*7) - used;
  for(let i=1;i<=rem;i++){ const el=document.createElement('div'); el.className='mcell muted'; el.textContent=i; g.appendChild(el); }
}

/* ---------- Task picker (single stack) ---------- */
const overlay=document.getElementById('taskOverlay');
let currentTaskKey=null;

function openTaskStack(){
  overlay.innerHTML='';
  const stack=document.createElement('div'); stack.className='stack';
  const totals = weeklyTotals();
  for(const t of TASKS){
    const row=document.createElement('button'); row.className='taskRow'; row.dataset.key=t.key;
    row.innerHTML = `<span class="dot" style="background:${t.color}"></span>
                     <span class="name">${t.label}</span>
                     <span class="dur">${formatDecimalHours(totals[t.key]||0)}</span>`;
    row.addEventListener('click', ()=>{ currentTaskKey=t.key; openEditor(t); });
    stack.appendChild(row);
  }
  overlay.appendChild(stack);
  overlay.style.display='block';
}
overlay.addEventListener('click',(e)=>{ if(e.target===overlay) overlay.style.display='none'; });

function weeklyTotals(){
  rebuildSlots();
  const out=Object.fromEntries(TASKS.map(t=>[t.key,0]));
  for(let d=0; d<7; d++){ for(let s=0; s<SLOTS_PER_DAY; s++){ const k=allSlots[d][s]; if(!k) continue; out[k]+=15; } }
  return out;
}
function formatDecimalHours(min){ if(min<=0) return ''; if(min<60) return `${min} m`; const h=min/60; const q=Math.round(h*4)/4; const as=(Math.round(q*100)%100===0)?String(Math.round(q)):String(q); return `${as}H`; }

/* ---------- Settings editor ---------- */
const edOverlay=document.getElementById('settingsOverlay');
const edBody=document.getElementById('edBody');
const edTitle=document.getElementById('edTitle');
const edName=document.getElementById('edName');
const edColor=document.getElementById('edColor');
const MAX_RANGES_PER_DAY=6;
let sessionDraft=null;

function openEditor(task){
  overlay.style.display='none';
  sessionDraft = {
    key: task.key, label: task.label, color: toHex(task.color),
    week: EXACT[task.key].map(dayArr => dayArr.map(r => ({startMin:r.startMin, endMin:r.endMin})))
  };
  edTitle.textContent = `Edit: ${task.label}`;
  edName.value = task.label; edColor.value = toHex(task.color);
  buildEditorDays();
  edOverlay.style.display='block';
}

function buildEditorDays(){
  edBody.innerHTML='';
  const first=visibleWeekFirst;
  for(let d=0; d<7; d++){
    const theDate = addDays(first, d);
    const dayLabel = `${DAY_NAMES[d]}, ${theDate.toLocaleDateString(undefined,{month:'long'})} ${ORD(theDate.getDate())}`;

    const wrap=document.createElement('div'); wrap.className='dayRow'; wrap.dataset.day=d;

    const head=document.createElement('div'); head.className='dayHead';
    head.innerHTML = `<span>${dayLabel}</span><span></span>`;
    wrap.appendChild(head);

    const slots=document.createElement('div'); slots.className='slots'; wrap.appendChild(slots);

    const addRow=document.createElement('div'); addRow.className='addRow';
    const addBtn=document.createElement('button'); addBtn.className='addBtn'; addBtn.type='button'; addBtn.textContent='Create new';
    addBtn.addEventListener('click', ()=>{ const row = addSlotRow(slots, d); if(row){ row.querySelector('.start').focus(); } });
    addRow.appendChild(addBtn); wrap.appendChild(addRow);

    // render existing ranges, if any
    (sessionDraft.week[d]||[]).forEach(r=>addSlotRow(slots, d, r.startMin, r.endMin, true));

    edBody.appendChild(wrap);
  }
}

function addSlotRow(slotsEl, dayIndex, startMin=null, endMin=null, preexisting=false){
  if(slotsEl.querySelectorAll('.slot').length >= MAX_RANGES_PER_DAY) return null;
  const row=document.createElement('div'); row.className='slot';
  const startVal = startMin==null ? '' : toHHMM(startMin);
  const endVal   = endMin==null ? '' : toHHMM(endMin);

  row.innerHTML = `
    <input type="time" class="in start" step="900" value="${startVal}">
    <input type="time" class="in end"   step="900" value="${endVal}">
    <button class="iconBtn mic"   title="Speak time" aria-label="Microphone">üé§</button>
    <button class="iconBtn trash" title="Delete" aria-label="Delete">üóëÔ∏è</button>

    <select class="select scope">
      <option value="recurring" selected>Recurring</option>
      <!-- Day/today removed per your spec; keeping only recurring for now -->
      <option value="week">This week</option>
      <option value="month">This month</option>
    </select>

    <select class="select remind">
      <option value="off" selected>Set reminder</option>
      <option value="5m">5 m</option><option value="10m">10 m</option><option value="15m">15 m</option>
      <option value="30m">30 m</option><option value="1h">1 h</option><option value="24h">24 h</option>
    </select>
  `;

  row.querySelector('.mic').addEventListener('click', async ()=>{
    const sample = 'Say: "9:00 AM to 5:00 PM"';
    let text = '';
    if('webkitSpeechRecognition' in window){
      try{
        const rec = new webkitSpeechRecognition(); rec.lang='en-US'; rec.interimResults=false; rec.continuous=false;
        alert(sample);
        text = await new Promise((resolve,reject)=>{
          rec.onresult = e=>resolve(e.results[0][0].transcript);
          rec.onerror = e=>reject(e.error);
          rec.onend = ()=>{};
          rec.start(); setTimeout(()=>{ try{rec.stop();}catch{} }, 4500);
        });
      }catch{ text = prompt(sample) || ''; }
    }else{ text = prompt(sample) || ''; }
    const parsed=parseSpokenRange(text);
    if(parsed){ row.querySelector('.start').value=toHHMM(parsed.s); row.querySelector('.end').value=toHHMM(parsed.e); }
  });

  row.querySelector('.trash').addEventListener('click', ()=>{ row.remove(); });

  slotsEl.appendChild(row);
  if(!preexisting) row.scrollIntoView({block:'nearest'});
  return row;
}

function parseSpokenRange(s){
  if(!s) return null;
  const m=s.toLowerCase().match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s*(?:to|-|‚Äì|‚Äî)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
  if(!m) return null;
  const sH=Number(m[1]), sM=Number(m[2]||0), sA=(m[3]||'').toLowerCase();
  const eH=Number(m[4]), eM=Number(m[5]||0), eA=(m[6]||'').toLowerCase();
  const to24=(h,m,ap)=>{ let H=h%12; if(ap==='pm') H+=12; if(ap==='' && h===12) H=12; return H*60+m; };
  const sMin = to24(sH,sM,sA);
  const eMin = to24(eH,eM,eA);
  return {s:sMin, e:eMin};
}

document.getElementById('edCancel').addEventListener('click', ()=>{
  const sure = confirm('Discard edits?');
  if(!sure) return;
  edOverlay.style.display='none';
});

document.getElementById('edSave').addEventListener('click', async ()=>{
  if(!sessionDraft) return;
  const t = TASKS.find(x=>x.key===sessionDraft.key);
  t.label = (edName.value||'').slice(0,14) || t.label;
  t.color = edColor.value || t.color;

  const week = Array.from({length:7},()=>[]);
  edBody.querySelectorAll('.dayRow').forEach((wrap,d)=>{
    const rows=[...wrap.querySelectorAll('.slot')].slice(0,6);
    for(const row of rows){
      const sVal=row.querySelector('.start').value;
      const eVal=row.querySelector('.end').value;
      if(!sVal || !eVal) continue;
      const sMin = toMin(sVal);
      const eMin = toMin(eVal);
      if(sMin===eMin) continue;
      if(eMin>sMin){
        week[d].push({startMin:round15(sMin), endMin:round15(eMin)});
      }else{
        week[d].push({startMin:round15(sMin), endMin:round15(24*60)});
        const dn=(d+1)%7; week[dn].push({startMin:0, endMin:round15(eMin)});
      }
    }
    week[d].sort((A,B)=>A.startMin-B.startMin);
    const merged=[];
    for(const r of week[d]){
      if(!merged.length) merged.push({...r});
      else{
        const L=merged[merged.length-1];
        if(r.startMin<=L.endMin){ L.endMin=Math.max(L.endMin,r.endMin); }
        else merged.push({...r});
      }
    }
    week[d]=merged.slice(0,6);
  });

  EXACT[t.key] = week;
  ORDER.recurring[t.key] = ORDER.recurring[t.key] || (SAVE_SEQ++);

  edOverlay.style.display='none';
  if(activeView==='week') repaintWeek();
  if(activeView==='day') repaintDay();

  /* Persist immediately so refresh/restart keeps everything */
  await saveAll();
});

/* Small utils */
function toHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function toMin(hhmm){ const [h,m]=hhmm.split(':').map(Number); return (h*60+m)|0; }
function toHex(c){ const s=String(c).trim(); if(/^#([0-9a-f]{6})$/i.test(s)) return s;
  const m=s.match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i); if(m){ const r=+m[1],g=+m[2],b=+m[3]; return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); } return '#999999'; }

/* ---------- Root render & INIT (load before first paint) ---------- */
async function init(){
  try{
    const snap = await idbGet('state');
    hydrateState(snap);
  }catch(e){
    console.warn('Load failed (fresh start or permission issue):', e);
  }finally{
    render();
  }
  /* extra safety: save periodically while app is open */
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveAll(); });
  window.addEventListener('beforeunload', ()=>{ /* best-effort */ saveAll(); });
}

function render(){
  syncPanelWidthVar();
  if(activeView==='week') buildWeekView();
  else if(activeView==='day') buildDayView();
  else if(activeView==='month') buildMonthView();
  else screenEl.innerHTML='';
}

/* Kick off */
init();
</script>
</body>
</html>

