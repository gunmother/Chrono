<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Betterly — Tilt Glass UI</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#ffffff" />

<!-- ===== WEEKLY CHART: original styles (kept intact) ===== -->
<style>
  :root{
    --bg:#54585F;
    --uiw:360px; --toph:28px; --centerh:496px; --dockh:92px;
    --gapTop:12px; --gapBottom:12px;

    --surface:#F4F6FB; --border:#D1D7E0; --text:#0F172A;

    --font:"Google Sans","Roboto","Arial",system-ui,-apple-system,"Segoe UI",sans-serif;
    --screenPad:12px; --dot:6px;

    --grid-margin:16px;
    --hour-col:56px;
    --label-size:11px;
    --date-size:18px;
    --dow-h:16px;

    --task-col-gap:16px;
    --task-row-gap:10px;
    --task-height:46px;
    --task-maxw:560px;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-font-smoothing:antialiased;overflow:hidden}
  *{box-sizing:border-box}

  .menu-panel{position:fixed;left:50%;transform:translateX(-50%);top:var(--groupTop,0px);
    width:var(--uiw);height:var(--toph);background:var(--surface);border:1px solid var(--border);
    border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.28),0 2px 6px rgba(0,0,0,.22);
    display:flex;align-items:center;justify-content:center;z-index:30}
  .menu-handle{height:100%;width:100%;display:flex;align-items:center;justify-content:center}
  .dot{width:var(--dot);height:var(--dot);border-radius:50%;background:#9AA6B4;margin:0 calc(var(--dot)/2.2)}

  /* NOTE: .center-pane is not used in the new shell; kept for completeness */
  .center-pane{position:fixed;left:50%;transform:translateX(-50%);
    top:calc(var(--groupTop,0px) + var(--toph) + var(--gapTop));
    width:var(--uiw);height:var(--centerh);background:var(--surface);border-radius:18px;
    box-shadow:0 10px 24px rgba(0,0,0,.28),0 2px 6px rgba(0,0,0,.22);z-index:10;overflow:hidden}
  .center-pane::before,.center-pane::after{content:"";position:absolute;inset:0;border-radius:18px;pointer-events:none}
  .center-pane::before{border-top:1px solid #C4CCDA;border-left:1px solid #C4CCDA}
  .center-pane::after{border-bottom:1px solid #FFF;border-right:1px solid #FFF}

  .bottom-dock{position:fixed;left:50%;transform:translateX(-50%);
    top:calc(100vh - var(--groupBottomOffset,0px) - var(--dockh));
    width:min(calc(var(--uiw) - 8px), calc(100vw - var(--screenPad)*2 - 8px));
    height:var(--dockh);background:var(--surface);border:1px solid var(--border);border-bottom:none;
    border-radius:12px 12px 0 0;box-shadow:0 10px 24px rgba(0,0,0,.28),0 2px 6px rgba(0,0,0,.22);z-index:20}

  .wrap{position:absolute;inset:0;display:flex;flex-direction:column;padding:var(--grid-margin)}
  .header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-bottom:8px}
  .tri{color:#9AA6B4;font-size:calc(var(--label-size)*.9);line-height:1;text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
  .tri.left{justify-self:end;margin-right:6px}.tri.right{justify-self:start;margin-left:6px}
  .title{text-align:center;font-weight:700;font-size:var(--date-size);color:#0F172A;letter-spacing:.2px}
  .content{position:relative;flex:1;overflow:visible}

  .hours{position:absolute;top:var(--dow-h);bottom:0;left:0;width:var(--hour-col);pointer-events:none}
  .hour-stamp{position:absolute;left:8px;transform:translateY(-50%);font-size:var(--label-size);color:#334155;opacity:.95;white-space:nowrap}
  .dow-labels{position:absolute;top:0;left:var(--hour-col);right:0;height:var(--dow-h);display:grid;grid-template-columns:repeat(7,1fr);align-items:center;pointer-events:none}
  .dow-label{font-size:calc(var(--label-size)*0.95); color:#364152; text-align:center; font-weight:600; letter-spacing:.2px}

  #weekGrid{position:absolute;top:var(--dow-h);left:var(--hour-col);right:0;bottom:0;overflow:hidden;background:#E3E7EE}
  #blocksLayer{position:absolute;inset:0}
  .blk{position:absolute;border-radius:0}
  #maskSVG{position:absolute;inset:0;pointer-events:none;shape-rendering:crispEdges}

  /* Magnifier pill (slightly taller than 1 hour) */
  #nowMagnify{position:absolute;pointer-events:none;z-index:3;border:2px solid #0EA5E9;border-radius:999px;
    background:rgba(255,255,255,0.18); backdrop-filter:saturate(120%) brightness(1.05); display:none}

  /* ===== 2×8 overlay ===== */
  #taskOverlay{position:fixed;inset:0;z-index:100;display:none;background:transparent}
  #taskOverlay .backdrop{position:absolute;inset:0}
  #taskOverlay .container{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(calc(var(--uiw) - 40px), var(--task-maxw));
    display:grid; grid-template-columns:1fr 1fr;
    grid-auto-rows: var(--task-height);
    column-gap:var(--task-col-gap); row-gap:var(--task-row-gap);
    padding:4px;
  }
  .task-btn{
    position:relative; display:block; height:100%;
    border:2px solid rgba(0,0,0,.20); border-radius:16px;
    padding:0 16px 0 42px;
    background:#ffffff;
    box-shadow:0 12px 24px rgba(0,0,0,.24),0 6px 12px rgba(0,0,0,.18),0 1px 0 rgba(255,255,255,.6) inset;
    -webkit-tap-highlight-color:transparent; user-select:none;
    opacity:0; transform:translateY(8px) scale(.98);
    transition:transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    cursor:pointer; overflow:hidden;
  }
  .task-btn:active{ transform:translateY(1px) scale(.985);
    box-shadow:0 10px 20px rgba(0,0,0,.28),0 4px 10px rgba(0,0,0,.2),0 1px 0 rgba(255,255,255,.6) inset}
  .task-dot{position:absolute; left:12px; top:50%; transform:translateY(-50%);
    width:16px; height:16px; border-radius:50%; box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}

  .task-label{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:90%; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-size:15px; font-weight:900; letter-spacing:.25px; color:#000;
  }
  .task-label .dur{opacity:.7; font-weight:800; margin-left:.35em}

  @keyframes slideFadeIn{from{opacity:0; transform:translateY(10px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}
  @keyframes slideFadeOut{from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(10px) scale(.98)}}
  #taskOverlay.show .task-btn{animation:slideFadeIn 220ms ease-out both}
  #taskOverlay.hide .task-btn{animation:slideFadeOut 180ms ease-in both}

  /* ===== Settings ===== */
  #settingsOverlay{position:fixed; inset:0; z-index:140; display:none; background:rgba(16,23,40,.35); backdrop-filter:blur(6px);}
  #settingsOverlay.show .ws-card{animation:ws-in 180ms ease-out both}
  #settingsOverlay.hide .ws-card{animation:ws-out 150ms ease-in both}

  .ws-card{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(92vw, 520px); max-width:92vw; max-height:min(86vh, 680px);
    display:flex; flex-direction:column; background:#fff; border-radius:18px; border:4px solid #E6EBF2;
    box-shadow:0 20px 46px rgba(0,0,0,.28), 0 6px 14px rgba(0,0,0,.22); overflow:hidden}
  .ws-head{display:flex; align-items:center; gap:10px; padding:12px 14px; background:#F7F9FC; border-bottom:1px solid #E6EBF2}
  .ws-title{display:flex; align-items:center; gap:8px; flex:1}
  .ws-title input{flex:1; min-width:0; padding:8px 10px; border:1px solid #D7DFEA; border-radius:10px; font-weight:800}
  .ws-title small{color:#64748B}

  .ws-body{padding:14px; display:grid; gap:16px; overflow-y:auto; overflow-x:hidden; min-width:0}
  .ws-row{display:grid; gap:10px; min-width:0}
  .ws-label{font-size:12px; color:#475569}
  .ws-inline{display:flex; align-items:center; gap:10px; min-width:0; flex-wrap:wrap}
  .swatch{width:22px; height:22px; border-radius:50%; box-shadow:0 0 0 1px rgba(0,0,0,.08) inset}

  .scope-trigger{display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #E6EBF2; border-radius:12px; background:#FBFDFF; cursor:pointer; user-select:none}
  .scope-trigger .chev{font-size:12px; opacity:.7}
  .scope-pop{position:relative}
  .scope-list{position:absolute; top:6px; left:0; right:auto; z-index:2; background:#fff; border:1px solid #E6EBF2; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,.18); padding:6px; display:none; min-width:200px}
  .scope-opt{padding:8px 10px; border-radius:10px; cursor:pointer}
  .scope-opt[aria-selected="true"]{background:#E8F0FB}
  .scope-opt[aria-disabled="true"]{opacity:.5; cursor:not-allowed}

  #wsDays{display:grid; row-gap:18px;}
  .day-row{border:1px solid #E6EBF2; border-radius:12px; padding:10px; display:grid; gap:12px; min-width:0; background:#FBFDFF}
  .day-header{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .day-header div{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .slots{display:grid; gap:12px; min-width:0}
  .slot{display:grid; grid-template-columns:1fr 1fr 36px; gap:12px; align-items:center; min-width:0}
  .slot input[type="time"]{min-width:0; width:100%; padding:11px 12px; border:1px solid #D7DFEA; border-radius:10px; font:inherit; background:#F6F8FB}
  .slot .del{width:36px; height:36px; border:none; border-radius:8px; background:#F1F5F9; display:grid; place-items:center; cursor:pointer}
  .slot .del:hover{background:#E8EDF4}
  .addSlot{width:36px; height:36px; border:none; border-radius:8px; background:#E8F0FB; display:grid; place-items:center; cursor:pointer}
  .overnight{font-size:10px; color:#0284C7; font-weight:800; padding:2px 6px; background:#E0F2FE; border-radius:999px}
  .clipNote{font-size:10px; color:#64748B; padding-left:2px}
  .day-row.disabled{opacity:.6}
  .ws-foot{padding:10px; border-top:1px solid #E6EBF2; display:flex; gap:10px; justify-content:flex-end; background:#F9FBFE; flex-wrap:wrap}
  .btn{padding:10px 14px; border:none; border-radius:12px; font-weight:700; cursor:pointer}
  .btn.discard{background:#EEF2F7; color:#0F172A}
  .btn.discard:hover{background:#E6EBF2}
  .btn.save{background:#0EA5E9; color:#fff}
  .btn.save:hover{background:#0284C7}

  .palette{display:grid; gap:10px; min-width:0}
  .paletteHead{display:flex; align-items:center; gap:10px}
  .paletteHead .editColor{border:none; background:#EFF6FF; padding:6px 10px; border-radius:10px; cursor:pointer}
  .square-wrap{position:relative; width:100%; aspect-ratio:5/3; max-height:220px}
  canvas#svCanvas{position:absolute; inset:0; border-radius:10px; display:block}
  .knob{position:absolute; width:16px; height:16px; border:2px solid #fff; border-radius:50%;
    box-shadow:0 0 0 1px rgba(0,0,0,.35), 0 0 8px rgba(0,0,0,.35); transform:translate(-50%, -50%); pointer-events:none}
  .hueRow{display:flex; align-items:center; gap:10px}
  .hue{appearance:none; width:100%; height:12px; border-radius:6px; outline:none; border:1px solid #CBD5E1; background:linear-gradient(90deg, red, #ff0, #0f0, #0ff, #00f, #f0f, red)}
  .num{width:64px; text-align:right; color:#475569; font-size:12px}

  @keyframes ws-in{from{opacity:0; transform:translate(-50%,-48%) scale(.98)} to{opacity:1; transform:translate(-50%,-50%) scale(1)}}
  @keyframes ws-out{from{opacity:1; transform:translate(-50%,-50%) scale(1)} to{opacity:0; transform:translate(-50%,-48%) scale(.98)}}

  @media (max-width:360px){
    .ws-head,.ws-body,.ws-foot{padding-left:12px;padding-right:12px}
    .square-wrap{aspect-ratio:4/3}
  }
</style>

<!-- ===== NEW SHELL: Tilt Glass UI styles (kept intact) ===== -->
<style>
  :root{
    --bg:#ffffff;
    --pane:#ffffff;

    --sx: 0px;
    --sy: 12px;
    --sblur: 14px;

    --hx: 50%;
    --hy: 22%;

    --app-w: clamp(320px, 92vw, 420px);
    --gap: clamp(18px, 2.6vh, 24px);
    --barH: clamp(34px, 5.2vh, 46px);

    --coin: clamp(52px, 7.6vh, 62px);

    --r-lg: 24px;
    --r-pill: 999px;

    --led:#eaffff;
    --led-glow: rgba(234,255,255,.98);

    --blue-1:#38bdff;
    --blue-2:#0e56ba;

    --ring-track:#9aaac3;
    --ring-led: var(--led);
    --ring-thickness: 4.5;
    --ring-thickness-px: 4.5px;
    --ring-gap: 10px;

    --ink:#92a0b3;
    --ink-active:var(--led);
  }

  html,body{height:100%;margin:0;background:var(--bg);overflow:hidden;overscroll-behavior:none}
  body{
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    padding: max(16px, env(safe-area-inset-top))
             max(16px, env(safe-area-inset-right))
             max(20px, env(safe-area-inset-bottom))
             max(16px, env(safe-area-inset-left));
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none; user-select: none;
    touch-action: manipulation;
  }

  .app{
    width:var(--app-w);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(20px, env(safe-area-inset-bottom)));
    margin:0 auto; display:grid; grid-template-rows: var(--barH) 1fr auto; gap:var(--gap);
    position:relative;
  }

  .glass{
    background: var(--pane);
    border-radius: var(--r-lg);
    position:relative;
    box-shadow:
      var(--sx) var(--sy) var(--sblur) rgba(0,0,0,.22),
      calc(var(--sx)*.5) calc(var(--sy)*.5) calc(var(--sblur)*.6) rgba(0,0,0,.12);
  }
  .glass::before{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background: radial-gradient(140% 120% at var(--hx) var(--hy),
                 rgba(255,255,255,.55), rgba(255,255,255,0) 58%);
    opacity:.9; mix-blend-mode:screen;
  }

  .topwrap{ position:relative; z-index:3; }
  .topbar{
    height:var(--barH); border-radius:var(--r-pill); display:flex; align-items:center; justify-content:center; gap:10px;
    background:#f7f9fd; position:relative;
    box-shadow:none;
  }
  .topwrap .shadow{
    position:absolute; inset:0; border-radius:var(--r-pill); z-index:0; pointer-events:none;
    box-shadow:
      var(--sx) var(--sy) var(--sblur) rgba(0,0,0,.22),
      calc(var(--sx)*.5) calc(var(--sy)*.5) calc(var(--sblur)*.6) rgba(0,0,0,.12);
  }
  .topbar::before{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background: radial-gradient(140% 120% at var(--hx) var(--hy),
                 rgba(255,255,255,.55), rgba(255,255,255,0) 58%);
    opacity:.9; mix-blend-mode:screen;
  }
  .dot{width:8px;height:8px;border-radius:50%; background:#cfd8e6; box-shadow:inset 0 1px 0 #fff, 0 1px 2px rgba(0,0,0,.06)}

  .stage{ position:relative; z-index:4; }
  .stage .glass{ background:#fff; width:100%; height:100%; }

  .coins{
    display:grid; grid-template-columns: repeat(4, 1fr); gap:22px; align-items:end;
    padding-bottom: 2px;
    position:relative; z-index:5;
    margin-top: 10px;
  }

  .coin{
    width:var(--coin); height:var(--coin); margin:0 auto; border-radius:50%;
    border:0; outline:0; position:relative; cursor:pointer; background:transparent;
    isolation:isolate; overflow:visible;
  }
  .coin::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    z-index:0; pointer-events:none; background:transparent;
    box-shadow:
      var(--sx) var(--sy) var(--sblur) rgba(0,0,0,.30),
      calc(var(--sx)*.6) calc(var(--sy)*.6) calc(var(--sblur)*.5) rgba(0,0,0,.16);
  }

  .ring{
    position:absolute;
    inset: calc(-1 * (var(--ring-gap) + var(--ring-thickness-px)));
    z-index:2; pointer-events:none; overflow:visible;
  }
  .ring svg{ width:100%; height:100%; display:block; overflow:visible }
  .ring .track{
    fill:none; stroke: var(--ring-track); stroke-width: var(--ring-thickness); stroke-linecap:round;
    filter: url(#grooveFilter);
  }
  .ring .arc{
    fill:none; stroke: var(--ring-led); stroke-width: var(--ring-thickness); stroke-linecap:round;
    transform: rotate(-90deg); transform-origin:50% 50%;
    filter: url(#ledGlow);
  }

  .flip{
    position:absolute; inset:0; border-radius:50%;
    transform-style: preserve-3d;
    transition: transform 340ms cubic-bezier(.2,.7,.2,1);
    z-index:1;
    background:transparent;
  }
  .face{
    position:absolute; inset:0; border-radius:50%;
    display:grid; place-items:center;
    backface-visibility: hidden; -webkit-backface-visibility: hidden;
    background:transparent;
  }
  .front{
    background:
      radial-gradient(160% 160% at 22% 18%, #ffffff 0%, #f3f7fd 22%, #e8eff9 48%, #e4edf8 68%, #e0eaf7 100%);
  }
  .back{
    transform: rotate3d(1,1,0,180deg);
    background: radial-gradient(120% 120% at 30% 30%, var(--blue-1), var(--blue-2) 70%);
  }

  .icon{ width:68%; height:68%; overflow:visible }
  .icon *{ vector-effect: non-scaling-stroke; }
  .front .icon{ fill:none; stroke: var(--ink); stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; }
  .back  .icon{ fill:none; stroke: var(--ink-active); stroke-width:2.0; stroke-linecap:round; stroke-linejoin:round; filter:url(#ledGlow); }

  .coin.active .flip{ transform: rotate3d(1,1,0,180deg); }
  .coin:focus-visible{ outline:2px solid #8ecbff; outline-offset:2px; border-radius:50%; }

  @media (max-height: 600px){
    :root{ --gap:14px; --coin:48px; }
  }
  @media (prefers-reduced-motion: reduce){
    .flip{ transition:none }
  }
</style>
</head>
<body>
  <!-- global filters for LED/gloss -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <filter id="ledGlow" x="-40%" y="-40%" width="180%" height="180%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="1.0" result="g"/>
        <feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <filter id="grooveFilter" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0.7" dy="0.7" stdDeviation="0.7" flood-color="#b8c3d6" flood-opacity=".65"/>
        <feDropShadow dx="-0.7" dy="-0.7" stdDeviation="0.7" flood-color="#ffffff" flood-opacity=".9"/>
      </filter>
    </defs>
  </svg>

  <main class="app">
    <!-- TOP BAR -->
    <div class="topwrap">
      <div class="shadow" aria-hidden="true"></div>
      <div class="topbar" aria-label="Menu handle">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>

    <!-- CENTER SCREEN (weekly chart mounted inside the glass) -->
    <section class="stage">
      <div class="glass" aria-label="Center screen">
        <!-- ===== WEEKLY CHART: kept logic/IDs intact, mounted here ===== -->
        <div class="wrap" id="weekWrap">
          <div class="header">
            <div class="tri left" id="prevWeekBtn">▲</div>
            <div class="title" id="weekTitle">—</div>
            <div class="tri right" id="nextWeekBtn">▼</div>
          </div>

          <div class="content" id="weekContent">
            <div class="dow-labels" id="dowLabels"></div>

            <div id="weekGrid" aria-label="Weekly grid">
              <div id="blocksLayer"></div>
              <svg id="maskSVG" aria-hidden="true"></svg>
              <div id="nowMagnify" aria-hidden="true"></div>
            </div>

            <div class="hours" id="weekHours"></div>
          </div>
        </div>
        <!-- ===== /weekly chart ===== -->
      </div>
    </section>

    <!-- BUTTONS -->
    <div class="coins" role="group" aria-label="Primary views">
      <!-- Day -->
      <button class="coin" aria-label="Day view" aria-pressed="false" data-name="day" data-progress="0.42">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4.6"/><g>
              <line x1="12" y1="2.2"  x2="12" y2="4.2"/>
              <line x1="19.8" y1="12"  x2="21.8" y2="12"/>
              <line x1="12" y1="19.8" x2="12" y2="21.8"/>
              <line x1="2.2" y1="12"  x2="4.2" y2="12"/>
              <line x1="17.3" y1="6.7" x2="18.7" y2="5.3"/>
              <line x1="17.3" y1="17.3" x2="18.7" y2="18.7"/>
              <line x1="6.7"  y1="17.3" x2="5.3"  y2="18.7"/>
              <line x1="6.7"  y1="6.7"  x2="5.3"  y2="5.3"/>
            </g></svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24" filter="url(#ledGlow)"><circle cx="12" cy="12" r="4.6"/><g>
              <line x1="12" y1="2.2"  x2="12" y2="4.2"/>
              <line x1="19.8" y1="12"  x2="21.8" y2="12"/>
              <line x1="12" y1="19.8" x2="12" y2="21.8"/>
              <line x1="2.2" y1="12"  x2="4.2" y2="12"/>
              <line x1="17.3" y1="6.7" x2="18.7" y2="5.3"/>
              <line x1="17.3" y1="17.3" x2="18.7" y2="18.7"/>
              <line x1="6.7"  y1="17.3" x2="5.3"  y2="18.7"/>
              <line x1="6.7"  y1="6.7"  x2="5.3"  y2="5.3"/>
            </g></svg>
          </div>
        </div>
      </button>

      <!-- Week -->
      <button class="coin" aria-label="Week view" aria-pressed="true" data-name="week" data-progress="0.18">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g><line x1="6" y1="10" x2="6" y2="19.5"/><line x1="8" y1="10" x2="8" y2="19.5"/><line x1="10" y1="10" x2="10" y2="19.5"/><line x1="12" y1="10" x2="12" y2="19.5"/><line x1="14" y1="10" x2="14" y2="19.5"/><line x1="16" y1="10" x2="16" y2="19.5"/><line x1="18" y1="10" x2="18" y2="19.5"/></g>
            </svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24" filter="url(#ledGlow)">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g><line x1="6" y1="10" x2="6" y2="19.5"/><line x1="8" y1="10" x2="8" y2="19.5"/><line x1="10" y1="10" x2="10" y2="19.5"/><line x1="12" y1="10" x2="12" y2="19.5"/><line x1="14" y1="10" x2="14" y2="19.5"/><line x1="16" y1="10" x2="16" y2="19.5"/><line x1="18" y1="10" x2="18" y2="19.5"/></g>
            </svg>
          </div>
        </div>
      </button>

      <!-- Month -->
      <button class="coin" aria-label="Month view" aria-pressed="false" data-name="month" data-progress="0.63">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g>
                <circle cx="6.2" cy="11" r=".8"/><circle cx="8.9" cy="11" r=".8"/><circle cx="11.6" cy="11" r=".8"/><circle cx="14.3" cy="11" r=".8"/><circle cx="17.0" cy="11" r=".8"/>
                <circle cx="6.2" cy="12.9" r=".8"/><circle cx="8.9" cy="12.9" r=".8"/><circle cx="11.6" cy="12.9" r=".8"/><circle cx="14.3" cy="12.9" r=".8"/><circle cx="17.0" cy="12.9" r=".8"/>
                <circle cx="6.2" cy="14.8" r=".8"/><circle cx="8.9" cy="14.8" r=".8"/><circle cx="11.6" cy="14.8" r=".8"/><circle cx="14.3" cy="14.8" r=".8"/><circle cx="17.0" cy="14.8" r=".8"/>
                <circle cx="6.2" cy="16.7" r=".8"/><circle cx="8.9" cy="16.7" r=".8"/><circle cx="11.6" cy="16.7" r=".8"/><circle cx="14.3" cy="16.7" r=".8"/><circle cx="17.0" cy="16.7" r=".8"/>
                <circle cx="6.2" cy="18.6" r=".8"/><circle cx="8.9" cy="18.6" r=".8"/><circle cx="11.6" cy="18.6" r=".8"/><circle cx="14.3" cy="18.6" r=".8"/><circle cx="17.0" cy="18.6" r=".8"/>
              </g>
            </svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24" filter="url(#ledGlow)">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g>
                <circle cx="6.2" cy="11" r=".8"/><circle cx="8.9" cy="11" r=".8"/><circle cx="11.6" cy="11" r=".8"/><circle cx="14.3" cy="11" r=".8"/><circle cx="17.0" cy="11" r=".8"/>
                <circle cx="6.2" cy="12.9" r=".8"/><circle cx="8.9" cy="12.9" r=".8"/><circle cx="11.6" cy="12.9" r=".8"/><circle cx="14.3" cy="12.9" r=".8"/><circle cx="17.0" cy="12.9" r=".8"/>
                <circle cx="6.2" cy="14.8" r=".8"/><circle cx="8.9" cy="14.8" r=".8"/><circle cx="11.6" cy="14.8" r=".8"/><circle cx="14.3" cy="14.8" r=".8"/><circle cx="17.0" cy="14.8" r=".8"/>
                <circle cx="6.2" cy="16.7" r=".8"/><circle cx="8.9" cy="16.7" r=".8"/><circle cx="11.6" cy="16.7" r=".8"/><circle cx="14.3" cy="16.7" r=".8"/><circle cx="17.0" cy="16.7" r=".8"/>
                <circle cx="6.2" cy="18.6" r=".8"/><circle cx="8.9" cy="18.6" r=".8"/><circle cx="11.6" cy="18.6" r=".8"/><circle cx="14.3" cy="18.6" r=".8"/><circle cx="17.0" cy="18.6" r=".8"/>
              </g>
            </svg>
          </div>
        </div>
      </button>

      <!-- To-Do -->
      <button class="coin" aria-label="To-Do list" aria-pressed="false" data-name="todo" data-progress="0.05">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <polyline points="6.5,14 10,17.5 17.5,10"/>
            </svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24" filter="url(#ledGlow)">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <polyline points="6.5,14 10,17.5 17.5,10"/>
            </svg>
          </div>
        </div>
      </button>
    </div>

    <button id="enable" hidden>Enable motion</button>

    <!-- ===== WEEKLY CHART overlays (kept intact) ===== -->
    <div id="taskOverlay" aria-hidden="true">
      <div class="backdrop"></div>
      <div class="container" id="taskContainer"></div>
    </div>

    <div id="settingsOverlay" aria-modal="true" role="dialog">
      <div class="ws-card" role="document">
        <div class="ws-head">
          <div class="ws-title">
            <input id="titleInput" maxlength="14" aria-label="Item name (max 14)"/>
            <small id="titleCount">0/14</small>
          </div>
        </div>

        <div class="ws-body">
          <div class="ws-row">
            <div class="ws-label">Legend color</div>
            <div class="ws-inline paletteHead">
              <div class="swatch" id="legendSwatch"></div>
              <span id="hexPreview" style="font-variant-numeric:tabular-nums;color:#64748B"></span>
              <button id="editColorBtn" class="editColor" aria-expanded="false" aria-controls="colorPalette">Edit color</button>
            </div>
            <div id="colorPalette" class="palette" style="display:none">
              <div class="square-wrap" id="svWrap">
                <canvas id="svCanvas"></canvas>
                <div class="knob" id="svKnob" style="left:100%;top:0%"></div>
              </div>
              <div class="hueRow">
                <span class="ws-label">Hue</span>
                <input type="range" id="hue" class="hue" min="0" max="360" value="0"/>
                <span class="num" id="hVal">0</span>
              </div>
              <div class="hueRow">
                <span class="ws-label">HEX</span>
                <input id="hex" style="flex:1; padding:8px 10px; border:1px solid #D7DFEA; border-radius:8px; font:inherit" value="#ff0000" />
              </div>
            </div>
          </div>

          <!-- Scope dropdown -->
          <div class="ws-row">
            <div class="ws-label">Applies to</div>
            <div class="scope-pop">
              <div id="scopeSelect" class="scope-trigger" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="scopeList">
                <strong id="scopeSelLabel">Recurring</strong><span class="chev">▼</span>
              </div>
              <div id="scopeList" class="scope-list" role="listbox" tabindex="-1" aria-label="Choose scope">
                <div class="scope-opt" role="option" data-val="today">Today</div>
                <div class="scope-opt" role="option" data-val="week">This week</div>
                <div class="scope-opt" role="option" data-val="month">This month</div>
                <div class="scope-opt" role="option" data-val="recurring" aria-selected="true">Recurring</div>
              </div>
            </div>
            <div class="scope-hint" id="scopeHint" style="font-size:11px; color:#64748B"></div>
          </div>

          <div class="ws-row">
            <div class="ws-label">Weekly schedule (up to 4 time ranges per day)</div>
            <div id="wsDays"></div>
          </div>
        </div>

        <div class="ws-foot">
          <button class="btn discard" id="discardBtn">Discard</button>
          <button class="btn save" id="saveBtn">Save</button>
        </div>
      </div>
    </div>
    <!-- ===== /overlays ===== -->
  </main>

<!-- ===== NEW SHELL script (kept intact) ===== -->
<script>
  ['pointerdown','click','touchstart'].forEach(ev=>{
    document.body.addEventListener(ev, e=>{
      if(!e.target.closest('.coin')) e.preventDefault();
    }, {passive:false});
  });

  const coins=[...document.querySelectorAll('.coin')];
  function updateRing(el){
    const p = Math.max(0, Math.min(1, parseFloat(el.dataset.progress ?? '0')));
    const arc = el.querySelector('.arc');
    arc.setAttribute('stroke-dasharray','100');
    arc.setAttribute('stroke-dashoffset', (100 - p*100).toFixed(2));
  }
  coins.forEach(updateRing);

  function setActive(target){
    const already = target.classList.contains('active');
    coins.forEach(btn=>{
      const on = !already && btn===target;
      btn.classList.toggle('active', on);
      btn.setAttribute('aria-pressed', String(on));
    });
  }
  document.querySelector('.coins').addEventListener('click', e=>{
    const c=e.target.closest('.coin'); if(!c) return;
    setActive(c);
  });

  const root=document.documentElement;
  let beta=18, gamma=0, sx=0, sy=12;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  function animate(){
    const max=34;
    const tx=clamp((gamma||0)/45, -1, 1)*max;
    const ty=clamp((beta ||0)/45, -1, 1)*max;

    sx = lerp(sx, tx, 0.12);
    sy = lerp(sy, ty+8, 0.12);

    const mag=Math.hypot(sx,sy);
    root.style.setProperty('--sx',  sx.toFixed(1)+'px');
    root.style.setProperty('--sy',  sy.toFixed(1)+'px');
    root.style.setProperty('--sblur', (12 + mag*0.45).toFixed(1)+'px');

    root.style.setProperty('--hx',  (50 - sx*1.1/max*45)+'%');
    root.style.setProperty('--hy',  (22 - sy*0.7/max*45)+'%');

    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  function startMotion(){
    window.addEventListener('deviceorientation', e=>{
      if(e.beta==null||e.gamma==null) return;
      const dz=2.0;
      beta = Math.abs(e.beta)  < dz ? 0 : e.beta;
      gamma= Math.abs(e.gamma) < dz ? 0 : e.gamma;
    }, true);
  }
  (async()=>{
    const btn=document.getElementById('enable');
    try{
      if (typeof DeviceOrientationEvent!=='undefined' &&
          typeof DeviceOrientationEvent.requestPermission==='function'){
        btn.hidden=false;
        btn.onclick=async ()=>{
          try{
            const res=await DeviceOrientationEvent.requestPermission();
            if(res==='granted'){ btn.hidden=true; startMotion(); }
          }catch{}
        };
      }else{ startMotion(); }
    }catch{ startMotion(); }
  })();

  if(!('ontouchstart' in window)){
    window.addEventListener('mousemove', e=>{
      const w=innerWidth, h=innerHeight;
      gamma=(e.clientX/w - 0.5)*90;
      beta =(0.5 - e.clientY/h)*90;
    });
  }

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

<!-- ===== WEEKLY CHART scripts (kept intact) ===== -->
<script>
(()=>{ /* original short IIFE (left intact) */
  const UI_W=360, H16=640, H20=800, AS_MIN=16/9, AS_MAX=20/9;
  const TOP_H=28, CENTER_H=496, DOCK_H=92, MIN_GAP=12;

  const set=(k,v)=>document.documentElement.style.setProperty(k,v);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  function layout(){
    const vw=innerWidth, vh=innerHeight, A=vh/vw;
    const T=clamp(A, AS_MIN, AS_MAX);
    const Ht=lerp(H16, H20, (T-AS_MIN)/(AS_MAX-AS_MIN));
    const free=Ht-(TOP_H+CENTER_H+DOCK_H);
    const gap=Math.max(MIN_GAP, free/2);
    const needed=TOP_H+gap+CENTER_H+gap+DOCK_H;
  }
})();
</script>

<script>
(()=>{ /* main weekly script, unchanged */
  const UI_W=360, H16=640, H20=800, AS_MIN=16/9, AS_MAX=20/9;
  const TOP_H=28, CENTER_H=496, DOCK_H=92, MIN_GAP=12;
  const set=(k,v)=>document.documentElement.style.setProperty(k,v);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  function layout(){
    const vw=innerWidth, vh=innerHeight, A=vh/vw;
    const T=Math.max(AS_MIN, Math.min(AS_MAX, A));
    const Ht=lerp(H16, H20, (T-AS_MIN)/(AS_MAX-AS_MIN));
    const free=Ht-(TOP_H+CENTER_H+DOCK_H);
    const gap=Math.max(MIN_GAP, free/2);
    const needed=TOP_H+gap+CENTER_H+gap+DOCK_H;
    const s=Math.min(vw/UI_W, vh/needed);

    set('--uiw', (UI_W*s)+'px');
    set('--toph', (TOP_H*s)+'px');
    set('--centerh', (CENTER_H*s)+'px');
    set('--dockh', (DOCK_H*s)+'px');
    set('--gapTop', (gap*s)+'px');
    set('--gapBottom', (gap*s)+'px');
    set('--dot', Math.max(4, 6*s)+'px');
    set('--screenPad', Math.round(12*s)+'px');

    set('--grid-margin', (16*s)+'px');
    set('--hour-col', (56*s)+'px');
    set('--label-size', (11*s)+'px');
    set('--date-size', (18*s)+'px');
    set('--dow-h', (16*s)+'px');

    buildWeek();
  }
  addEventListener('resize', ()=>requestAnimationFrame(layout), {passive:true});

  const weekTitle=document.getElementById('weekTitle');
  const dowLabels=document.getElementById('dowLabels');
  const weekHours=document.getElementById('weekHours');
  const weekGrid=document.getElementById('weekGrid');
  const blocksLayer=document.getElementById('blocksLayer');
  const nowMagnify=document.getElementById('nowMagnify');

  document.getElementById('prevWeekBtn').addEventListener('click', ()=>{ setWeek(-1); buildWeek(); });
  document.getElementById('nextWeekBtn').addEventListener('click', ()=>{ setWeek(+1); buildWeek(); });

  const TASKS = [
    {key:'work',      label:'Work',           color:'#D33C36', hard:true},
    {key:'commute',   label:'Commute',        color:'#E86A13', hard:true},
    {key:'chores',    label:'Chores',         color:'#3B41C5', hard:true},
    {key:'errands',   label:'Errands',        color:'#1D8F2E', hard:true},
    {key:'meals',     label:'Meal Time',      color:'#E0B21B'},
    {key:'hygiene',   label:'Hygiene',        color:'#0EA5E9'},
    {key:'selfcare',  label:'Self care',      color:'#A3A3A3'},
    {key:'exercise',  label:'Exercise',       color:'#1DB954'},
    {key:'family',    label:'Family Time',    color:'#E3326B'},
    {key:'hobbies',   label:'Hobbies',        color:'#F39C12'},
    {key:'leisure',   label:'Leisure',        color:'#6B5B95'},
    {key:'school',    label:'School',         color:'#3269E6', hard:true},
    {key:'relax',     label:'Relaxation',     color:'#24C3D6'},
    {key:'free',      label:'Free Time',      color:'#77C043'},
    {key:'routines',  label:'Routines',       color:'#7A5C2E'},
    {key:'sleep',     label:'Sleep',          color:'#6AA6FF'}
  ];
  const COLORS = Object.fromEntries(TASKS.map(t=>[t.key,t.color]));
  const LABELS = Object.fromEntries(TASKS.map(t=>[t.key,t.label]));

  const SLOTS_PER_DAY=96;
  let allSlots = Array.from({length:7}, ()=>Array(SLOTS_PER_DAY).fill(null));
  const EXACT = Object.fromEntries(TASKS.map(t=>[t.key, Array.from({length:7},()=>[])]));
  const EXCEPTIONS = { byDate:{}, byWeek:{}, byMonth:{} };
  const LAST_SCOPE = {};
  let SAVE_SEQ = 1;
  const ORDER = { recurring:{}, week:{}, month:{} };

  let weekOffset=0;
  let visibleWeekFirst=null;
  let magTimer=null;

  const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const SHORT_DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function fmtDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function fmtMonthKey(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}`; }
  function fmtWeekKey(firstDate){ return fmtDate(firstDate); }

  function round15(min){ return Math.round(min/15)*15; }
  function minsToSlot(min){ return Math.max(0, Math.min(96, Math.round(min/15))); }

  function mergeDay(day){ const segs=[]; let i=0; while(i<SLOTS_PER_DAY){ const c=day[i]; let j=i+1; while(j<SLOTS_PER_DAY && day[j]===c) j++; segs.push({cat:c,startSlot:i,len:j-i}); i=j;} return segs; }

  function computeGeometry(){
    const r=weekGrid.getBoundingClientRect();
    const totalW=Math.round(r.width), totalH=Math.round(r.height);
    const colWBase=Math.floor(totalW/7), extraW=totalW-colWBase*7;
    const rowHBase=Math.floor(totalH/24), extraH=totalH-rowHBase*24;
    const colW=[], colX=[0]; for(let c=0;c<7;c++){ const w=colWBase+(c<extraW?1:0); colW.push(w); colX.push(colX[c]+w); }
    const rowH=[], rowY=[0]; for(let rI=0;rI<24;rI++){ const h=rowHBase+(rI<extraH?1:0); rowH.push(h); rowY.push(rowY[rI]+h); }
    const slotHeightsPerHour=[]; for(let hr=0; hr<24; hr++){ const h=rowH[hr], base=Math.floor(h/4), extra=h-base*4; const parts=[base,base,base,base]; const start=hr%4; for(let k=0;k<extra;k++) parts[(start+k)%4]+=1; slotHeightsPerHour.push(parts); }
    const slotY=[0]; for(let hr=0; hr<24; hr++){ for(let q=0; q<4; q++) slotY.push(slotY[slotY.length-1]+slotHeightsPerHour[hr][q]); }
    return {totalW,totalH,colW,colX,rowH,rowY,slotY};
  }

  function paintBlocks(slots, geom){
    const { colX, slotY } = geom;
    blocksLayer.innerHTML='';
    for(let d=0; d<7; d++){
      const segs=mergeDay(slots[d]);
      segs.forEach(seg=>{
        if(!seg.cat) return;
        const left=colX[d], right=colX[d+1];
        const top=slotY[seg.startSlot], bottom=slotY[seg.startSlot+seg.len];
        const div=document.createElement('div'); div.className='blk';
        div.style.background = COLORS[seg.cat] || '#E8EEF6';
        div.style.left=left+'px'; div.style.top=top+'px';
        div.style.width=Math.max(0,(d===6?right-left-1:right-left))+'px';
        div.style.height=(bottom-top)+'px';
        blocksLayer.appendChild(div);
      });
    }
  }

  function buildMask(geom){
    const svg=document.getElementById('maskSVG'); svg.innerHTML='';
    const surface=getComputedStyle(document.documentElement).getPropertyValue('--surface').trim()||'#F4F6F9';
    const { totalW, totalH, colW, colX, rowH, rowY } = geom;
    svg.setAttribute('width', totalW); svg.setAttribute('height', totalH);
    svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`); svg.setAttribute('preserveAspectRatio','none');
    const NS='http://www.w3.org/2000/svg';
    const defs=document.createElementNS(NS,'defs'); const sym=document.createElementNS(NS,'symbol');
    sym.setAttribute('id','tile'); sym.setAttribute('viewBox','0 0 900 300'); sym.setAttribute('preserveAspectRatio','none');
    const r=(x,y,w,h)=>{const e=document.createElementNS(NS,'rect'); e.setAttribute('x',x); e.setAttribute('y',y); e.setAttribute('width',w); e.setAttribute('height',h); e.setAttribute('fill',surface); return e;};
    const p=(pts)=>{const e=document.createElementNS(NS,'polygon'); e.setAttribute('points',pts); e.setAttribute('fill',surface); return e;};
    sym.appendChild(r(0,0,900,24)); sym.appendChild(r(0,276,900,24)); sym.appendChild(r(0,0,24,300)); sym.appendChild(r(876,0,24,300));
    sym.appendChild(r(24,69,852,24)); sym.appendChild(r(24,138,852,24)); sym.appendChild(r(24,207,852,24));
    sym.appendChild(p('23,23 61,23 23,61')); sym.appendChild(p('877,23 839,23 877,61')); sym.appendChild(p('23,277 61,277 23,239')); sym.appendChild(p('877,277 839,277 877,239'));
    defs.appendChild(sym); svg.appendChild(defs);
    for(let rI=0;rI<24;rI++){ for(let cI=0;cI<7;cI++){ const use=document.createElementNS(NS,'use'); use.setAttribute('href','#tile'); use.setAttribute('x',colX[cI]); use.setAttribute('y',rowY[rI]); use.setAttribute('width',colW[cI]); use.setAttribute('height',rowH[rI]); svg.appendChild(use); } }
  }

  function formatWeekTitle(first,last){
    const m=new Intl.DateTimeFormat(undefined,{month:'short'});
    if(first.getFullYear()===last.getFullYear()){
      if(first.getMonth()===last.getMonth()){
        return `${m.format(first)} ${first.getDate()} – ${last.getDate()}, ${first.getFullYear()}`;
      }
      return `${m.format(first)} ${first.getDate()} – ${m.format(last)} ${last.getDate()}, ${first.getFullYear()}`;
    }
    return `${m.format(first)} ${first.getDate()}, ${first.getFullYear()} – ${m.format(last)} ${last.getDate()}, ${last.getFullYear()}`;
  }

  function setWeek(delta=0){
    weekOffset+=delta;
    const today=new Date();
    const first=new Date(today); first.setDate(today.getDate()-today.getDay()+weekOffset*7); first.setHours(0,0,0,0);
    const last=new Date(first); last.setDate(first.getDate()+6);
    visibleWeekFirst = first;
    weekTitle.textContent = formatWeekTitle(first,last);
  }

  function renderMagnifier(geom){
    const today=startOfDay(new Date());
    const visStart=startOfDay(visibleWeekFirst);
    const visEnd=startOfDay(addDays(visibleWeekFirst,6));
    if(today < visStart || today > visEnd){
      nowMagnify.style.display='none';
      if(magTimer){ clearTimeout(magTimer); magTimer=null; }
      return;
    }
    const { colW, colX, rowY, totalH } = geom;
    const now=new Date(); const dow=now.getDay(); const minutes=now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
    const hour=Math.floor(minutes/60);
    const hourTop=rowY[hour]; const hourH=rowY[hour+1]-rowY[hour];
    const extra = Math.min(10, Math.floor(hourH*0.25));
    const top = Math.max(0, Math.min(totalH - (hourH+extra), hourTop - Math.floor(extra/2)));
    const height = Math.min(totalH - top, hourH + extra);
    const left=colX[dow]; const width=(dow===6)?Math.max(0,colW[dow]-1):colW[dow];
    nowMagnify.style.left=left+'px'; nowMagnify.style.top=top+'px';
    nowMagnify.style.width=width+'px'; nowMagnify.style.height=height+'px';
    nowMagnify.style.display='block';
    if(magTimer) clearTimeout(magTimer);
    magTimer=setTimeout(()=>renderMagnifier(computeGeometry()), 10000);
  }

  function buildWeek(){
    if(!visibleWeekFirst) setWeek(0);
    const names=SHORT_DOW; dowLabels.innerHTML=''; names.forEach(n=>{const el=document.createElement('div'); el.className='dow-label'; el.textContent=n; dowLabels.appendChild(el);});
    const geom=computeGeometry();
    weekHours.innerHTML='';
    for(let i=0;i<24;i++){
      const d=document.createElement('div'); d.className='hour-stamp';
      d.textContent=String(i).padStart(2,'0')+':00';
      d.style.top=((geom.rowY[i]+geom.rowY[i+1])/2)+'px';
      weekHours.appendChild(d);
    }
    rebuildSlotsForVisibleWeek();
    paintBlocks(allSlots, geom); buildMask(geom); renderMagnifier(geom);
  }

  function deepCopyExact(ex){ return ex.map(dayArr => dayArr.map(r => ({startMin:r.startMin,endMin:r.endMin}))); }

  function getEffectiveExactForTask(taskKey){
    let eff = deepCopyExact(EXACT[taskKey]);
    const wkKey = fmtWeekKey(visibleWeekFirst);
    const moKey = fmtMonthKey(visibleWeekFirst);
    const weekOverride = EXCEPTIONS.byWeek[wkKey]?.[taskKey];
    const monthOverride = EXCEPTIONS.byMonth[moKey]?.[taskKey];
    if(monthOverride) eff = deepCopyExact(monthOverride);
    if(weekOverride)  eff = deepCopyExact(weekOverride);
    for(let d=0; d<7; d++){
      const dateKey = fmtDate(addDays(visibleWeekFirst,d));
      const dayOverride = EXCEPTIONS.byDate[dateKey]?.[taskKey];
      if(dayOverride) eff[d] = dayOverride.map(r=>({startMin:r.startMin,endMin:r.endMin}));
    }
    return eff;
  }

  function applyRangesToSlots(cat, exact){
    for(let d=0; d<7; d++){
      (exact[d]||[]).forEach(R=>{
        let a=round15(R.startMin), b=round15(R.endMin);
        if(b===a){ return; }
        if(b>a){
          let sa=minsToSlot(a), sb=minsToSlot(b);
          for(let s=sa; s<sb; s++) if(allSlots[d][s]===null) allSlots[d][s]=cat;
        } else {
          let sa=minsToSlot(a), sb=minsToSlot(24*60);
          for(let s=sa; s<sb; s++) if(allSlots[d][s]===null) allSlots[d][s]=cat;
          const dn=(d+1)%7;
          let sa2=minsToSlot(0), sb2=minsToSlot(b);
          if(dn>=0 && dn<7){ for(let s=sa2; s<sb2; s++) if(allSlots[dn][s]===null) allSlots[dn][s]=cat; }
        }
      });
    }
  }

  function rebuildSlotsForVisibleWeek(){
    allSlots = Array.from({length:7}, ()=>Array(SLOTS_PER_DAY).fill(null));
    const wkKey = fmtWeekKey(visibleWeekFirst);
    const moKey = fmtMonthKey(visibleWeekFirst);
    const seqForTask = (taskKey)=>{
      const seqs=[ORDER.week[wkKey]?.[taskKey], ORDER.month[moKey]?.[taskKey], ORDER.recurring?.[taskKey]];
      return seqs.filter(x=>typeof x==='number').sort((a,b)=>a-b)[0] ?? 1e9;
    };
    const ordered = [...TASKS.map(t=>t.key)].sort((a,b)=>seqForTask(a)-seqForTask(b));
    for(const key of ordered){
      const eff = getEffectiveExactForTask(key);
      applyRangesToSlots(key, eff);
    }
  }

  (function enableTapSwipe(){
    const el=document.getElementById('weekContent');
    let y0=0,t0=0,moved=false; const THRESH=26, SPEED=0.22;
    function start(e){ moved=false; y0=('touches'in e)?e.touches[0].clientY:e.clientY; t0=performance.now(); }
    function move(e){ const y1=('touches'in e)?e.touches[0].clientY:e.clientY; if(Math.abs(y1-y0)>6) moved=true; }
    function end(e){
      const y1=('changedTouches'in e)?e.changedTouches[0].clientY:e.clientY; const dy=y1-y0; const dt=Math.max(1,performance.now()-t0);
      const v=Math.abs(dy)/dt;
      if(Math.abs(dy)>THRESH && v>SPEED){
        setWeek(dy<0 ? +1 : -1);
        buildWeek();
        return;
      }
      if(!moved) showTasks();
    }
    el.addEventListener('touchstart', start, {passive:true}); el.addEventListener('touchmove', move, {passive:true}); el.addEventListener('touchend', end, {passive:true});
    el.addEventListener('pointerdown', start); el.addEventListener('pointermove', move); el.addEventListener('pointerup', end);
  })();

  function totalMinutesForVisibleWeek(key){
    let count=0;
    for(let d=0; d<7; d++){ for(let s=0; s<SLOTS_PER_DAY; s++){ if(allSlots[d][s]===key) count++; } }
    return count*15;
  }
  function formatMinutes(min){
    if(min<=0) return '';
    if(min<60) return `${min}m`;
    if(min%60===0) return `${Math.round(min/60)}h`;
    const hours=Math.floor(min/60);
    const rem=min - hours*60;
    const q=rem/15; const map={1:'.25',2:'.5',3:'.75'};
    return `${hours}${map[q]||''}h`;
  }

  const overlay=document.getElementById('taskOverlay');
  const container=document.getElementById('taskContainer');
  let overlayArmed=false;

  function buildTasks(){
    container.innerHTML='';
    TASKS.forEach((t,i)=>{
      const btn=document.createElement('button');
      btn.className='task-btn'; btn.dataset.key=t.key; btn.style.animationDelay=(i*20)+'ms';
      const dur=formatMinutes(totalMinutesForVisibleWeek(t.key));
      const durHTML = dur ? `<span class="dur">· ${dur}</span>` : '';
      btn.innerHTML = `<span class="task-dot" style="background:${COLORS[t.key]}"></span>
                       <span class="task-label"><span class="name">${LABELS[t.key]}</span>${durHTML}</span>`;
      btn.addEventListener('click', ()=>{ if(!overlayArmed) return; openSettings(t.key); });
      container.appendChild(btn);
    });
  }
  function refreshOneTaskButton(key){
    if(overlay.style.display!=='block') return;
    const btn=document.querySelector(`.task-btn[data-key="${key}"]`);
    if(!btn) return;
    const nameSpan=btn.querySelector('.name');
    const dot=btn.querySelector('.task-dot');
    if(nameSpan) nameSpan.textContent = LABELS[key];
    if(dot) dot.style.background = COLORS[key];
    const label=btn.querySelector('.task-label');
    const oldDur=label.querySelector('.dur'); if(oldDur) oldDur.remove();
    const dur=formatMinutes(totalMinutesForVisibleWeek(key));
    if(dur){ const span=document.createElement('span'); span.className='dur'; span.textContent=`· ${dur}`; label.appendChild(span); }
  }

  function showTasks(){
    buildTasks();
    overlay.classList.remove('hide'); overlay.classList.add('show'); overlay.style.display='block';
    overlayArmed=false;
    setTimeout(()=>{ overlayArmed=true; }, 250);
  }
  function hideTasks(){
    overlay.classList.remove('show'); overlay.classList.add('hide');
    [...container.children].forEach((c,i)=>c.style.animationDelay = ((container.children.length-1-i)*18)+'ms');
    setTimeout(()=>{ overlay.style.display='none'; }, 220);
  }
  overlay.querySelector('.backdrop').addEventListener('click', hideTasks);

  const settingsOverlay=document.getElementById('settingsOverlay');
  const legendSwatch=document.getElementById('legendSwatch');
  const hexPreview=document.getElementById('hexPreview');
  const svCanvas=document.getElementById('svCanvas');
  const svWrap=document.getElementById('svWrap');
  const svKnob=document.getElementById('svKnob');
  const hue=document.getElementById('hue');
  const hVal=document.getElementById('hVal');
  const hexField=document.getElementById('hex');
  const wsDays=document.getElementById('wsDays');
  const titleInput=document.getElementById('titleInput');
  const titleCount=document.getElementById('titleCount');
  const scopeSelect=document.getElementById('scopeSelect');
  const scopeList=document.getElementById('scopeList');
  const scopeSelLabel=document.getElementById('scopeSelLabel');
  const scopeHint=document.getElementById('scopeHint');

  let currentKey='work';
  let color={h:0,s:1,v:1};

  function togglePalette(open){
    const pal=document.getElementById('colorPalette');
    const btn=document.getElementById('editColorBtn');
    if(open===undefined) open = pal.style.display==='none';
    pal.style.display = open ? 'grid' : 'none';
    btn.setAttribute('aria-expanded', open?'true':'false');
    if(open){
      resizeSV(); drawSV(); placeKnob();
      setTimeout(()=>hexField.focus(), 0);
    } else {
      scopeSelect.focus();
    }
  }
  document.getElementById('editColorBtn').addEventListener('click', ()=>togglePalette());

  function openSettings(key){
    currentKey=key;
    titleInput.value = LABELS[key] || '';
    titleCount.textContent = `${titleInput.value.length}/14`;
    const rgb = parseCSSColor(COLORS[key]) || {r:211,g:60,b:54};
    color = rgbToHsv(rgb.r,rgb.g,rgb.b);
    legendSwatch.style.background = `rgb(${rgb.r},${rgb.g},${rgb.b})`;
    hexPreview.textContent = rgbToHex(rgb.r,rgb.g,rgb.b).toUpperCase();
    hexField.value = rgbToHex(rgb.r,rgb.g,rgb.b);
    document.getElementById('colorPalette').style.display='none';
    document.getElementById('editColorBtn').setAttribute('aria-expanded','false');

    const active = activeScopeForTask(currentKey);
    const preferred = LAST_SCOPE[currentKey] || active;
    setScope(preferred);
    buildDaysFromExact(getExactForScope(currentKey, preferred));

    settingsOverlay.classList.remove('hide'); settingsOverlay.classList.add('show'); settingsOverlay.style.display='block';
  }
  function closeSettings(){ settingsOverlay.classList.remove('show'); settingsOverlay.classList.add('hide'); setTimeout(()=>{ settingsOverlay.style.display='none'; }, 170); }
  document.getElementById('discardBtn').addEventListener('click', closeSettings);

  scopeSelect.addEventListener('click', ()=>{
    const open = scopeList.style.display!=='block';
    scopeList.style.display = open ? 'block' : 'none';
    scopeSelect.setAttribute('aria-expanded', open?'true':'false');
    if(open) scopeList.focus();
  });
  document.addEventListener('click', (e)=>{
    if(!settingsOverlay.contains(e.target)) return;
    if(!scopeSelect.contains(e.target) && !scopeList.contains(e.target)){
      scopeList.style.display='none'; scopeSelect.setAttribute('aria-expanded','false');
    }
  });
  scopeList.addEventListener('click', (e)=>{
    const opt=e.target.closest('.scope-opt'); if(!opt) return;
    const val=opt.dataset.val;
    if(opt.getAttribute('aria-disabled')==='true') return;
    setScope(val);
    buildDaysFromExact(getExactForScope(currentKey, val));
    scopeList.style.display='none'; scopeSelect.setAttribute('aria-expanded','false');
  });

  function setScope(val){
    scopeSelLabel.textContent = ({today:'Today',week:'This week',month:'This month',recurring:'Recurring'})[val]||'Recurring';
    [...scopeList.querySelectorAll('.scope-opt')].forEach(o=>{
      o.setAttribute('aria-selected', o.dataset.val===val ? 'true' : 'false');
    });
    const today=new Date(); const visStart=startOfDay(visibleWeekFirst), visEnd=startOfDay(addDays(visibleWeekFirst,6));
    const isCurrentWeek = startOfDay(today) >= visStart && startOfDay(today) <= visEnd;
    const todayOpt = scopeList.querySelector('.scope-opt[data-val="today"]');
    if(todayOpt) todayOpt.setAttribute('aria-disabled', isCurrentWeek?'false':'true');

    updateScopeUI(val);
  }
  function getScope(){
    return ({'Today':'today','This week':'week','This month':'month','Recurring':'recurring'})[scopeSelLabel.textContent] || 'recurring';
  }
  function updateScopeUI(scopeVal){
    const scope = scopeVal || getScope();
    const {index, date} = getTodayTargetInVisibleWeek();
    const dateFmt = date.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'});
    scopeHint.textContent = scope==='today' ? `for ${DAY_NAMES[index]}, ${dateFmt}` :
                            scope==='week' ? `week of ${fmtDate(visibleWeekFirst)}` :
                            scope==='month' ? `for ${fmtMonthKey(visibleWeekFirst)}` : 'applies every week';

    wsDays.querySelectorAll('.day-row').forEach((row,i)=>{
      const disabled = (scope==='today' && i!==index);
      row.classList.toggle('disabled', disabled);
      row.querySelectorAll('input,button').forEach(el=>{
        if(el.classList.contains('del') || el.classList.contains('addSlot') || el.type==='time'){
          el.disabled = disabled;
        }
      });
    });
  }

  function getTodayTargetInVisibleWeek(){
    const today=new Date(); today.setHours(0,0,0,0);
    const visStart=startOfDay(visibleWeekFirst);
    const isCurrentWeek = today>=visStart && today<=startOfDay(addDays(visStart,6));
    if(isCurrentWeek){ return {date:today, index:today.getDay()}; }
    return {date:new Date(visStart), index:0};
  }

  function activeScopeForTask(taskKey){
    const wkKey = fmtWeekKey(visibleWeekFirst);
    const moKey = fmtMonthKey(visibleWeekFirst);
    const today = new Date(); today.setHours(0,0,0,0);
    const todayKey = fmtDate(today);

    if(EXCEPTIONS.byDate[todayKey]?.[taskKey]) return 'today';
    if(EXCEPTIONS.byWeek[wkKey]?.[taskKey]) return 'week';
    if(EXCEPTIONS.byMonth[moKey]?.[taskKey]) return 'month';
    return 'recurring';
  }

  function getExactForScope(taskKey, scope){
    if(scope==='recurring') return deepCopyExact(EXACT[taskKey]);

    if(scope==='week'){
      const wkKey = fmtWeekKey(visibleWeekFirst);
      const set = EXCEPTIONS.byWeek[wkKey]?.[taskKey];
      if(set) return deepCopyExact(set);
      return deepCopyExact(EXACT[taskKey]);
    }

    if(scope==='month'){
      const moKey = fmtMonthKey(visibleWeekFirst);
      const set = EXCEPTIONS.byMonth[moKey]?.[taskKey];
      if(set) return deepCopyExact(set);
      return deepCopyExact(EXACT[taskKey]);
    }

    const out = Array.from({length:7},()=>[]);
    const {index} = getTodayTargetInVisibleWeek();
    const dateKey = fmtDate(addDays(visibleWeekFirst, index));
    const set = EXCEPTIONS.byDate[dateKey]?.[taskKey];
    if(set){
      out[index] = set.map(r=>({startMin:r.startMin,endMin:r.endMin}));
    } else {
      const eff = getEffectiveExactForTask(taskKey);
      out[index] = eff[index].map(r=>({startMin:r.startMin,endMin:r.endMin}));
    }
    return out;
  }

  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const newName=titleInput.value.trim(); if(newName){ LABELS[currentKey]=newName; }
    const hex = rgbToHex(...Object.values(hsvToRgb(color.h,color.s,color.v))); COLORS[currentKey]=hex;

    const scope = getScope();
    LAST_SCOPE[currentKey] = scope;

    const clipResult = collectNormalizeAndClip(scope, currentKey);

    if(scope==='recurring'){
      EXACT[currentKey] = clipResult.week;
      ORDER.recurring[currentKey] = ORDER.recurring[currentKey] || (SAVE_SEQ++);
    } else if(scope==='week'){
      const wkKey = fmtWeekKey(visibleWeekFirst);
      EXCEPTIONS.byWeek[wkKey] = EXCEPTIONS.byWeek[wkKey] || {};
      EXCEPTIONS.byWeek[wkKey][currentKey] = clipResult.week;
      ORDER.week[wkKey] = ORDER.week[wkKey] || {};
      ORDER.week[wkKey][currentKey] = ORDER.week[wkKey][currentKey] || (SAVE_SEQ++);
    } else if(scope==='month'){
      const moKey = fmtMonthKey(visibleWeekFirst);
      EXCEPTIONS.byMonth[moKey] = EXCEPTIONS.byMonth[moKey] || {};
      EXCEPTIONS.byMonth[moKey][currentKey] = clipResult.week;
      ORDER.month[moKey] = ORDER.month[moKey] || {};
      ORDER.month[moKey][currentKey] = ORDER.month[moKey][currentKey] || (SAVE_SEQ++);
    } else {
      const {date, index} = getTodayTargetInVisibleWeek();
      const dateKey = fmtDate(date);
      const nextKey = fmtDate(addDays(date,1));
      const todayRanges = clipResult.week[index] || [];
      const spillRanges = clipResult.spillNextDay || [];

      if(todayRanges.length){
        EXCEPTIONS.byDate[dateKey] = EXCEPTIONS.byDate[dateKey] || {};
        EXCEPTIONS.byDate[dateKey][currentKey] = todayRanges;
      } else if(EXCEPTIONS.byDate[dateKey]?.[currentKey]){
        delete EXCEPTIONS.byDate[dateKey][currentKey];
        if(Object.keys(EXCEPTIONS.byDate[dateKey]).length===0) delete EXCEPTIONS.byDate[dateKey];
      }

      if(spillRanges.length){
        EXCEPTIONS.byDate[nextKey] = EXCEPTIONS.byDate[nextKey] || {};
        EXCEPTIONS.byDate[nextKey][currentKey] = spillRanges;
      } else if(EXCEPTIONS.byDate[nextKey]?.[currentKey]){
        delete EXCEPTIONS.byDate[nextKey][currentKey];
        if(Object.keys(EXCEPTIONS.byDate[nextKey]).length===0) delete EXCEPTIONS.byDate[nextKey];
      }
    }

    buildWeek();
    buildTasks();
    reflectSavedIntoEditor(scope, currentKey, clipResult);

    closeSettings();
  });

  function reflectSavedIntoEditor(scope, key, clipResult){
    refreshOneTaskButton(key);
  }

  titleInput.addEventListener('input', ()=>{
    if(titleInput.value.length>14) titleInput.value=titleInput.value.slice(0,14);
    titleCount.textContent=`${titleInput.value.length}/14`;
  });

  function buildDaysFromExact(exact){
    wsDays.innerHTML='';
    for(let d=0; d<7; d++){
      const wrap=document.createElement('div'); wrap.className='day-row'; wrap.dataset.day=d;
      wrap.innerHTML = `
        <div class="day-header">
          <div class="ws-title" style="font-weight:800;display:flex;align-items:center;gap:8px">
            ${DAY_NAMES[d]} <span class="overnight" style="display:none">→ next day</span> <span class="clipNote"></span>
          </div>
          <button class="addSlot" title="Add range">+</button>
        </div>
        <div class="slots"></div>`;
      const slots=wrap.querySelector('.slots'); const addBtn=wrap.querySelector('.addSlot');
      function addSlot(startMin=9*60, endMin=12*60){
        if(slots.children.length>=4) return;
        const row=document.createElement('div'); row.className='slot';
        const sv=minsToHHMM(startMin), ev=minsToHHMM(endMin);
        row.innerHTML = `<input type="time" step="60" value="${sv}"><input type="time" step="60" value="${ev}"><button class="del" title="Remove">🗑️</button>`;
        const [a,b]=row.querySelectorAll('input');
        const badge=wrap.querySelector('.overnight');
        function updateBadge(){
          const [sh,sm]=a.value.split(':').map(Number);
          const [eh,em]=b.value.split(':').map(Number);
          const isOver = (eh*60+em) < (sh*60+sm);
          badge.style.display = isOver ? 'inline-block' : (Array.from(slots.children).some(c=>{
            const [ax,bx]=c.querySelectorAll('input');
            const [sh2,sm2]=ax.value.split(':').map(Number);
            const [eh2,em2]=bx.value.split(':').map(Number);
            return (eh2*60+eh2) < (sh2*60+sm2);
          }) ? 'inline-block' : 'none');
        }
        a.addEventListener('input', updateBadge);
        b.addEventListener('input', updateBadge);
        row.querySelector('.del').addEventListener('click', ()=>{ row.remove(); updateBadge(); });
        slots.appendChild(row);
        updateBadge();
      }
      (exact[d]||[]).forEach(r=>addSlot(r.startMin, r.endMin));
      addBtn.addEventListener('click', ()=>addSlot());
      wsDays.appendChild(wrap);
    }
    updateScopeUI();
  }

  function minsToHHMM(m){ const h=Math.floor(m/60), mm=String(m%60).padStart(2,'0'); return `${String(h).padStart(2,'0')}:${mm}`; }

  function ensureSevenDays(arr){
    if (!Array.isArray(arr)) return Array.from({length:7},()=>[]);
    return Array.from({length:7}, (_,i)=>Array.isArray(arr[i]) ? arr[i] : []);
  }

  function collectNormalizeAndClip(scope, taskKey){
    const collected = Array.from({length:7},()=>[]);
    wsDays.querySelectorAll('.day-row').forEach((row,d)=>{
      if(row.classList.contains('disabled')) return;
      const slots=[...row.querySelectorAll('.slot')];
      slots.forEach(s=>{
        const [a,b]=s.querySelectorAll('input');
        const [sh,sm]=a.value.split(':').map(Number);
        const [eh,em]=b.value.split(':').map(Number);
        collected[d].push({startMin:sh*60+sm, endMin:eh*60+em});
      });
    });

    const normalized = Array.from({length:7},()=>[]);
    let hasOvernight=false;
    for(let d=0; d<7; d++){
      for(const r of collected[d]){
        let s=r.startMin, e=r.endMin;
        if(e> s){
          s=round15(s); e=round15(e);
          if(e>s) normalized[d].push({startMin:s,endMin:e});
        } else if(e< s){
          hasOvernight=true;
          let s1=round15(s), e1=round15(24*60); if(e1>s1) normalized[d].push({startMin:s1,endMin:e1});
          let s2=round15(0), e2=round15(e);
          const dn=(d+1)%7; if(e2>s2) normalized[dn].push({startMin:s2,endMin:e2});
        }
      }
    }

    const occupancy = buildOccupancyMapForVisibleWeek(taskKey);

    const clipped = Array.from({length:7},()=>[]);
    for(let d=0; d<7; d++){
      const req = Array(SLOTS_PER_DAY).fill(false);
      for(const r of normalized[d]){
        const a=minsToSlot(r.startMin), b=minsToSlot(r.endMin);
        for(let s=a; s<b; s++) req[s]=true;
      }
      let s=0;
      while(s<SLOTS_PER_DAY){
        while(s<SLOTS_PER_DAY && (!req[s] || !(occupancy[d][s]===null || occupancy[d][s]===taskKey))) s++;
        if(s>=SLOTS_PER_DAY) break;
        let e=s+1;
        while(e<SLOTS_PER_DAY && req[e] && (occupancy[d][e]===null || occupancy[d][e]===taskKey)) e++;
        const startMin=s*15, endMin=e*15;
        if(endMin>startMin) clipped[d].push({startMin:startMin, endMin:endMin});
        s=e+0;
      }
      clipped[d].sort((A,B)=>A.startMin-B.startMin);
      const merged=[];
      for(const r of clipped[d]){
        if(!merged.length) merged.push(r);
        else{
          const last=merged[merged.length-1];
          if(r.startMin<=last.endMin) last.endMin=Math.max(last.endMin,r.endMin);
          else merged.push(r);
        }
      }
      if(merged.length>4) merged.length=4;
      clipped[d]=merged;
    }

    let spillNextDay=[];
    if(scope==='today' && hasOvernight){
      const {index}=getTodayTargetInVisibleWeek();
      const dn=(index+1)%7;
      spillNextDay = clipped[dn] || [];
    }

    return { week:ensureSevenDays(clipped), spillNextDay };
  }

  function buildOccupancyMapForVisibleWeek(excludeTaskKey){
    const occ = Array.from({length:7},()=>Array(SLOTS_PER_DAY).fill(null));
    const wkKey = fmtWeekKey(visibleWeekFirst);
    const moKey = fmtMonthKey(visibleWeekFirst);
    const seqForTask = (taskKey)=>{
      const seqs=[ORDER.week[wkKey]?.[taskKey], ORDER.month[moKey]?.[taskKey], ORDER.recurring?.[taskKey]];
      return seqs.filter(x=>typeof x==='number').sort((a,b)=>a-b)[0] ?? 1e9;
    };
    const ordered = [...TASKS.map(t=>t.key)].sort((a,b)=>seqForTask(a)-seqForTask(b));
    for(const key of ordered){
      if(key===excludeTaskKey) continue;
      const eff = getEffectiveExactForTask(key);
      for(let d=0; d<7; d++){
        for(const r of eff[d]){
          let a=minsToSlot(round15(r.startMin)), b=minsToSlot(round15(r.endMin));
          if(b===a) continue;
          if(b>a){
            for(let s=a; s<b; s++) if(occ[d][s]===null) occ[d][s]=key;
          }else{
            for(let s=a; s<96; s++) if(occ[d][s]===null) occ[d][s]=key;
            const dn=(d+1)%7;
            for(let s=0; s<b; s++) if(occ[dn][s]===null) occ[dn][s]=key;
          }
        }
      }
    }
    return occ;
  }

  const svCtx=svCanvas.getContext('2d');
  function resizeSV(){ const dpr=window.devicePixelRatio||1; const r=svWrap.getBoundingClientRect();
    svCanvas.width=Math.round(r.width*dpr); svCanvas.height=Math.round(r.height*dpr);
    svCanvas.style.width=r.width+'px'; svCanvas.style.height=r.height+'px'; drawSV(); placeKnob(); }
  new ResizeObserver(resizeSV).observe(svWrap);

  function drawSV(){ const w=svCanvas.width, h=svCanvas.height; const pure=hsvToCss(color.h,1,1);
    svCtx.clearRect(0,0,w,h); svCtx.fillStyle=pure; svCtx.fillRect(0,0,w,h);
    const gW=svCtx.createLinearGradient(0,0,w,0); gW.addColorStop(0,'#fff'); gW.addColorStop(1,'rgba(255,255,255,0)'); svCtx.fillStyle=gW; svCtx.fillRect(0,0,w,h);
    const gB=svCtx.createLinearGradient(0,0,0,h); gB.addColorStop(0,'rgba(0,0,0,0)'); gB.addColorStop(1,'#000'); svCtx.fillStyle=gB; svCtx.fillRect(0,0,w,h); }
  function placeKnob(){ const r=svWrap.getBoundingClientRect(); svKnob.style.left=(color.s*r.width)+'px'; svKnob.style.top=((1-color.v)*r.height)+'px'; }
  function syncUIFromHSV(){ hue.value=Math.round(color.h); hVal.textContent=hue.value; const css=hsvToCss(color.h,color.s,color.v); const hex=rgbToHex(...Object.values(hsvToRgb(color.h,color.s,color.v)));
    legendSwatch.style.background=css; hexPreview.textContent=hex.toUpperCase(); hexField.value=hex; drawSV(); placeKnob(); }
  hue.addEventListener('input', e=>{ color.h=Number(e.target.value); hVal.textContent=e.target.value; drawSV(); const hex=rgbToHex(...Object.values(hsvToRgb(color.h,color.s,color.v))); legendSwatch.style.background=hsvToCss(color.h,color.s,color.v); hexPreview.textContent=hex.toUpperCase(); hexField.value=hex; });
  function setSVFromEvent(ev){ const r=svWrap.getBoundingClientRect(); const cx=('touches'in ev)?ev.touches[0].clientX:ev.clientX; const cy=('touches'in ev)?ev.touches[0].clientY:e.clientY;
    const x=clamp(cx-r.left,0,r.width), y=clamp(cy-r.top,0,r.height); color.s=x/r.width; color.v=1-y/r.height; placeKnob();
    const hex=rgbToHex(...Object.values(hsvToRgb(color.h,color.s,color.v))); legendSwatch.style.background=hsvToCss(color.h,color.s,color.v); hexPreview.textContent=hex.toUpperCase(); hexField.value=hex; }
  svWrap.addEventListener('mousedown',(e)=>{ setSVFromEvent(e); window.addEventListener('mousemove', setSVFromEvent); });
  window.addEventListener('mouseup',()=>window.removeEventListener('mousemove', setSVFromEvent));
  svWrap.addEventListener('touchstart', setSVFromEvent, {passive:true}); svWrap.addEventListener('touchmove', setSVFromEvent, {passive:true});
  hexField.addEventListener('change', ()=>{ const c=parseCSSColor(hexField.value); if(!c) return; color = rgbToHsv(c.r,c.g,c.b); syncUIFromHSV(); });

  function hsvToRgb(h,s,v){ const c=v*s,x=c*(1-Math.abs((h/60)%2-1)),m=v-c; let r1=0,g1=0,b1=0;
    if(0<=h&&h<60){r1=c;g1=x;} else if(60<=h&&h<120){r1=x;g1=c;} else if(120<=h&&h<180){g1=c;b1=x;}
    else if(180<=h&&h<240){g1=x;b1=c;} else if(240<=h&&h<300){r1=x;b1=c;} else {r1=c;b1=x;}
    const r=Math.round((r1+m)*255), g=Math.round((g1+m)*255), b=Math.round((b1+m)*255); return {r,g,b}; }
  function hsvToCss(h,s,v){ const {r,g,b}=hsvToRgb(h,s,v); return `rgb(${r}, ${g}, ${b})`; }
  function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }
  function hexToRgb(hex){ const s=String(hex).trim().replace('#',''); if(/^([0-9a-f]{6})$/i.test(s)){ const n=parseInt(s,16); return {r:(n>>16)&255,g:(n>>8)&255,b:(n)&255}; } if(/^([0-9a-f]{3})$/i.test(s)){ const [r,g,b]=s.split('').map(ch=>parseInt(ch+ch,16)); return {r,g,b}; } return null; }
  function parseCSSColor(str){ if(!str) return null; const t=str.trim(); const h=hexToRgb(t); if(h) return h; const m=t.match(/^rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*[\d.]+)?\s*\)$/i); if(m) return {r:Math.round(+m[1]), g:Math.round(+m[2]), b:Math.round(+m[3])}; return null; }
  function rgbToHsv(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min; let h=0; if(d!==0){ switch(max){case r:h=60*(((g-b)/d)%6);break;case g:h=60*(((b-r)/d)+2);break;case b:h=60*(((r-g)/d)+4);break;} } if(h<0) h+=360; const s=max===0?0:d/max; const v=max; return {h,s,v}; }

  addEventListener('DOMContentLoaded', ()=>{
    layout(); setWeek(0); buildWeek();
  });
})();
</script>
</body>
</html>
```0
