<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chrono</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --r-lg:12px; --r-pill:999px;
    --border:#bdbdbd; --grid-line:#e1e1e1;
    --ink:#222; --bg:#fff; --chart-bg:#f3f3f3;

    --hour-col:56px;
    --dow-h:32px;
    --label-size:12px;
    --btn:60px;

    --panelW:520px;
    --slot-gap:8px;
    --icon-btn:36px;
    --row-min-h:36px;

    --accent:#0EA5E9;
    --black:#000;
    --white:#fff;
    --danger:#d33c36;
    --ok:#1d8f2e;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
  *{box-sizing:border-box}

  .app{
    width:clamp(320px, 96vw, 520px);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(16px, env(safe-area-inset-bottom)));
    margin: max(16px, env(safe-area-inset-top)) auto;
    display:grid; grid-template-rows: 1fr auto; gap:12px; padding:0 12px;
  }

  #screen{
    border:1px solid var(--border);
    border-radius:var(--r-lg);
    background:#fff;
    position:relative; overflow:hidden; min-height:420px;
  }

  .controls{ display:flex; justify-content:space-between; align-items:center; }
  .btn{
    width:var(--btn); height:var(--btn); border-radius:50%;
    border:1px solid var(--border); background:#fff; color:#000;
    display:grid; place-items:center; cursor:pointer; padding:0;
  }
  .btn[aria-pressed="true"]{ background:#e6e6e6; }

  .icon{ width:60%; height:60% }
  .icon *{ fill:none; stroke:currentColor; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; vector-effect:non-scaling-stroke }

  .wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; min-width:0 }
  .head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--grid-line) }
  .title{ text-align:center; font-weight:800; font-size:16px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

  .grid-area{ position:relative; overflow:hidden }
  .hours{ position:absolute; top:var(--dow-h); bottom:0; left:0; width:var(--hour-col); pointer-events:none; z-index:0 }
  .hour-stamp{ position:absolute; left:8px; transform:translateY(-50%); font-size:var(--label-size); color:#444; opacity:.95; white-space:nowrap }

  .top-row{ position:absolute; top:0; left:var(--hour-col); right:0; height:var(--dow-h); display:grid; align-items:center; min-width:0 }
  .top-row.week{ grid-template-columns:repeat(7,1fr); column-gap:8px; padding:0 6px }
  .top-row.day{ grid-template-columns:1fr; padding:0 4px }

  .day-pill{ justify-self:center; border:none; padding:0 2px; text-align:center; font-size:clamp(10px, 1.9vw, 12px); background:transparent; color:#000; white-space:nowrap }

  .grid{
    position:absolute; top:var(--dow-h); left:var(--hour-col); right:0; bottom:0;
    background:var(--chart-bg);
    border-left:1px solid var(--grid-line); border-right:1px solid var(--grid-line);
    z-index:0;
  }
  .blocks{ position:absolute; inset:0; z-index:1 }
  .blk{ position:absolute; border:1px solid var(--border) }

  .mask{ position:absolute; inset:0; pointer-events:none; shape-rendering:crispEdges; z-index:2 }
  .now{ position:absolute; border:2px solid var(--accent); border-radius:999px; background:rgba(0,0,0,.03); display:none; pointer-events:none; z-index:3 }

  /* Watermark in Day view */
  .wm-wrap{ display:grid; gap:8px; place-items:center; }
  .watermark{ opacity:.25; font-weight:900; letter-spacing:.08em; font-size:12px; }

  /* ==================== Selector & Toolbar ==================== */
  .selectorWrap{
    position:absolute; z-index:50; pointer-events:none; /* children manage pointer */
  }
  .selectorBox{
    position:absolute;
    background:var(--white); /* opaque */
    border:3px solid var(--black);
    border-radius:10px;
    box-shadow:0 0 0 2px rgba(0,0,0,.06) inset;
    pointer-events:auto; /* so taps inside can be caught if needed */
  }
  /* Time “slots” labels above/below (aligned to selection width) */
  .timeRow{
    position:absolute; left:0; right:0; display:flex; justify-content:center; gap:8px;
    pointer-events:none; font-weight:900; font-size:12px; color:#111; text-shadow:0 1px 0 #fff;
  }
  .timeRow.top{ bottom:100%; transform:translateY(-6px); }
  .timeRow.bottom{ top:100%; transform:translateY(6px); }

  /* Thumb tabs (half-circles) */
  .thumb{
    position:absolute; left:50%; transform:translateX(-50%);
    width:min(100%, 44px); height:22px; border:3px solid var(--black); background:#fff;
    border-bottom:none; border-top-left-radius:999px; border-top-right-radius:999px;
    pointer-events:auto; cursor:ns-resize;
    display:grid; place-items:center; font-weight:900; user-select:none;
  }
  .thumb.bottom{
    top:100%; margin-top:6px; border-top:none; border-bottom:3px solid var(--black);
    border-bottom-left-radius:999px; border-bottom-right-radius:999px;
    border-top-left-radius:0; border-top-right-radius:0;
  }
  .thumb.top{ bottom:100%; margin-bottom:6px; }
  .thumbLabel{ font-size:11px; }

  /* Toolbar (fixed to chart’s four corners, inside grid) */
  .toolbar{
    position:absolute; z-index:60; display:flex; flex-direction:column; gap:8px;
    background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px;
    box-shadow:0 6px 16px rgba(0,0,0,.15);
  }
  .toolbar button{
    width:36px; height:36px; border-radius:50%;
    border:1px solid var(--border); background:#fff; font-weight:900; cursor:pointer;
  }
  .toolbar .ok{ color:var(--ok) }
  .toolbar .danger{ color:var(--danger) }

  /* Spillover confirmation */
  .confirm{
    position:absolute; z-index:70; left:50%; transform:translateX(-50%);
    bottom:12px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px;
    display:flex; gap:10px; align-items:center; box-shadow:0 6px 16px rgba(0,0,0,.15);
  }
  .confirm .q{ font-size:13px; }
  .confirm button{ width:36px; height:36px; border-radius:50%; border:1px solid var(--border); background:#fff; font-weight:900; cursor:pointer; }
  .confirm .yes{ color:var(--ok) } .confirm .no{ color:var(--danger) }

  /* Settings panel placeholder */
  .settingsPanel{
    position:absolute; z-index:65; min-width:220px; max-width:300px; max-height:260px; overflow:auto;
    background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.15);
    font-size:13px;
  }
</style>
</head>
<body>
  <main class="app">
    <section id="screen" aria-live="polite" aria-label="Content area"></section>

    <nav class="controls" role="group" aria-label="Primary views">
      <button class="btn" aria-label="Day view" aria-pressed="false" data-view="day" title="Day">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/>
          <line x1="12" y1="2"  x2="12" y2="5"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="2"  y1="12" x2="5"  y2="12"/>
          <line x1="19" y1="12" x2="22" y2="12"/>
          <line x1="17" y1="7"  x2="19" y2="5"/>
          <line x1="7"  y1="17" x2="5"  y2="19"/>
          <line x1="7"  y1="7"  x2="5"  y2="5"/>
          <line x1="17" y1="17" x2="19" y2="19"/>
        </svg>
      </button>

      <button class="btn" aria-label="Week view" aria-pressed="false" data-view="week" title="Week">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <line x1="6" y1="10" x2="6" y2="18"/>
          <line x1="8" y1="10" x2="8" y2="18"/>
          <line x1="10" y1="10" x2="10" y2="18"/>
          <line x1="12" y1="10" x2="12" y2="18"/>
          <line x1="14" y1="10" x2="14" y2="18"/>
          <line x1="16" y1="10" x2="16" y2="18"/>
          <line x1="18" y1="10" x2="18" y2="18"/>
        </svg>
      </button>

      <button class="btn" aria-label="Month view" aria-pressed="false" data-view="month" title="Month">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <circle cx="7"  cy="11" r="0.7"/><circle cx="11" cy="11" r="0.7"/><circle cx="15" cy="11" r="0.7"/><circle cx="19" cy="11" r="0.7"/>
          <circle cx="7"  cy="14" r="0.7"/><circle cx="11" cy="14" r="0.7"/><circle cx="15" cy="14" r="0.7"/><circle cx="19" cy="14" r="0.7"/>
          <circle cx="7"  cy="17" r="0.7"/><circle cx="11" cy="17" r="0.7"/><circle cx="15" cy="17" r="0.7"/><circle cx="19" cy="17" r="0.7"/>
        </svg>
      </button>

      <button class="btn" aria-label="To-Do list" aria-pressed="false" data-view="todo" title="To-Do">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <polyline points="7,14 10,17 17,10"/>
        </svg>
      </button>
    </nav>
  </main>

<script>
console.info('Chrono build r24 (selector+toolbar only)');

/* ---------- Core / State ---------- */
const screenEl = document.getElementById('screen');
const buttons = [...document.querySelectorAll('.btn')];

let activeView = null;               // starts blank
let activeDayISO = toISO(new Date());
let visibleWeekFirst = weekStart(new Date());

const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const SHORT_DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function toISO(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function weekStart(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }

const SLOTS_PER_DAY=96; // 15-min

/* ---------- Controls ---------- */
document.querySelector('.controls').addEventListener('click', e=>{
  const b=e.target.closest('.btn'); if(!b) return;
  const v=b.dataset.view;
  if(activeView===v){
    activeView=null; buttons.forEach(x=>x.setAttribute('aria-pressed','false')); screenEl.innerHTML='';
  }else{
    activeView=v; buttons.forEach(x=>x.setAttribute('aria-pressed', String(x===b))); render();
  }
});

/* ---------- Week View (kept minimal) ---------- */
function buildWeekView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head">
        <button id="prevWeekBtn" class="chev">◀</button>
        <div class="title" id="weekTitle"></div>
        <button id="nextWeekBtn" class="chev">▶</button>
      </div>

      <div class="grid-area">
        <div class="top-row week" id="dowPills"></div>
        <div class="grid" id="weekGrid" aria-label="Week grid">
          <div class="blocks" id="blocksLayer"></div>
          <svg class="mask" id="maskSVG" aria-hidden="true"></svg>
          <div class="now" id="nowMagnify" aria-hidden="true"></div>
        </div>
        <div class="hours" id="weekHours"></div>
      </div>

      <div class="confirm" id="spillConfirm" style="display:none">
        <span class="q" id="spillText">Spill over?</span>
        <button class="no" id="spillNo">✕</button>
        <button class="yes" id="spillYes">✓</button>
      </div>

      <div class="settingsPanel" id="settingsPanel" style="display:none">
        <strong>Settings (placeholder)</strong>
        <div style="margin-top:6px;opacity:.8">This panel just proves open/close & placement. Actual contents come later.</div>
      </div>
    </div>
  `;
  document.getElementById('prevWeekBtn').onclick = ()=>{ visibleWeekFirst=addDays(visibleWeekFirst,-7); repaintWeek(); };
  document.getElementById('nextWeekBtn').onclick = ()=>{ visibleWeekFirst=addDays(visibleWeekFirst, 7); repaintWeek(); };

  document.getElementById('weekGrid').addEventListener('pointerdown', onGridPointerDown);

  repaintWeek();
  new ResizeObserver(repaintWeek).observe(document.getElementById('weekGrid'));
}

function repaintWeek(){
  const first=visibleWeekFirst, last=addDays(first,6);
  const m=new Intl.DateTimeFormat(undefined,{month:'short'});
  const title = (first.getFullYear()===last.getFullYear())
    ? (first.getMonth()===last.getMonth()
        ? `${m.format(first)} ${first.getDate()} – ${last.getDate()}, ${first.getFullYear()}`
        : `${m.format(first)} ${first.getDate()} – ${m.format(last)} ${last.getDate()}, ${first.getFullYear()}`)
    : `${m.format(first)} ${first.getDate()}, ${first.getFullYear()} – ${m.format(last)} ${last.getDate()}, ${last.getFullYear()}`;
  document.getElementById('weekTitle').textContent = title;

  const pills=document.getElementById('dowPills'); pills.innerHTML='';
  for(let i=0;i<7;i++){
    const d=addDays(first,i);
    const pill=document.createElement('div');
    pill.className='day-pill';
    pill.textContent = `${SHORT_DOW[i]}, ${d.getDate()}`;
    pills.appendChild(pill);
  }

  const gh=document.getElementById('weekHours'); gh.innerHTML='';
  const gridEl = document.getElementById('weekGrid');
  const geom=computeGeometry(gridEl, 7);
  for(let i=0;i<24;i++){
    const el=document.createElement('div'); el.className='hour-stamp';
    el.textContent = `${String(i).padStart(2,'0')}:00`;
    el.style.top=((geom.rowY[i]+geom.rowY[i+1])/2)+'px';
    gh.appendChild(el);
  }

  buildMask(geom, 7);
  paintNowMagnifier(geom);
  // no blocks painting here — we’re testing selector only
}

/* Geometry helpers */
function computeGeometry(gridEl, cols){
  const r=gridEl.getBoundingClientRect();
  const totalW=Math.max(0, Math.round(r.width));
  const totalH=Math.max(0, Math.round(r.height));
  const colWBase=Math.floor(totalW/cols), extraW=totalW-colWBase*cols;
  const rowHBase=Math.floor(totalH/24), extraH=totalH-rowHBase*24;
  const colW=[], colX=[0]; for(let c=0;c<cols;c++){ const w=colWBase+(c<extraW?1:0); colW.push(w); colX.push(colX[c]+w); }
  const rowH=[], rowY=[0]; for(let i=0;i<24;i++){ const h=rowHBase+(i<extraH?1:0); rowH.push(h); rowY.push(rowY[i]+h); }
  const slotY=[0];
  for(let hr=0;hr<24;hr++){
    const h=rowH[hr]; const base=Math.floor(h/4); let rem=h-base*4;
    const parts=[base,base,base,base]; for(let k=0;k<rem;k++) parts[k]+=1;
    for(let q=0;q<4;q++) slotY.push(slotY[slotY.length-1]+parts[q]);
  }
  return {totalW,totalH,colW,colX,rowH,rowY,slotY};
}
function buildMask(geom, cols){
  const svg=document.getElementById('maskSVG'); svg.innerHTML='';
  const { totalW, totalH, colX, rowY } = geom;
  if(totalW<=0 || totalH<=0) return;
  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  svg.setAttribute('preserveAspectRatio','none');

  const NS='http://www.w3.org/2000/svg';
  const g=document.createElementNS(NS,'g');
  const surface='rgba(255,255,255,0.55)';

  for(let rI=0;rI<24;rI++){
    for(let cI=0;cI<cols;cI++){
      const rect=document.createElementNS(NS,'rect');
      rect.setAttribute('x', colX[cI]);
      rect.setAttribute('y', rowY[rI]);
      rect.setAttribute('width', colX[cI+1]-colX[cI]);
      rect.setAttribute('height', rowY[rI+1]-rowY[rI]);
      rect.setAttribute('fill', surface);
      g.appendChild(rect);
    }
  }
  svg.appendChild(g);
}
function paintNowMagnifier(geom){
  const nowEl=document.getElementById('nowMagnify'); nowEl.style.display='none';
}

/* =================== Selector + Toolbar Logic =================== */
let selection = null; // {startDay, startMin, endDay, endMin, geom, wrapEl, boxEl, topTab, botTab}

const MAX_DURATION_MIN = 48*60; // 48 hours
function minutesSpan(sel){
  const dDays = sel.endDay - sel.startDay;
  const dMins = (sel.endMin + dDays*1440) - sel.startMin;
  return Math.max(0, dMins);
}
function clampToCap(sel){
  const span = minutesSpan(sel);
  if (span <= MAX_DURATION_MIN) return;
  // Shrink the side being moved (we'll do this in the adjustment functions)
}

/* Create on empty-tap */
function onGridPointerDown(e){
  const grid = document.getElementById('weekGrid');
  const rect = grid.getBoundingClientRect();
  const x=e.clientX-rect.left, y=e.clientY-rect.top;
  const geom=computeGeometry(grid,7);

  // Determine column/day
  let dayIdx=0; for(let i=0;i<7;i++){ if(x>=geom.colX[i] && x<geom.colX[i+1]){ dayIdx=i; break; } }
  // Determine slot (snap to hour start)
  let slot=0; for(let i=0;i<geom.slotY.length-1;i++){ if(y>=geom.slotY[i] && y<geom.slotY[i+1]){ slot=i; break; } }
  const hourStart = Math.floor(slot/4)*60;

  // Start new 1-hour selection on empty space
  spawnSelector({ startDay:dayIdx, startMin:hourStart, endDay:dayIdx, endMin:Math.min(hourStart+60,1440), geom });
}

function spawnSelector({startDay,startMin,endDay,endMin,geom}){
  destroySelector();

  selection = { startDay, startMin, endDay, endMin, geom };

  const layer=document.getElementById('blocksLayer');
  const wrap=document.createElement('div'); wrap.className='selectorWrap'; selection.wrapEl=wrap;
  const box=document.createElement('div'); box.className='selectorBox'; selection.boxEl=box;
  wrap.appendChild(box);

  // Time labels (above/below)
  const timeTop=document.createElement('div'); timeTop.className='timeRow top'; timeTop.id='selTimeTop';
  const timeBot=document.createElement('div'); timeBot.className='timeRow bottom'; timeBot.id='selTimeBot';
  wrap.appendChild(timeTop); wrap.appendChild(timeBot);

  // Thumb tabs
  const tTop=document.createElement('div'); tTop.className='thumb top'; tTop.innerHTML='<span class="thumbLabel">⟷</span>';
  const tBot=document.createElement('div'); tBot.className='thumb bottom'; tBot.innerHTML='<span class="thumbLabel">⟷</span>';
  selection.topTab=tTop; selection.botTab=tBot;
  wrap.appendChild(tTop); wrap.appendChild(tBot);

  layer.appendChild(wrap);

  // Toolbar
  createToolbar();

  // Drag handling for tabs
  tTop.addEventListener('pointerdown', (ev)=> startDrag(ev, 'top'));
  tBot.addEventListener('pointerdown', (ev)=> startDrag(ev, 'bottom'));

  layoutSelector();
}

function toHHMM(min){ const m=((min%1440)+1440)%1440; const h=Math.floor(m/60), mm=(m%60); return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
function layoutSelector(){
  if(!selection) return;
  const {colX, slotY}=selection.geom;
  const left=colX[selection.startDay], right=colX[selection.startDay+1];
  // If second day involved, we visualize only the current day segment here (selector stays within one column visually, per spec).
  const sDay = selection.startDay;
  const eDay = selection.endDay;
  const sMin = selection.startMin;
  const endMinAbs = selection.endMin + (eDay - sDay)*1440;
  const visEndMin = Math.min(1440, endMinAbs);
  const top=slotY[Math.floor(sMin/15)];
  const bottom=slotY[Math.floor(visEndMin/15)];

  selection.boxEl.style.left=left+'px';
  selection.boxEl.style.top=top+'px';
  selection.boxEl.style.width=(right-left- (sDay===6?1:0))+'px';
  selection.boxEl.style.height=(bottom-top)+'px';

  // time labels
  const topRow=document.getElementById('selTimeTop');
  const botRow=document.getElementById('selTimeBot');
  topRow.textContent = toHHMM(selection.startMin);
  botRow.textContent = toHHMM(selection.endMin);

  // Align rows to box width
  [topRow, botRow].forEach(r=>{
    r.style.left = selection.boxEl.style.left;
    r.style.width= selection.boxEl.style.width;
  });

  // place tabs centered on selection column — tabs may overhang (allowed)
  const boxRect = selection.boxEl.getBoundingClientRect();
  const gridRect = document.getElementById('weekGrid').getBoundingClientRect();
  // absolute positions in the layer
  selection.topTab.style.left = (colX[sDay] + (colX[sDay+1]-colX[sDay])/2 - colX[0] - 22)+'px';
  selection.topTab.style.top  = (slotY[Math.floor(sMin/15)] - 22 - 6)+'px';
  selection.botTab.style.left = selection.topTab.style.left;
  selection.botTab.style.top  = (slotY[Math.floor(visEndMin/15)] + 6)+'px';

  placeToolbar();
}
function destroySelector(){
  if(!selection) return;
  selection.wrapEl?.remove();
  selection.toolbar?.remove();
  document.getElementById('settingsPanel')?.style.setProperty('display','none');
  selection=null;
}

/* Drag logic for tabs */
let dragState=null;
function startDrag(ev, side){
  if(!selection) return;
  ev.preventDefault();
  ev.stopPropagation();
  const grid = document.getElementById('weekGrid');
  grid.setPointerCapture(ev.pointerId);

  dragState={ side, pointerId:ev.pointerId };
  grid.addEventListener('pointermove', onDragMove);
  grid.addEventListener('pointerup', onDragEnd);
  grid.addEventListener('pointercancel', onDragEnd);
}
function onDragMove(ev){
  if(!selection || !dragState) return;
  const grid = document.getElementById('weekGrid');
  const rect = grid.getBoundingClientRect();
  const y=ev.clientY-rect.top;
  const g=selection.geom;

  // which 15-min slot?
  let slot=0; for(let i=0;i<g.slotY.length-1;i++){ if(y>=g.slotY[i] && y<g.slotY[i+1]){ slot=i; break; } }
  const min = Math.max(0, Math.min(slot*15, 1440)); // clamp inside chart
  adjustSelectionByDrag(dragState.side, min);
}
function onDragEnd(ev){
  const grid = document.getElementById('weekGrid');
  if(dragState){ grid.releasePointerCapture(dragState.pointerId); }
  grid.removeEventListener('pointermove', onDragMove);
  grid.removeEventListener('pointerup', onDragEnd);
  grid.removeEventListener('pointercancel', onDragEnd);
  dragState=null;
}
function adjustSelectionByDrag(side, minWithinDay){
  // side: 'top' adjusts start; 'bottom' adjusts end
  // apply to current visible day segment (selection.startDay column)
  const sel=selection;
  const absEnd = sel.endMin + (sel.endDay - sel.startDay)*1440;

  if(side==='top'){
    let newStart = Math.min(Math.max(0, minWithinDay), 1440-15);
    // prevent surpassing end
    if (newStart >= absEnd-15) newStart = absEnd-15;
    // Handle midnight spill back
    if (newStart===0 && sel.startMin===0 && sel.startDay>0){
      // ask to spill into previous day
      showSpillConfirm(-1);
      return; // wait for user
    }else{
      sel.startMin=newStart;
      layoutSelector();
    }
  }else{
    let newEndAbs = Math.max(sel.startMin+15, minWithinDay);
    if (newEndAbs>1440){
      // reached bottom of this day
      if(sel.endMin===1440 && sel.endDay<6){
        showSpillConfirm(+1);
        return;
      }
      newEndAbs=1440;
    }
    // Apply 48h cap
    const tmpEndDay = sel.startDay + Math.floor(newEndAbs/1440);
    const tmpEndMin = newEndAbs%1440;
    const temp = {startDay:sel.startDay,startMin:sel.startMin,endDay:tmpEndDay,endMin:tmpEndMin};
    if (minutesSpan(temp) > MAX_DURATION_MIN){
      // lock at cap
      const capAbs = sel.startMin + MAX_DURATION_MIN;
      sel.endDay = sel.startDay + Math.floor(capAbs/1440);
      sel.endMin = capAbs%1440;
    }else{
      sel.endDay=tmpEndDay; sel.endMin=tmpEndMin;
    }
    layoutSelector();
  }
}

/* Spillover confirm */
function showSpillConfirm(dir){
  const c=document.getElementById('spillConfirm'); const t=document.getElementById('spillText');
  if(!selection) return;
  const nextDay = dir>0 ? selection.startDay+1 : selection.startDay-1;
  if(nextDay<0 || nextDay>6){ c.style.display='none'; return; }
  t.textContent = dir>0 ? `Spill into ${DAY_NAMES[nextDay]}?` : `Spill back into ${DAY_NAMES[nextDay]}?`;
  c.style.display='flex';

  const yes=()=>{ acceptSpill(dir); cleanup(); };
  const no =()=>{ rejectSpill(); cleanup(); };
  function cleanup(){
    document.getElementById('spillYes').removeEventListener('click', yes);
    document.getElementById('spillNo').removeEventListener('click', no);
  }
  document.getElementById('spillYes').addEventListener('click', yes, {once:true});
  document.getElementById('spillNo').addEventListener('click', no, {once:true});
}
function acceptSpill(dir){
  const sel=selection; if(!sel) return;
  if(dir>0){
    // extend into next day: fill first hour on next day and continue from there
    if(sel.endDay<6){
      const capAbs = sel.startMin + MAX_DURATION_MIN;
      const nextAbs = Math.min(1440+60, capAbs); // at least one hour
      sel.endDay = sel.startDay + Math.floor(nextAbs/1440);
      sel.endMin = nextAbs%1440;
    }
  }else{
    // spill back into previous day: start at 1440 and allow growth upward
    if(sel.startDay>0){
      const capAbs = sel.endMin + (sel.endDay - sel.startDay)*1440 - MAX_DURATION_MIN;
      const newStartAbs = Math.max(0, sel.endMin + (sel.endDay - sel.startDay)*1440 - MAX_DURATION_MIN);
      sel.startDay = sel.startDay-1;
      sel.startMin = 1440 - 60; // take first hour back by default
      // keep within cap automatically on next drags
    }
  }
  layoutSelector();
}
function rejectSpill(){
  const sel=selection; if(!sel) return;
  // just clamp at boundaries
  if(sel.startMin<=0){ sel.startMin=0; }
  if(sel.endDay>sel.startDay || sel.endMin>=1440){ sel.endDay=sel.startDay; sel.endMin=1440; }
  layoutSelector();
}

/* Toolbar */
function createToolbar(){
  const tb=document.createElement('div'); tb.className='toolbar'; selection.toolbar=tb;
  tb.innerHTML = `
    <button title="Increase top (15m)" data-act="top-plus">+</button>
    <button title="Decrease top (15m)" data-act="top-minus">−</button>
    <button title="Save" class="ok" data-act="save">✓</button>
    <button title="Discard" class="danger" data-act="discard">✕</button>
    <button title="Settings" data-act="settings">⚙</button>
    <button title="Decrease bottom (15m)" data-act="bot-minus">−</button>
    <button title="Increase bottom (15m)" data-act="bot-plus">+</button>
  `;
  document.getElementById('blocksLayer').appendChild(tb);

  tb.addEventListener('click', onToolbarClick);
  placeToolbar();
}
function onToolbarClick(e){
  const b=e.target.closest('button'); if(!b || !selection) return;
  const act=b.dataset.act;
  if(act==='save'){ destroySelector(); return; }
  if(act==='discard'){ destroySelector(); return; }
  if(act==='settings'){
    toggleSettingsPanel();
    return;
  }

  // Adjustments (15m)
  if(act==='top-plus'){ growTop(+15); }
  if(act==='top-minus'){ growTop(-15); }
  if(act==='bot-plus'){ growBottom(+15); }
  if(act==='bot-minus'){ growBottom(-15); }
}
function toggleSettingsPanel(){
  const panel=document.getElementById('settingsPanel');
  if(panel.style.display==='none') {
    // open away from toolbar side
    const gridRect=document.getElementById('weekGrid').getBoundingClientRect();
    const tbRect=selection.toolbar.getBoundingClientRect();
    const openRight = (tbRect.left < gridRect.left + gridRect.width/2); // left anchors open right
    const x = openRight ? (tbRect.right + 8) : (tbRect.left - panel.offsetWidth - 8);
    const y = Math.max(gridRect.top+8, Math.min(tbRect.top, gridRect.bottom - 8 - 200));
    panel.style.left = Math.max(gridRect.left+8, Math.min(x, gridRect.right-8-300)) + 'px';
    panel.style.top  = y + 'px';
    panel.style.display='block';
  } else {
    panel.style.display='none';
  }
}
function placeToolbar(){
  if(!selection || !selection.toolbar) return;
  const gridRect = document.getElementById('weekGrid').getBoundingClientRect();
  const boxRect  = selection.boxEl.getBoundingClientRect();

  // Pick the furthest corner from the selection box center
  const corners = [
    {name:'TL', x:gridRect.left+8, y:gridRect.top+8},
    {name:'TR', x:gridRect.right-8, y:gridRect.top+8},
    {name:'BL', x:gridRect.left+8, y:gridRect.bottom-8},
    {name:'BR', x:gridRect.right-8, y:gridRect.bottom-8},
  ];
  const cx=(boxRect.left+boxRect.right)/2, cy=(boxRect.top+boxRect.bottom)/2;
  let best=null, bestDist=-1;
  for(const c of corners){
    const dx=(c.x - cx), dy=(c.y - cy);
    const d=dx*dx+dy*dy;
    if(d>bestDist){ bestDist=d; best=c; }
  }

  const tb=selection.toolbar;
  const w=tb.offsetWidth || 60, h=tb.offsetHeight || 260;
  let left = best.name.endsWith('L') ? best.x : best.x - w;
  let top  = best.name.startsWith('T') ? best.y : best.y - h;

  // Clamp inside grid
  left = Math.max(gridRect.left+8, Math.min(left, gridRect.right-8-w));
  top  = Math.max(gridRect.top+8,  Math.min(top,  gridRect.bottom-8-h));

  tb.style.left = left+'px';
  tb.style.top  = top +'px';
}

/* Button adjust helpers with cap & spill prompts */
function growTop(delta){
  if(!selection) return;
  let newStartAbs = selection.startMin - delta; // top-plus means earlier (increase height upward)
  // convert to mins within current startDay
  if(newStartAbs<0){
    // hit top edge
    if(selection.startMin===0 && selection.startDay>0){ showSpillConfirm(-1); return; }
    newStartAbs=0;
  }
  const tmp = {startDay:selection.startDay, startMin:newStartAbs, endDay:selection.endDay, endMin:selection.endMin};
  if(minutesSpan(tmp) > MAX_DURATION_MIN){
    // lock at cap
    const capStartAbs = selection.endMin + (selection.endDay - selection.startDay)*1440 - MAX_DURATION_MIN;
    selection.startMin = Math.max(0, capStartAbs);
  }else{
    selection.startMin = newStartAbs;
  }
  if(selection.startMin >= selection.endMin && selection.startDay===selection.endDay){
    selection.startMin = Math.max(0, selection.endMin-15);
  }
  layoutSelector();
}
function growBottom(delta){
  if(!selection) return;
  let newEndAbs = selection.endMin + delta + (selection.endDay - selection.startDay)*1440;
  if(newEndAbs>1440){
    if(selection.endMin===1440 && selection.endDay<6){ showSpillConfirm(+1); return; }
    newEndAbs=1440;
  }
  const tmpEndDay = selection.startDay + Math.floor(newEndAbs/1440);
  const tmpEndMin = newEndAbs%1440;
  const tmp = {startDay:selection.startDay, startMin:selection.startMin, endDay:tmpEndDay, endMin:tmpEndMin};
  if(minutesSpan(tmp) > MAX_DURATION_MIN){
    const capAbs = selection.startMin + MAX_DURATION_MIN;
    selection.endDay = selection.startDay + Math.floor(capAbs/1440);
    selection.endMin = capAbs%1440;
  }else{
    selection.endDay=tmpEndDay; selection.endMin=tmpEndMin;
  }
  layoutSelector();
}

/* Day View (unchanged visual; no nuke here per current focus) */
function buildDayView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head"><div></div><div class="title">Day</div><div></div></div>
      <div class="grid-area" style="display:grid;place-items:center;color:#666">
        <div class="wm-wrap"><div class="watermark">Chrono build r24</div></div>
      </div>
    </div>
  `;
}

/* Month View (unchanged visual placeholder) */
function buildMonthView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head"><div></div><div class="title">Month</div><div></div></div>
      <div class="grid-area" style="display:grid;place-items:center;color:#666">
        <div class="wm-wrap"><div class="watermark">Chrono build r24</div></div>
      </div>
    </div>
  `;
}

/* ---------- Init & render ---------- */
function render(){
  if(activeView==='week'){
    visibleWeekFirst = weekStart(new Date());
    buildWeekView();
  } else if(activeView==='day'){
    activeDayISO = toISO(new Date());
    buildDayView();
  } else if(activeView==='month'){
    activeDayISO = toISO(new Date());
    buildMonthView();
  } else {
    screenEl.innerHTML='';
  }
}
(function init(){
  visibleWeekFirst = weekStart(new Date());
  activeDayISO = toISO(new Date());
  // Default to week view to test selector
  activeView='week';
  buttons.forEach(b=>b.dataset.view===activeView && b.setAttribute('aria-pressed','true'));
  render();
})();
</script>

<!-- (Optional) service worker registration preserved -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.error('SW registration failed', err));
  });
}
</script>

</body>
</html>