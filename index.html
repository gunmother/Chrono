<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chrono</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">
<style>
  :root{
    --r-lg:12px; --r-pill:999px;
    --border:#bdbdbd; --grid-line:#e1e1e1;
    --ink:#222; --bg:#fff; --chart-bg:#f3f3f3;

    --hour-col:56px;
    --dow-h:32px;
    --label-size:12px;
    --btn:60px;

    --panelW:520px;
    --slot-gap:8px;
    --icon-btn:36px;
    --row-min-h:36px;

    --ctrl-bg:#ffffff;
    --ctrl-shadow:0 6px 16px rgba(0,0,0,.15);
    --danger:#d33c36;
    --ok:#1d8f2e;
    --hint:#111;
    --accent:#0EA5E9;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
  *{box-sizing:border-box}

  .app{
    width:clamp(320px, 96vw, 520px);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(16px, env(safe-area-inset-bottom)));
    margin: max(16px, env(safe-area-inset-top)) auto;
    display:grid; grid-template-rows: 1fr auto; gap:12px; padding:0 12px;
  }

  #screen{
    border:1px solid var(--border);
    border-radius:var(--r-lg);
    background:#fff;
    position:relative; overflow:hidden; min-height:420px;
  }

  .controls{ display:flex; justify-content:space-between; align-items:center; }
  .btn{
    width:var(--btn); height:var(--btn); border-radius:50%;
    border:1px solid var(--border); background:#fff; color:#000;
    display:grid; place-items:center; cursor:pointer; padding:0;
  }
  .btn[aria-pressed="true"]{ background:#e6e6e6; }

  .icon{ width:60%; height:60% }
  .icon *{ fill:none; stroke:currentColor; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; vector-effect:non-scaling-stroke }

  /* ------- View wrappers & scaffolding (pristine) ------- */
  .wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; min-width:0 }
  .head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--grid-line) }
  .title{ text-align:center; font-weight:800; font-size:16px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

  .grid-area{ position:relative; overflow:hidden }
  .hours{ position:absolute; top:var(--dow-h); bottom:0; left:0; width:var(--hour-col); pointer-events:none; z-index:0 }
  .hour-stamp{ position:absolute; left:8px; transform:translateY(-50%); font-size:var(--label-size); color:#444; opacity:.95; white-space:nowrap }

  .top-row{ position:absolute; top:0; left:var(--hour-col); right:0; height:var(--dow-h); display:grid; align-items:center; min-width:0 }
  .top-row.week{ grid-template-columns:repeat(7,1fr); column-gap:8px; padding:0 6px }
  .top-row.day{ grid-template-columns:1fr; padding:0 4px }

  .day-pill{ justify-self:center; border:none; padding:0 2px; text-align:center; font-size:clamp(10px, 1.9vw, 12px); background:transparent; color:#000; white-space:nowrap }

  .grid{
    position:absolute; top:var(--dow-h); left:var(--hour-col); right:0; bottom:0;
    background:var(--chart-bg);
    border-left:1px solid var(--grid-line); border-right:1px solid var(--grid-line);
    z-index:0;
  }
  .blocks{ position:absolute; inset:0; z-index:1 }
  .blk{ position:absolute; border:1px solid var(--border); cursor:pointer }
  .mask{ position:absolute; inset:0; pointer-events:none; shape-rendering:crispEdges; z-index:2 }
  .now{ position:absolute; border:2px solid var(--accent); border-radius:999px; background:rgba(0,0,0,.03); display:none; pointer-events:none; z-index:3 }

  .chev{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900; min-width:44px }
  .chev:disabled{ opacity:.5; cursor:not-allowed }

  /* ------ Month (pristine) ------ */
  .month-wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto auto 1fr }
  .month-dow{ display:grid; grid-template-columns:repeat(7,1fr); padding:6px 10px 0 10px; gap:6px; font-size:12px; letter-spacing:0.05em; color:#444 }
  .month-dow span{ text-align:center }
  .month-grid{ height:100%; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; gap:6px; padding:10px; }
  .mcell{ border:1px solid var(--grid-line); border-radius:8px; padding:6px; font-size:12px; background:#fff; display:flex; align-items:flex-start; justify-content:flex-start }
  .mcell.today{ outline:2px solid var(--accent); outline-offset:1px }
  .mcell.muted{ color:#9c9c9c }

  /* --------- (existing overlays retained) --------- */
  #taskOverlay{ position:fixed; inset:0; display:none; z-index:60 }
  #taskOverlay::before{ content:""; position:absolute; inset:0; background:rgba(0,0,0,.25); }
  #taskOverlay .stack{
    position:fixed; left:50%; transform:translateX(-50%);
    width:min(96vw, var(--panelW));
    display:grid; grid-auto-rows:var(--row-min-h); grid-template-columns:1fr;
    gap:8px; padding:0; pointer-events:auto; overflow:hidden; background:transparent;
  }

  #settingsOverlay{ position:fixed; inset:0; display:none; z-index:80 }
  #settingsOverlay .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.25) }
  .card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(96vw, var(--panelW)); max-height:min(92vh, 760px);
    background:#fff; border:1px solid var(--border); border-radius:14px;
    display:grid; grid-template-rows:auto 1fr auto; overflow:hidden;
  }

  /* ---------------- New: Selector visuals only ---------------- */
  .selector{
    position:absolute;
    border:4px solid #fff;               /* thick white outline */
    box-shadow:0 0 0 2px #000 inset, 0 0 0 2px #000; /* black edge inside+outside */
    border-radius:8px;
    background:rgba(255,255,255,0.06);
    z-index:4; pointer-events:none;
  }
  .sel-badge{
    position:absolute; left:50%; transform:translateX(-50%);
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; font-weight:800; font-size:12px; color:#000;
    background:#fff; border:2px solid #000; border-radius:999px;
    box-shadow:var(--ctrl-shadow);
    pointer-events:auto; /* accept taps if needed later */
  }
  .sel-badge.top{ top:-14px; }
  .sel-badge.bottom{ bottom:-14px; }

  /* half-circle thumb tabs */
  .thumb{
    position:absolute; left:50%; transform:translateX(-50%);
    width:28px; height:14px; background:#000;
    border:2px solid #fff; box-shadow:0 0 0 2px #000 inset;
    border-bottom-left-radius:999px; border-bottom-right-radius:999px;
    pointer-events:auto; touch-action:none; z-index:5;
  }
  .thumb.top{
    top:-26px;
    border-top-left-radius:0; border-top-right-radius:0;
    border-bottom-left-radius:999px; border-bottom-right-radius:999px;
  }
  .thumb.bottom{
    bottom:-26px;
    border-top-left-radius:999px; border-top-right-radius:999px;
    border-bottom-left-radius:0; border-bottom-right-radius:0;
  }

  /* Brief tip bubble */
  .tip{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:12px; z-index:8; background:#fff; color:#111; border:1px solid var(--border); border-radius:12px; padding:10px 12px; box-shadow:var(--ctrl-shadow);
    font-size:13px; display:flex; align-items:center; gap:10px;
  }
  .tip .dot{ width:8px; height:8px; background:var(--accent); border-radius:50%; }

  /* simple grid lines via background (visual-only; preserves look) */
  .grid::before{
    content:""; position:absolute; inset:0;
    background:
      linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px) 0 0/100% calc((100% - var(--dow-h)) / 24),
      linear-gradient(to right, var(--grid-line) 1px, transparent 1px) 0 0/calc((100% - 0px) / 7) 100%;
    pointer-events:none;
    top:0; left:0;
  }
</style>
</head>
<body>
  <main class="app">
    <section id="screen" aria-live="polite" aria-label="Content area"></section>

    <nav class="controls" role="group" aria-label="Primary views">
      <button class="btn" aria-label="Day view" aria-pressed="false" data-view="day" title="Day">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/>
          <line x1="12" y1="2"  x2="12" y2="5"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="2"  y1="12" x2="5"  y2="12"/>
          <line x1="19" y1="12" x2="22" y2="12"/>
          <line x1="17" y1="7"  x2="19" y2="5"/>
          <line x1="7"  y1="17" x2="5"  y2="19"/>
          <line x1="7"  y1="7"  x2="5"  y2="5"/>
          <line x1="17" y1="17" x2="19" y2="19"/>
        </svg>
      </button>

      <button class="btn" aria-label="Week view" aria-pressed="true" data-view="week" title="Week">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <line x1="6" y1="10" x2="6" y2="18"/>
          <line x1="8" y1="10" x2="8" y2="18"/>
          <line x1="10" y1="10" x2="10" y2="18"/>
          <line x1="12" y1="10" x2="12" y2="18"/>
          <line x1="14" y1="10" x2="14" y2="18"/>
          <line x1="16" y1="10" x2="16" y2="18"/>
          <line x1="18" y1="10" x2="18" y2="18"/>
        </svg>
      </button>

      <button class="btn" aria-label="Month view" aria-pressed="false" data-view="month" title="Month">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <circle cx="7"  cy="11" r="0.7"/><circle cx="11" cy="11" r="0.7"/><circle cx="15" cy="11" r="0.7"/><circle cx="19" cy="11" r="0.7"/>
          <circle cx="7"  cy="14" r="0.7"/><circle cx="11" cy="14" r="0.7"/><circle cx="15" cy="14" r="0.7"/><circle cx="19" cy="14" r="0.7"/>
          <circle cx="7"  cy="17" r="0.7"/><circle cx="11" cy="17" r="0.7"/><circle cx="15" cy="17" r="0.7"/><circle cx="19" cy="17" r="0.7"/>
        </svg>
      </button>

      <button class="btn" aria-label="To-Do list" aria-pressed="false" data-view="todo" title="To-Do">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <polyline points="7,14 10,17 17,10"/>
        </svg>
      </button>
    </nav>
  </main>

  <!-- Overlays preserved (unused here) -->
  <div id="taskOverlay" aria-hidden="true"></div>
  <div id="settingsOverlay" aria-hidden="true"></div>

<script>
console.info('Chrono build r23 (selector only)');

const screenEl = document.getElementById('screen');
const SHORT_DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

/* ---------- Helpers ---------- */
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const roundTo = (v,step)=>Math.round(v/step)*step;
const snap15 = min => clamp(roundTo(min, 15), 0, 1440);

/* ---------- Build WEEK view (visuals kept pristine) ---------- */
function renderWeek(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head">
        <button class="chev" id="prevW" aria-label="Previous week">‹</button>
        <div class="title">This Week</div>
        <button class="chev" id="nextW" aria-label="Next week">›</button>
      </div>

      <div class="grid-area" id="weekArea">
        <div class="hours" id="hoursCol"></div>
        <div class="top-row week" id="dowRow"></div>

        <div class="grid" id="weekGrid">
          <div class="blocks" id="blocks"></div>
          <svg class="mask" id="mask" xmlns="http://www.w3.org/2000/svg"></svg>
          <div class="now" id="now"></div>
          <!-- tip bubble -->
          <div class="tip" id="tapTip" role="status" aria-live="polite">
            <span class="dot"></span> Tap anywhere to edit
          </div>
        </div>
      </div>
    </div>
  `;

  // hours labels (every hour)
  const hoursEl = document.getElementById('hoursCol');
  const area = document.getElementById('weekArea');
  const grid = document.getElementById('weekGrid');
  const dow = document.getElementById('dowRow');

  for(let i=0;i<7;i++){
    const pill = document.createElement('button');
    pill.className='day-pill';
    pill.textContent = SHORT_DOW[i];
    dow.appendChild(pill);
  }

  const gridRect = ()=>grid.getBoundingClientRect();
  const dayRows = 7;
  const rowH = ()=> (grid.clientHeight - 0) / dayRows; // full height for 7 rows

  // Hour stamps positioned relative to each row
  function drawHours(){
    hoursEl.innerHTML='';
    const rH = rowH();
    for(let h=0; h<=24; h++){
      const y = (h/24)*rH; // within a row
      // stamp once per hour per row
      for(let d=0; d<dayRows; d++){
        const stamp = document.createElement('div');
        stamp.className='hour-stamp';
        stamp.style.top = `${(d*rH) + y + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dow-h'))}px`;
        stamp.textContent = String(h).padStart(2,'0') + ':00';
        hoursEl.appendChild(stamp);
      }
    }
  }

  const ro = new ResizeObserver(drawHours);
  ro.observe(grid);
  drawHours();

  // Build selector overlay (created once)
  const selector = document.createElement('div');
  selector.className = 'selector';
  selector.style.display='none';

  // badges
  const badgeTop = document.createElement('div');
  badgeTop.className='sel-badge top';
  const badgeBottom = document.createElement('div');
  badgeBottom.className='sel-badge bottom';
  selector.appendChild(badgeTop);
  selector.appendChild(badgeBottom);

  // thumbs
  const thumbTop = document.createElement('div'); thumbTop.className='thumb top';
  const thumbBottom = document.createElement('div'); thumbBottom.className='thumb bottom';
  selector.appendChild(thumbTop); selector.appendChild(thumbBottom);

  grid.appendChild(selector);

  // Tip life
  const tip = document.getElementById('tapTip');
  setTimeout(()=>{ tip && (tip.style.display='none'); }, 1500);

  // Selection state (within a single day row)
  let sel = {
    dayIndex: 0,
    startMin: 0,
    endMin: 60,   // 1 hour
  };

  function minToPx(min){
    return (min/1440) * rowH();
  }

  function setBadges(){
    const fmt = m => {
      const hh = Math.floor(m/60), mm = m%60;
      return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');
    };
    badgeTop.textContent = `${fmt(sel.startMin)}–${fmt(sel.endMin)}`;
    badgeBottom.textContent = `${fmt(sel.startMin)}–${fmt(sel.endMin)}`;
  }

  function positionSelector(){
    const rH = rowH();
    const topY = sel.dayIndex * rH + minToPx(sel.startMin);
    const height = Math.max(1, minToPx(sel.endMin) - minToPx(sel.startMin));
    selector.style.top = `${topY + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dow-h'))}px`;
    selector.style.left = `var(--hour-col)`;
    selector.style.right = `0`;
    selector.style.height = `${height}px`;
    selector.style.display='block';
    setBadges();
  }

  function pickDayAndMinute(clientY){
    const rect = gridRect();
    const y = clamp(clientY - rect.top - parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dow-h')), 0, grid.clientHeight);
    const rH = rowH();
    let dayIndex = Math.floor(y / rH);
    dayIndex = clamp(dayIndex, 0, 6);
    const within = y - dayIndex*rH;
    const min = snap15((within / rH) * 1440);
    return { dayIndex, min };
  }

  // Tap to create 1-hour selection centered at tap (but clamped to day bounds)
  grid.addEventListener('pointerup', (e)=>{
    const {dayIndex, min} = pickDayAndMinute(e.clientY);
    const half = 30; // half of 60 minutes
    let start = snap15(min - half);
    let end = snap15(start + 60);
    if(end > 1440){ end = 1440; start = snap15(end - 60); }
    if(start < 0){ start = 0; end = snap15(start + 60); }

    sel.dayIndex = dayIndex;
    sel.startMin = start;
    sel.endMin = Math.max(start+15, end);
    positionSelector();
  }, {passive:true});

  // Dragging on thumbs (vertical only, 15-min snapping), stays within the day row
  let dragMode = null; // 'top' | 'bottom'
  let pointerId = null;

  function onPointerMove(e){
    if(pointerId !== e.pointerId) return;
    const {dayIndex, min} = pickDayAndMinute(e.clientY);
    // lock to same day row
    if(dayIndex !== sel.dayIndex) return;

    if(dragMode==='top'){
      const newStart = clamp(snap15(min), 0, sel.endMin - 15);
      sel.startMin = newStart;
    } else if(dragMode==='bottom'){
      const newEnd = clamp(snap15(min), sel.startMin + 15, 1440);
      sel.endMin = newEnd;
    }
    positionSelector();
  }

  function onPointerUp(e){
    if(pointerId !== e.pointerId) return;
    dragMode=null; pointerId=null;
    window.removeEventListener('pointermove', onPointerMove);
    window.removeEventListener('pointerup', onPointerUp);
    window.removeEventListener('pointercancel', onPointerUp);
  }

  function startDrag(mode, e){
    dragMode = mode;
    pointerId = e.pointerId;
    e.target.setPointerCapture(pointerId);
    window.addEventListener('pointermove', onPointerMove, {passive:true});
    window.addEventListener('pointerup', onPointerUp, {passive:true});
    window.addEventListener('pointercancel', onPointerUp, {passive:true});
  }

  thumbTop.addEventListener('pointerdown', e=> startDrag('top', e));
  thumbBottom.addEventListener('pointerdown', e=> startDrag('bottom', e));

  // Initial position (invisible until first tap; tip shows once)
  selector.style.display='none';
}

/* ---------- Month stub (pristine visuals only) ---------- */
function renderMonth(){
  screenEl.innerHTML = `
    <div class="month-wrap">
      <div class="head">
        <button class="chev" aria-label="Previous month">‹</button>
        <div class="title">This Month</div>
        <button class="chev" aria-label="Next month">›</button>
      </div>
      <div class="month-dow">
        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
      </div>
      <div class="month-grid" id="monthGrid">
        ${Array.from({length:35}).map((_,i)=>`<div class="mcell${i===10?' today':''}">${i===10?'Today':''}</div>`).join('')}
      </div>
    </div>
  `;
}

/* ---------- Nav ---------- */
const buttons = [...document.querySelectorAll('.btn')];
buttons.forEach(b=>{
  b.addEventListener('click', ()=>{
    buttons.forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true');
    const view = b.dataset.view;
    if(view==='week') renderWeek();
    else if(view==='month') renderMonth();
    else if(view==='day'){ renderWeek(); } // keep pristine; day not in scope here
    else if(view==='todo'){ renderWeek(); } // placeholder to avoid breaking
  });
});

/* ---------- Boot into Week with tip ---------- */
renderWeek();
</script>
</body>
</html>