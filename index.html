<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chrono</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --r-lg:12px; --r-pill:999px;
    --border:#bdbdbd; --grid-line:#e1e1e1;
    --ink:#222; --bg:#fff; --chart-bg:#f3f3f3;

    --hour-col:56px;
    --dow-h:32px;
    --label-size:12px;
    --btn:60px;

    --panelW:520px;

    /* Marquee */
    --marquee-border:4px;
    --marquee-shadow:0 0 0 3px rgba(0,0,0,.15), 0 10px 18px rgba(0,0,0,.20);

    /* Handles */
    --handle-height:48px; /* big, thumb-friendly */
    --handle-stroke:#6f6f6f; /* prominent tab border */
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
  *{box-sizing:border-box}

  .app{
    width:clamp(320px, 96vw, 520px);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(16px, env(safe-area-inset-bottom)));
    margin: max(16px, env(safe-area-inset-top)) auto;
    display:grid; grid-template-rows: 1fr auto; gap:12px; padding:0 12px;
  }

  #screen{
    border:1px solid var(--border);
    border-radius:var(--r-lg);
    background:#fff;
    position:relative; overflow:hidden; min-height:420px;
  }

  .controls{ display:flex; justify-content:space-between; align-items:center; }
  .btn{
    width:var(--btn); height:var(--btn); border-radius:50%;
    border:1px solid var(--border); background:#fff; color:#000;
    display:grid; place-items:center; cursor:pointer; padding:0;
  }
  .btn[aria-pressed="true"]{ background:#e6e6e6; }

  .icon{ width:60%; height:60% }
  .icon *{ fill:none; stroke:currentColor; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; vector-effect:non-scaling-stroke }

  .wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; min-width:0 }
  .head{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--grid-line) }
  .title{ text-align:center; font-weight:800; font-size:16px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

  .grid-area{ position:relative; overflow:hidden }
  .hours{ position:absolute; top:var(--dow-h); bottom:0; left:0; width:var(--hour-col); pointer-events:none; z-index:0 }
  .hour-stamp{ position:absolute; left:8px; transform:translateY(-50%); font-size:var(--label-size); color:#444; opacity:.95; white-space:nowrap }

  .top-row{ position:absolute; top:0; left:var(--hour-col); right:0; height:var(--dow-h); display:grid; align-items:center; min-width:0 }
  .top-row.week{ grid-template-columns:repeat(7,1fr); column-gap:8px; padding:0 6px }
  .top-row.day{ grid-template-columns:1fr; padding:0 4px }

  .day-pill{ justify-self:center; border:none; padding:0 2px; text-align:center; font-size:clamp(10px, 1.9vw, 12px); background:transparent; color:#000; white-space:nowrap }

  .grid{
    position:absolute; top:var(--dow-h); left:var(--hour-col); right:0; bottom:0;
    background:var(--chart-bg);
    border-left:1px solid var(--grid-line); border-right:1px solid var(--grid-line);
    z-index:0;
  }
  .blocks{ position:absolute; inset:0; z-index:1 }
  .blk{ position:absolute; border:1px solid var(--border) }
  .mask{ position:absolute; inset:0; pointer-events:none; shape-rendering:crispEdges; z-index:2 }
  .now{ position:absolute; border:2px solid #0EA5E9; border-radius:999px; background:rgba(0,0,0,.03); display:none; pointer-events:none; z-index:3 }

  .chev{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900; min-width:44px }
  .chev:disabled{ opacity:.5; cursor:not-allowed }

  /* Month */
  .month-wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto auto 1fr }
  .month-dow{ display:grid; grid-template-columns:repeat(7,1fr); padding:6px 10px 0 10px; gap:6px; font-size:12px; letter-spacing:0.05em; color:#444 }
  .month-dow span{ text-align:center }
  .month-grid{ height:100%; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; gap:6px; padding:10px; }
  .mcell{ border:1px solid var(--grid-line); border-radius:8px; padding:6px; font-size:12px; background:#fff; display:flex; align-items:flex-start; justify-content:flex-start }
  .mcell.today{ outline:2px solid #0EA5E9; outline-offset:1px }
  .mcell.muted{ color:#9c9c9c }

  /* Day watermark */
  .watermark{ opacity:.25; font-weight:900; letter-spacing:.08em; font-size:12px; }

  /* ---------- Selection marquee component ---------- */
  .selHost{
    position:fixed; inset:0; overflow:visible; pointer-events:none; z-index:1000;
  }
  .marquee{ position:absolute; pointer-events:none; }
  .marqueeRect{
    position:absolute;
    box-sizing:border-box;
    border:var(--marquee-border) solid #fff;
    box-shadow: var(--marquee-shadow);
    border-radius:8px;
    /* pointer-events:auto;  (no move-drag in r29) */
    touch-action:none;
  }

  .stamp{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    background:#fff;
    color:#111;
    border:1px solid var(--border);
    border-radius:10px;
    padding:4px 8px;
    font-size:12px;
    font-variant-numeric:tabular-nums;
    font-weight:800;
    white-space:nowrap;
    pointer-events:none;
    z-index:2;
  }

  .handle{
    position:absolute;
    left:0;
    width:100%;
    height:var(--handle-height);
    pointer-events:auto;
    cursor:ns-resize;
    z-index:3;
    touch-action:none;
  }
  .handle svg{ display:block; width:100%; height:100%; }
  .handle polygon{
    fill:#fff;
    stroke:var(--handle-stroke);
    stroke-width:2.25;
    stroke-linejoin:round;
  }

  /* Hint */
  .hint{
    position:absolute; left:50%; top:calc(var(--dow-h) + 8px);
    transform:translateX(-50%);
    background:#111; color:#fff; font-size:12px; font-weight:700;
    padding:6px 10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.22);
    opacity:0; transition:opacity .25s ease, transform .25s ease;
    z-index:50; pointer-events:none;
  }
  .hint.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  /* ---------- Vertical Toolbar (overlay) ---------- */
  .toolbar{
    position:absolute;
    display:flex; flex-direction:column; gap:6px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:8px;
    box-shadow:0 10px 18px rgba(0,0,0,.20), 0 0 0 1px rgba(0,0,0,.04);
    pointer-events:auto; /* interactive */
    z-index:1100;
    touch-action:none;
  }
  .tbtn{
    width:40px; height:40px;
    display:grid; place-items:center;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    cursor:pointer;
  }
  .tbtn:active{ background:#f3f3f3; }
  .ticon{ width:22px; height:22px; }
  .ticon *{ fill:none; stroke:#111; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; vector-effect:non-scaling-stroke }
</style>
</head>
<body>
  <main class="app">
    <section id="screen" aria-live="polite" aria-label="Content area"></section>

    <nav class="controls" role="group" aria-label="Primary views">
      <button class="btn" aria-label="Day view" aria-pressed="false" data-view="day" title="Day">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/>
          <line x1="12" y1="2"  x2="12" y2="5"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="2"  y1="12" x2="5"  y2="12"/>
          <line x1="19" y1="12" x2="22" y2="12"/>
          <line x1="17" y1="7"  x2="19" y2="5"/>
          <line x1="7"  y1="17" x2="5"  y2="19"/>
          <line x1="7"  y1="7"  x2="5"  y2="5"/>
          <line x1="17" y1="17" x2="19" y2="19"/>
        </svg>
      </button>

      <button class="btn" aria-label="Week view" aria-pressed="false" data-view="week" title="Week">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <line x1="6" y1="10" x2="6" y2="18"/>
          <line x1="8" y1="10" x2="8" y2="18"/>
          <line x1="10" y1="10" x2="10" y2="18"/>
          <line x1="12" y1="10" x2="12" y2="18"/>
          <line x1="14" y1="10" x2="14" y2="18"/>
          <line x1="16" y1="10" x2="16" y2="18"/>
          <line x1="18" y1="10" x2="18" y2="18"/>
        </svg>
      </button>

      <button class="btn" aria-label="Month view" aria-pressed="false" data-view="month" title="Month">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <circle cx="7"  cy="11" r="0.7"/><circle cx="11" cy="11" r="0.7"/><circle cx="15" cy="11" r="0.7"/><circle cx="19" cy="11" r="0.7"/>
          <circle cx="7"  cy="14" r="0.7"/><circle cx="11" cy="14" r="0.7"/><circle cx="15" cy="14" r="0.7"/><circle cx="19" cy="14" r="0.7"/>
          <circle cx="7"  cy="17" r="0.7"/><circle cx="11" cy="17" r="0.7"/><circle cx="15" cy="17" r="0.7"/><circle cx="19" cy="17" r="0.7"/>
        </svg>
      </button>

      <button class="btn" aria-label="To-Do list" aria-pressed="false" data-view="todo" title="To-Do">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="5" width="16" height="14" rx="2"/>
          <line x1="4" y1="8" x2="20" y2="8"/>
          <polyline points="7,14 10,17 17,10"/>
        </svg>
      </button>
    </nav>
  </main>

<script>
console.info('Chrono build r29');

const screenEl = document.getElementById('screen');
const buttons = [...document.querySelectorAll('.btn')];

let activeView = null;
let activeDayISO = toISO(new Date());
let visibleWeekFirst = weekStart(new Date());

const SHORT_DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function toISO(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function weekStart(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function toHHMM(min){
  const mm = ((Math.round(min)|0)+1440)%1440;
  const h = Math.floor(mm/60), r = mm%60;
  return `${String(h).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}
function snap15(n){ return 15 * Math.round((+n||0)/15); }

/* Width sync */
new ResizeObserver(()=> {
  const w = screenEl.getBoundingClientRect().width;
  document.documentElement.style.setProperty('--panelW', Math.max(320, Math.floor(w))+'px');
}).observe(screenEl);

/* Storage (light) */
const DB_NAME='chronoDB', DB_VERSION=7;
let dbPromise=null, STORAGE_MODE='idb';
function idbSupported(){ try { return !!window.indexedDB; } catch { return false; } }
function idbOpen(){
  if(!idbSupported()){ STORAGE_MODE='ls'; return Promise.resolve(null); }
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv',{keyPath:'k'});
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror   = ()=>reject(req.error);
  });
  return dbPromise.catch(()=>{ STORAGE_MODE='ls'; return null; });
}
async function storageSet(k,v){
  if(STORAGE_MODE==='ls'){ localStorage.setItem(k, JSON.stringify(v)); return true; }
  const db = await idbOpen(); if(!db){ STORAGE_MODE='ls'; return storageSet(k,v); }
  return new Promise((res,rej)=>{
    const tx=db.transaction('kv','readwrite');
    tx.objectStore('kv').put({k,v});
    tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error);
  });
}
async function storageGet(k){
  if(STORAGE_MODE==='ls'){ const s=localStorage.getItem(k); return s? JSON.parse(s):undefined; }
  const db = await idbOpen(); if(!db){ STORAGE_MODE='ls'; return storageGet(k); }
  return new Promise((res,rej)=>{
    const tx=db.transaction('kv','readonly');
    const req=tx.objectStore('kv').get(k);
    req.onsuccess=()=>res(req.result? req.result.v:undefined);
    req.onerror=()=>rej(req.error);
  });
}
function snapshotState(){ return { activeView, activeDayISO }; }
async function saveAll(){ await storageSet('state', snapshotState()); }
let saveTimer=null;
function saveSoon(ms=600){ clearTimeout(saveTimer); saveTimer=setTimeout(()=>{ saveAll().catch(()=>{}); }, ms); }

/* Controls */
document.querySelector('.controls').addEventListener('click', e=>{
  const b=e.target.closest('.btn'); if(!b) return;
  const v=b.dataset.view;
  if(activeView===v){
    activeView=null; buttons.forEach(x=>x.setAttribute('aria-pressed','false')); screenEl.innerHTML='';
  }else{
    activeView=v; buttons.forEach(x=>x.setAttribute('aria-pressed', String(x===b))); render();
  }
  saveSoon(200);
});

/* ---------- Week View + Selection Marquee + Toolbar ---------- */
let weekGeom=null;              // geometry
let selState=null;              // {dayIdx,startMin,endMin}
let dragKind=null;              // 'top' | 'bottom' | null
let dragStartY=0, baseStart=0, baseEnd=0;

let toolbarCorner=null;         // 'TL'|'TR'|'BL'|'BR'
let toolbarEl=null;
let suppressNextGridTap=false;  // for tap-away close timing

function buildWeekView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head">
        <button id="prevWeekBtn" class="chev" aria-label="Previous week">◀</button>
        <div class="title" id="weekTitle"></div>
        <button id="nextWeekBtn" class="chev" aria-label="Next week">▶</button>
      </div>

      <div class="grid-area">
        <div class="top-row week" id="dowPills"></div>
        <div class="grid" id="weekGrid" aria-label="Weekly grid" role="grid"></div>
        <div class="hours" id="weekHours"></div>
      </div>

      <div class="selHost" id="selHost" aria-hidden="false"></div>
      <div class="hint" id="weekHint">Tap anywhere to edit</div>
    </div>
  `;

  document.getElementById('prevWeekBtn').onclick=()=>{ visibleWeekFirst=addDays(visibleWeekFirst,-7); repaintWeek(); saveSoon(200); };
  document.getElementById('nextWeekBtn').onclick=()=>{ visibleWeekFirst=addDays(visibleWeekFirst, 7); repaintWeek(); saveSoon(200); };

  const grid=document.getElementById('weekGrid');
  grid.addEventListener('click', onWeekGridTap, {passive:true});

  repaintWeek();

  new ResizeObserver(()=>{ repaintWeek(true); positionToolbar(toolbarCorner); }).observe(grid);

  // Tap-away close (anywhere outside selector & toolbar)
  document.addEventListener('click', tapAwayClose, true);

  try{
    if(!localStorage.getItem('hint_week_edit_v4')){
      const hint=document.getElementById('weekHint');
      requestAnimationFrame(()=>{
        hint.classList.add('show');
        setTimeout(()=>{ hint.classList.remove('show'); }, 2200);
      });
      localStorage.setItem('hint_week_edit_v4','1');
    }
  }catch{}
}

function repaintWeek(skipSel=false){
  const first=visibleWeekFirst, last=addDays(first,6);
  const m=new Intl.DateTimeFormat(undefined,{month:'short'});
  const title = (first.getFullYear()===last.getFullYear())
    ? (first.getMonth()===last.getMonth()
        ? `${m.format(first)} ${first.getDate()} – ${last.getDate()}, ${first.getFullYear()}`
        : `${m.format(first)} ${first.getDate()} – ${m.format(last)} ${last.getDate()}, ${first.getFullYear()}`)
    : `${m.format(first)} ${first.getDate()}, ${first.getFullYear()} – ${m.format(last)} ${last.getDate()}, ${last.getFullYear()}`;
  document.getElementById('weekTitle').textContent=title;

  const pills=document.getElementById('dowPills'); pills.innerHTML='';
  for(let i=0;i<7;i++){
    const d=addDays(first,i);
    const el=document.createElement('div'); el.className='day-pill';
    el.textContent = `${SHORT_DOW[i]}, ${d.getDate()}`;
    pills.appendChild(el);
  }

  const gh=document.getElementById('weekHours'); gh.innerHTML='';
  const gridEl=document.getElementById('weekGrid');
  weekGeom=computeGeometry(gridEl,7);
  for(let i=0;i<24;i++){
    const s=document.createElement('div'); s.className='hour-stamp';
    s.textContent = `${String(i).padStart(2,'0')}:00`;
    s.style.top=((weekGeom.rowY[i]+weekGeom.rowY[i+1])/2)+'px';
    gh.appendChild(s);
  }

  buildMask(weekGeom,7);
  if(selState && !skipSel) updateSelectionVisual();
}

function computeGeometry(gridEl, cols){
  const r=gridEl.getBoundingClientRect();
  const totalW=Math.max(0, Math.round(r.width));
  const totalH=Math.max(0, Math.round(r.height));
  const colWBase=Math.floor(totalW/cols), extraW=totalW-colWBase*cols;
  const rowHBase=Math.floor(totalH/24), extraH=totalH-rowHBase*24;

  const colW=[], colX=[0]; for(let c=0;c<cols;c++){ const w=colWBase+(c<extraW?1:0); colW.push(w); colX.push(colX[c]+w); }
  const rowH=[], rowY=[0]; for(let i=0;i<24;i++){ const h=rowHBase+(i<extraH?1:0); rowH.push(h); rowY.push(rowY[i]+h); }

  const slotY=[0];
  for(let hr=0;hr<24;hr++){
    const h=rowH[hr];
    const base=Math.floor(h/4); let rem=h-base*4;
    const parts=[base,base,base,base]; for(let k=0;k<rem;k++) parts[k]+=1;
    for(let q=0;q<4;q++) slotY.push(slotY[slotY.length-1]+parts[q]);
  }
  return {totalW,totalH,colW,colX,rowH,rowY,slotY, rect:r};
}

function buildMask(geom, cols){
  const host=document.getElementById('weekGrid');
  host.innerHTML='';
  const mask=document.createElementNS('http://www.w3.org/2000/svg','svg');
  mask.classList.add('mask');
  mask.setAttribute('width',geom.totalW);
  mask.setAttribute('height',geom.totalH);
  mask.setAttribute('viewBox',`0 0 ${geom.totalW} ${geom.totalH}`);
  mask.setAttribute('preserveAspectRatio','none');
  host.appendChild(mask);
}

function onWeekGridTap(e){
  if(suppressNextGridTap){ suppressNextGridTap=false; return; }

  const grid=document.getElementById('weekGrid');
  const host=document.getElementById('selHost');
  if(!weekGeom) weekGeom = computeGeometry(grid,7);

  const rect=weekGeom.rect;
  const relX=e.clientX - rect.left;
  const relY=e.clientY - rect.top;

  // If a selector is active, a tap on the grid closes it (no creation on same tap)
  if(selState){
    clearSelection();
    suppressNextGridTap=true; // block creation on this event cycle
    return;
  }

  // Find tapped day index
  let dayIdx=0;
  for(let i=0;i<7;i++){
    if(relX >= weekGeom.colX[i] && relX < weekGeom.colX[i+1]){ dayIdx=i; break; }
  }

  // New selection: 60 min starting at the hour top nearest to tap (floor to hour)
  const minuteFloat = clamp(relY / weekGeom.totalH, 0, 1) * 1440;
  const startMin = snap15(Math.floor(minuteFloat/60)*60);
  const endMin   = clamp(startMin + 60, 0, 1440);
  selState = { dayIdx, startMin, endMin };

  host.innerHTML='';
  const m=document.createElement('div');
  m.className='marquee';
  m.innerHTML=`
    <div class="marqueeRect" id="mqRect"></div>

    <div class="stamp" id="mqTopStamp"></div>
    <div class="handle" id="mqTopHandle" title="Drag to adjust start">
      <svg viewBox="0 0 100 48" preserveAspectRatio="none" aria-hidden="true">
        <polygon points="1,47 50,3 99,47"></polygon>
      </svg>
    </div>

    <div class="stamp" id="mqBotStamp"></div>
    <div class="handle" id="mqBotHandle" title="Drag to adjust end">
      <svg viewBox="0 0 100 48" preserveAspectRatio="none" aria-hidden="true">
        <polygon points="1,3 50,47 99,3"></polygon>
      </svg>
    </div>
  `;
  host.appendChild(m);

  // Triangle-only resizing
  m.querySelector('#mqTopHandle').addEventListener('pointerdown', ev=>startDrag(ev,'top'));
  m.querySelector('#mqBotHandle').addEventListener('pointerdown', ev=>startDrag(ev,'bottom'));

  updateSelectionVisual();

  // Toolbar
  const isRightHalf = (dayIdx === 0 || dayIdx >= 5); // Fri–Sun incl. Sun(0)
  const isLeftHalf  = !isRightHalf;
  const isTopHalf   = (startMin < 12*60);
  const tapCorner = (isTopHalf ? 'T' : 'B') + (isLeftHalf ? 'L' : 'R');
  toolbarCorner = oppositeCorner(tapCorner);
  buildToolbar(toolbarCorner);
  positionToolbar(toolbarCorner);
}

function minutesToY(min){
  const idx = clamp(Math.round(min/15), 0, 96);
  return weekGeom.slotY[idx];
}

function updateSelectionVisual(){
  if(!selState) return;
  const host=document.getElementById('selHost');
  const rect=weekGeom.rect;

  const colLeft = weekGeom.colX[selState.dayIdx];
  const colRight= weekGeom.colX[selState.dayIdx+1];
  const colWidth= (colRight - colLeft) - (selState.dayIdx===6?1:0);

  const topY  = minutesToY(selState.startMin);
  const botY  = minutesToY(selState.endMin);
  const height= Math.max(1, botY - topY);

  const offsetLeft = rect.left + colLeft;
  const offsetTop  = rect.top;

  const rEl = host.querySelector('#mqRect');
  rEl.style.left   = `${offsetLeft}px`;
  rEl.style.top    = `${offsetTop + topY}px`;
  rEl.style.width  = `${colWidth}px`;
  rEl.style.height = `${height}px`;

  const stampPad=6, triH=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--handle-height'))||48;
  const stampH=26;

  const topStamp=host.querySelector('#mqTopStamp');
  topStamp.textContent = toHHMM(selState.startMin);
  topStamp.style.left = `${offsetLeft + colWidth/2}px`;
  topStamp.style.top  = `${offsetTop + topY - (stampH + stampPad)}px`;

  const topHandle=host.querySelector('#mqTopHandle');
  topHandle.style.left  = `${offsetLeft}px`;
  topHandle.style.top   = `${offsetTop + topY - (stampH + stampPad + triH)}px`;
  topHandle.style.width = `${colWidth}px`;
  topHandle.style.height= `${triH}px`;

  const botStamp=host.querySelector('#mqBotStamp');
  botStamp.textContent = toHHMM(selState.endMin);
  botStamp.style.left = `${offsetLeft + colWidth/2}px`;
  botStamp.style.top  = `${offsetTop + botY + stampPad}px`;

  const botHandle=host.querySelector('#mqBotHandle');
  botHandle.style.left  = `${offsetLeft}px`;
  botHandle.style.top   = `${offsetTop + botY + stampPad + stampH}px`;
  botHandle.style.width = `${colWidth}px`;
  botHandle.style.height= `${triH}px`;
}

function startDrag(ev, kind){
  if(!selState) return;
  dragKind = kind;
  ev.preventDefault();
  ev.stopPropagation();
  ev.currentTarget.setPointerCapture(ev.pointerId);
  dragStartY = ev.clientY;
  baseStart = selState.startMin;
  baseEnd   = selState.endMin;

  const move=(e)=>{
    const dyPx = e.clientY - dragStartY;
    const deltaMinRaw = (weekGeom.totalH? (dyPx / weekGeom.totalH) * 1440 : 0);
    const snapped = snap15(deltaMinRaw);
    if(dragKind==='top'){
      const newStart = clamp(snap15(baseStart + snapped), 0, snap15(selState.endMin - 15));
      selState.startMin = newStart;
    } else if(dragKind==='bottom'){
      const newEnd = clamp(snap15(baseEnd + snapped), snap15(selState.startMin + 15), 1440);
      selState.endMin = newEnd;
    }
    updateSelectionVisual();
  };

  const up=(e)=>{
    e.currentTarget.releasePointerCapture(e.pointerId);
    window.removeEventListener('pointermove', move);
    window.removeEventListener('pointerup', up);
    dragKind=null;
  };

  window.addEventListener('pointermove', move, {passive:false});
  window.addEventListener('pointerup', up, {passive:true});
}

/* ---------- Tap-away close ---------- */
function tapAwayClose(e){
  if(!selState) return;
  const host=document.getElementById('selHost');
  if(!host) return;

  const mqRect = host.querySelector('#mqRect');
  const topH   = host.querySelector('#mqTopHandle');
  const botH   = host.querySelector('#mqBotHandle');

  // Protected areas: toolbar + handles + marquee body
  if(toolbarEl && toolbarEl.contains(e.target)) return;
  if(mqRect && mqRect.contains(e.target)) return;
  if(topH && topH.contains(e.target)) return;
  if(botH && botH.contains(e.target)) return;

  // Close and suppress grid creation for this same tap
  clearSelection();
  suppressNextGridTap = true;
}

/* ---------- Toolbar ---------- */
function oppositeCorner(c){
  if(c==='TL') return 'BR';
  if(c==='TR') return 'BL';
  if(c==='BL') return 'TR';
  return 'TL';
}

function buildToolbar(corner){
  const host = document.getElementById('selHost');
  if(toolbarEl && toolbarEl.parentNode) toolbarEl.parentNode.removeChild(toolbarEl);

  const el = document.createElement('div');
  el.className = 'toolbar';
  el.setAttribute('role','toolbar');
  el.setAttribute('aria-label','Selection tools');

  const mk = (label, svgPath, action)=>{
    const b=document.createElement('button');
    b.className='tbtn';
    b.type='button';
    b.title=label;
    b.setAttribute('aria-label',label);
    if(action) b.dataset.action = action;
    b.innerHTML = `<svg class="ticon" viewBox="0 0 24 24" aria-hidden="true">${svgPath}</svg>`;
    return b;
  };

  const plusSVG = `<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>`;
  const minusSVG= `<line x1="5" y1="12" x2="19" y2="12"/>`;
  const assignSVG=`<rect x="3" y="6" width="8" height="12" rx="2"/><polyline points="12,12 21,12"/><polyline points="18,9 21,12 18,15"/>`;
  const editSVG  =`<path d="M4 20l4-1 9-9-3-3-9 9-1 4z"/><path d="M13 7l3 3"/>`;
  const dupSVG   =`<rect x="7" y="7" width="11" height="11" rx="2"/><rect x="3" y="3" width="11" height="11" rx="2"/>`;
  const undoSVG  =`<path d="M9 14H5v-4"/><path d="M5 10a7 7 0 1 1 2.05 4.95"/>`;
  const redoSVG  =`<path d="M15 14h4v-4"/><path d="M19 10a7 7 0 1 0-2.05 4.95"/>`;
  const saveSVG  =`<path d="M5 5h11l3 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"/><path d="M7 5v6h10V8"/><rect x="7" y="15" width="10" height="4" rx="1"/>`;
  const trashSVG =`<polyline points="3,7 21,7"/><path d="M8 7v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V7"/><path d="M10 7V5a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"/>`;

  const order = [
    mk('Top Plus', plusSVG,  'top-plus'),
    mk('Top Minus', minusSVG,'top-minus'),
    mk('Assign', assignSVG,  ''),
    mk('Edit', editSVG,      ''),
    mk('Duplicate', dupSVG,  ''),
    mk('Undo', undoSVG,      ''),
    mk('Redo', redoSVG,      ''),
    mk('Save', saveSVG,      ''),
    mk('Discard', trashSVG,  ''),
    mk('Bottom Minus', minusSVG,'bottom-minus'),
    mk('Bottom Plus', plusSVG, 'bottom-plus'),
  ];
  order.forEach(btn=>el.appendChild(btn));

  el.addEventListener('click', onToolbarClick);
  host.appendChild(el);
  toolbarEl = el;
}

function onToolbarClick(e){
  const b = e.target.closest('.tbtn');
  if(!b || !selState) return;
  const act = b.dataset.action || '';
  if(!act) return;

  const step = 15;
  if(act==='top-plus'){
    // extend upward earlier by 15
    const ns = clamp(snap15(selState.startMin - step), 0, snap15(selState.endMin - 15));
    selState.startMin = ns;
    updateSelectionVisual();
  }else if(act==='top-minus'){
    const ns = clamp(snap15(selState.startMin + step), 0, snap15(selState.endMin - 15));
    selState.startMin = ns;
    updateSelectionVisual();
  }else if(act==='bottom-plus'){
    const ne = clamp(snap15(selState.endMin + step), snap15(selState.startMin + 15), 1440);
    selState.endMin = ne;
    updateSelectionVisual();
  }else if(act==='bottom-minus'){
    const ne = clamp(snap15(selState.endMin - step), snap15(selState.startMin + 15), 1440);
    selState.endMin = ne;
    updateSelectionVisual();
  }
}

function positionToolbar(corner){
  if(!toolbarEl || !weekGeom || !corner) return;
  const rect = weekGeom.rect;
  const pad = 8;

  // measure
  toolbarEl.style.left = '-9999px';
  toolbarEl.style.top  = '-9999px';
  const w = toolbarEl.offsetWidth;
  const h = toolbarEl.offsetHeight;

  let left, top;
  if(corner==='TL'){ left = rect.left + pad; top = rect.top + pad; }
  else if(corner==='TR'){ left = rect.right - w - pad; top = rect.top + pad; }
  else if(corner==='BL'){ left = rect.left + pad; top = rect.bottom - h - pad; }
  else { /* BR */ left = rect.right - w - pad; top = rect.bottom - h - pad; }

  // Special case: Sunday selected & left-side corner → place in hour gutter
  if(selState && selState.dayIdx===0 && (corner==='TL' || corner==='BL')){
    left = rect.left - w - pad; // sit fully left of grid
  }

  const vw = document.documentElement.clientWidth;
  const vh = document.documentElement.clientHeight;
  left = clamp(left, 0, Math.max(0, vw - w));
  top  = clamp(top , 0, Math.max(0, vh - h));

  toolbarEl.style.left = `${left}px`;
  toolbarEl.style.top  = `${top}px`;
}

function clearSelection(){
  selState=null;
  const host=document.getElementById('selHost');
  if(host) host.innerHTML='';
  toolbarEl=null;
  toolbarCorner=null;
}

/* ---------- Month & Day Views (minimal stubs) ---------- */
function buildMonthView(){
  screenEl.innerHTML = `
    <div class="wrap">
      <div class="head"><div></div><div class="title">Month</div><div></div></div>
      <div class="grid-area" style="display:grid;place-items:center;color:#666">
        <div class="watermark">Chrono build r29</div>
      </div>
    </div>
  `;
}

/* ---------- Init & render ---------- */
async function init(){
  try{
    const snap = await storageGet('state');
    if(snap && typeof snap==='object'){
      if('activeView' in snap) activeView = snap.activeView;
      if('activeDayISO' in snap) activeDayISO = snap.activeDayISO;
    }
  }catch{}

  visibleWeekFirst = weekStart(new Date());
  activeDayISO = toISO(new Date());
  activeView = 'week';
  render();

  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveAll().catch(()=>{}); });
  window.addEventListener('beforeunload', ()=>{ saveAll().catch(()=>{}); });

  window.addEventListener('resize', ()=>positionToolbar(toolbarCorner));
}

function render(){
  if(activeView==='week'){
    visibleWeekFirst = weekStart(new Date());
    buildWeekView();
  } else if(activeView==='day'){
    buildMonthView(); // placeholder
  } else if(activeView==='month'){
    buildMonthView();
  } else {
    screenEl.innerHTML='';
  }
}

init();
</script>

<!-- Service worker registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.error('SW registration failed', err));
  });
}
</script>

</body>
</html>
