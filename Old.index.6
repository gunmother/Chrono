<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Betterly — Tilt Glass UI + Week View</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#ffffff" />

<style>
  :root{
    /* base surfaces */
    --bg:#ffffff;
    --pane:#ffffff;

    /* dynamic shadow vectors (driven by JS) */
    --sx: 0px;
    --sy: 12px;
    --sblur: 14px;

    /* bevel hotspot for sheen (driven by JS) */
    --hx: 50%;
    --hy: 22%;

    /* layout */
    --app-w: clamp(320px, 92vw, 420px);
    --gap: clamp(18px, 2.6vh, 24px);
    --barH: clamp(34px, 5.2vh, 46px);
    --coin: clamp(52px, 7.6vh, 62px);

    --r-lg: 24px;
    --r-pill: 999px;

    /* LED + brand blues */
    --led:#eaffff;
    --led-glow: rgba(234,255,255,.98);
    --blue-1:#38bdff;
    --blue-2:#0e56ba;

    /* ring */
    --ring-track:#9aaac3;
    --ring-led: var(--led);
    --ring-thickness: 4.5;
    --ring-thickness-px: 4.5px;
    --ring-gap: 10px;

    /* icon inks */
    --ink:#92a0b3;
    --ink-active:var(--led);
  }

  html,body{height:100%;margin:0;background:var(--bg);overflow:hidden;overscroll-behavior:none}
  body{
    font:500 16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    padding: max(16px, env(safe-area-inset-top))
             max(16px, env(safe-area-inset-right))
             max(20px, env(safe-area-inset-bottom))
             max(16px, env(safe-area-inset-left));
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none; user-select: none;
    touch-action: manipulation;
  }

  .app{
    width:var(--app-w);
    height:calc(100svh - max(16px, env(safe-area-inset-top)) - max(20px, env(safe-area-inset-bottom)));
    margin:0 auto; display:grid; grid-template-rows: var(--barH) 1fr auto; gap:var(--gap);
    position:relative;
  }

  /* ===== shared raised panel style */
  .glass{
    background: var(--pane);
    border-radius: var(--r-lg);
    position:relative;
    box-shadow:
      var(--sx) var(--sy) var(--sblur) rgba(0,0,0,.22),
      calc(var(--sx)*.5) calc(var(--sy)*.5) calc(var(--sblur)*.6) rgba(0,0,0,.12);
  }
  .glass::before{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background: radial-gradient(140% 120% at var(--hx) var(--hy),
                 rgba(255,255,255,.55), rgba(255,255,255,0) 58%);
    opacity:.9; mix-blend-mode:screen;
  }

  /* ===== top bar (shadow under everything) */
  .topwrap{ position:relative; z-index:3; }
  .topbar{
    height:var(--barH); border-radius:var(--r-pill); display:flex; align-items:center; justify-content:center; gap:10px;
    background:#f7f9fd; position:relative; box-shadow:none;
  }
  .topwrap .shadow{
    position:absolute; inset:0; border-radius:var(--r-pill); z-index:0; pointer-events:none;
    box-shadow:
      var(--sx) var(--sy) var(--sblur) rgba(0,0,0,.22),
      calc(var(--sx)*.5) calc(var(--sy)*.5) calc(var(--sblur)*.6) rgba(0,0,0,.12);
  }
  .topbar::before{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background: radial-gradient(140% 120% at var(--hx) var(--hy),
                 rgba(255,255,255,.55), rgba(255,255,255,0) 58%);
    opacity:.9; mix-blend-mode:screen;
  }
  .dot{width:8px;height:8px;border-radius:50%; background:#cfd8e6; box-shadow:inset 0 1px 0 #fff, 0 1px 2px rgba(0,0,0,.06)}

  /* ===== center stage (white) above top shadow */
  .stage{ position:relative; z-index:4; }
  .stage .glass{ background:#fff; width:100%; height:100%; overflow:hidden }

  /* ===== coins row */
  .coins{
    display:grid; grid-template-columns: repeat(4, 1fr); gap:22px; align-items:end;
    padding-bottom: 2px;
    position:relative; z-index:5;
    margin-top: 10px;
  }

  /* coin: no placeholder beneath; only a static shadow (::after) */
  .coin{
    width:var(--coin); height:var(--coin); margin:0 auto; border-radius:50%;
    border:0; outline:0; position:relative; cursor:pointer; background:transparent;
    isolation:isolate; overflow:visible;
  }
  .coin::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    z-index:0; pointer-events:none; background:transparent;
    box-shadow:
      var(--sx) var(--sy) var(--sblur) rgba(0,0,0,.30),
      calc(var(--sx)*.6) calc(var(--sy)*.6) calc(var(--sblur)*.5) rgba(0,0,0,.16);
  }

  .ring{
    position:absolute;
    inset: calc(-1 * (var(--ring-gap) + var(--ring-thickness-px)));
    z-index:2; pointer-events:none; overflow:visible;
  }
  .ring svg{ width:100%; height:100%; display:block; overflow:visible }
  .ring .track{
    fill:none; stroke: var(--ring-track); stroke-width: var(--ring-thickness); stroke-linecap:round;
    filter: url(#grooveFilter);
  }
  .ring .arc{
    fill:none; stroke: var(--ring-led); stroke-width: var(--ring-thickness); stroke-linecap:round;
    transform: rotate(-90deg); transform-origin:50% 50%;
    filter: url(#ledGlow);
  }

  .flip{
    position:absolute; inset:0; border-radius:50%;
    transform-style: preserve-3d;
    transition: transform 340ms cubic-bezier(.2,.7,.2,1);
    z-index:1; background:transparent;
  }
  .face{
    position:absolute; inset:0; border-radius:50%;
    display:grid; place-items:center;
    backface-visibility: hidden; -webkit-backface-visibility: hidden;
    background:transparent;
  }
  /* inactive: slightly gray spherical gradient */
  .front{
    background:
      radial-gradient(160% 160% at 22% 18%, #ffffff 0%, #f3f7fd 22%, #e8eff9 48%, #e4edf8 68%, #e0eaf7 100%);
  }
  /* active: deep blue */
  .back{
    transform: rotate3d(1,1,0,180deg);
    background: radial-gradient(120% 120% at 30% 30%, var(--blue-1), var(--blue-2) 70%);
  }

  .icon{ width:68%; height:68%; overflow:visible }
  .icon *{ vector-effect: non-scaling-stroke; }
  .front .icon{ fill:none; stroke: var(--ink); stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; }
  .back  .icon{ fill:none; stroke: var(--ink-active); stroke-width:2.0; stroke-linecap:round; stroke-linejoin:round; filter:url(#ledGlow); }

  .coin.active .flip{ transform: rotate3d(1,1,0,180deg); }
  .coin:focus-visible{ outline:2px solid #8ecbff; outline-offset:2px; border-radius:50%; }

  @media (max-height: 600px){
    :root{ --gap:14px; --coin:48px; }
  }
  @media (prefers-reduced-motion: reduce){
    .flip{ transition:none }
  }

  /* ===== Week view (inside center screen) ===== */
  #weekMount{position:absolute; inset:14px; display:grid; grid-template-rows:auto 14px 1fr; gap:8px}
  #weekMount[hidden]{display:none}
  #weekTitle{font-weight:800; font-size:16px; text-align:center; color:#0F172A}
  #weekHead{display:grid; grid-template-columns:56px 1fr; align-items:center}
  #weekHours{position:relative; height:14px}
  #weekHours .tick{position:absolute; transform:translateX(-50%); font-size:10px; color:#64748B}
  #weekLabels{position:relative; height:14px}
  #weekLabels .dow{position:absolute; transform:translateX(-50%); font-size:11px; font-weight:700; color:#364152}
  #weekGridWrap{position:relative; display:grid; grid-template-columns:56px 1fr; gap:0}
  #weekGrid{position:relative; height:calc(100% - 0px); background:#E3E7EE; overflow:hidden}
  #maskSvg{position:absolute; inset:0; pointer-events:none}
  #blocksLayer{position:absolute; inset:0}
  #nowHint{position:absolute; border:2px solid #0EA5E9; border-radius:999px; background:rgba(255,255,255,0.18); display:none}
</style>
</head>
<body>
  <!-- global SVG filters for LED + groove -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <filter id="ledGlow" x="-40%" y="-40%" width="180%" height="180%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="1.0" result="g"/>
        <feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <filter id="grooveFilter" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0.7" dy="0.7" stdDeviation="0.7" flood-color="#b8c3d6" flood-opacity=".65"/>
        <feDropShadow dx="-0.7" dy="-0.7" stdDeviation="0.7" flood-color="#ffffff" flood-opacity=".9"/>
      </filter>
    </defs>
  </svg>

  <main class="app">
    <!-- TOP BAR (shadow under all) -->
    <div class="topwrap">
      <div class="shadow" aria-hidden="true"></div>
      <div class="topbar" aria-label="Menu handle">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>

    <!-- CENTER SCREEN -->
    <section class="stage">
      <div class="glass" aria-label="Center screen">
        <!-- WEEK VIEW MOUNT (hidden until Week coin is active) -->
        <div id="weekMount" hidden>
          <div id="weekTitle">—</div>
          <div id="weekHead">
            <div id="weekHours"></div>
            <div id="weekLabels"></div>
          </div>
          <div id="weekGridWrap">
            <div></div>
            <div id="weekGrid" aria-label="Weekly grid">
              <svg id="maskSvg" aria-hidden="true"></svg>
              <div id="blocksLayer"></div>
              <div id="nowHint" aria-hidden="true"></div>
            </div>
          </div>
        </div>
        <!-- /WEEK VIEW -->
      </div>
    </section>

    <!-- BUTTONS -->
    <div class="coins" role="group" aria-label="Primary views">
      <!-- Day (8 identical rays) -->
      <button class="coin" aria-label="Day view" aria-pressed="false" data-name="day" data-progress="0.42">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4.6"/><g>
              <line x1="12" y1="2.2"  x2="12" y2="4.2"/>
              <line x1="19.8" y1="12"  x2="21.8" y2="12"/>
              <line x1="12" y1="19.8" x2="12" y2="21.8"/>
              <line x1="2.2" y1="12"  x2="4.2" y2="12"/>
              <line x1="17.3" y1="6.7" x2="18.7" y2="5.3"/>
              <line x1="17.3" y1="17.3" x2="18.7" y2="18.7"/>
              <line x1="6.7"  y1="17.3" x2="5.3"  y2="18.7"/>
              <line x1="6.7"  y1="6.7"  x2="5.3"  y2="5.3"/>
            </g></svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4.6"/><g>
              <line x1="12" y1="2.2"  x2="12" y2="4.2"/>
              <line x1="19.8" y1="12"  x2="21.8" y2="12"/>
              <line x1="12" y1="19.8" x2="12" y2="21.8"/>
              <line x1="2.2" y1="12"  x2="4.2" y2="12"/>
              <line x1="17.3" y1="6.7" x2="18.7" y2="5.3"/>
              <line x1="17.3" y1="17.3" x2="18.7" y2="18.7"/>
              <line x1="6.7"  y1="17.3" x2="5.3"  y2="18.7"/>
              <line x1="6.7"  y1="6.7"  x2="5.3"  y2="5.3"/>
            </g></svg>
          </div>
        </div>
      </button>

      <!-- Week (7 vertical bars) -->
      <button class="coin" aria-label="Week view" aria-pressed="false" data-name="week" data-progress="0.18">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g><line x1="6" y1="10" x2="6" y2="19.5"/><line x1="8" y1="10" x2="8" y2="19.5"/><line x1="10" y1="10" x2="10" y2="19.5"/><line x1="12" y1="10" x2="12" y2="19.5"/><line x1="14" y1="10" x2="14" y2="19.5"/><line x1="16" y1="10" x2="16" y2="19.5"/><line x1="18" y1="10" x2="18" y2="19.5"/></g>
            </svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g><line x1="6" y1="10" x2="6" y2="19.5"/><line x1="8" y1="10" x2="8" y2="19.5"/><line x1="10" y1="10" x2="10" y2="19.5"/><line x1="12" y1="10" x2="12" y2="19.5"/><line x1="14" y1="10" x2="14" y2="19.5"/><line x1="16" y1="10" x2="16" y2="19.5"/><line x1="18" y1="10" x2="18" y2="19.5"/></g>
            </svg>
          </div>
        </div>
      </button>

      <!-- Month (dense dots) -->
      <button class="coin" aria-label="Month view" aria-pressed="false" data-name="month" data-progress="0.63">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g>
                <circle cx="6.2" cy="11" r=".8"/><circle cx="8.9" cy="11" r=".8"/><circle cx="11.6" cy="11" r=".8"/><circle cx="14.3" cy="11" r=".8"/><circle cx="17.0" cy="11" r=".8"/>
                <circle cx="6.2" cy="12.9" r=".8"/><circle cx="8.9" cy="12.9" r=".8"/><circle cx="11.6" cy="12.9" r=".8"/><circle cx="14.3" cy="12.9" r=".8"/><circle cx="17.0" cy="12.9" r=".8"/>
                <circle cx="6.2" cy="14.8" r=".8"/><circle cx="8.9" cy="14.8" r=".8"/><circle cx="11.6" cy="14.8" r=".8"/><circle cx="14.3" cy="14.8" r=".8"/><circle cx="17.0" cy="14.8" r=".8"/>
                <circle cx="6.2" cy="16.7" r=".8"/><circle cx="8.9" cy="16.7" r=".8"/><circle cx="11.6" cy="16.7" r=".8"/><circle cx="14.3" cy="16.7" r=".8"/><circle cx="17.0" cy="16.7" r=".8"/>
                <circle cx="6.2" cy="18.6" r=".8"/><circle cx="8.9" cy="18.6" r=".8"/><circle cx="11.6" cy="18.6" r=".8"/><circle cx="14.3" cy="18.6" r=".8"/><circle cx="17.0" cy="18.6" r=".8"/>
              </g>
            </svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <g>
                <circle cx="6.2" cy="11" r=".8"/><circle cx="8.9" cy="11" r=".8"/><circle cx="11.6" cy="11" r=".8"/><circle cx="14.3" cy="11" r=".8"/><circle cx="17.0" cy="11" r=".8"/>
                <circle cx="6.2" cy="12.9" r=".8"/><circle cx="8.9" cy="12.9" r=".8"/><circle cx="11.6" cy="12.9" r=".8"/><circle cx="14.3" cy="12.9" r=".8"/><circle cx="17.0" cy="12.9" r=".8"/>
                <circle cx="6.2" cy="14.8" r=".8"/><circle cx="8.9" cy="14.8" r=".8"/><circle cx="11.6" cy="14.8" r=".8"/><circle cx="14.3" cy="14.8" r=".8"/><circle cx="17.0" cy="14.8" r=".8"/>
                <circle cx="6.2" cy="16.7" r=".8"/><circle cx="8.9" cy="16.7" r=".8"/><circle cx="11.6" cy="16.7" r=".8"/><circle cx="14.3" cy="16.7" r=".8"/><circle cx="17.0" cy="16.7" r=".8"/>
                <circle cx="6.2" cy="18.6" r=".8"/><circle cx="8.9" cy="18.6" r=".8"/><circle cx="11.6" cy="18.6" r=".8"/><circle cx="14.3" cy="18.6" r=".8"/><circle cx="17.0" cy="18.6" r=".8"/>
              </g>
            </svg>
          </div>
        </div>
      </button>

      <!-- To-Do (check) -->
      <button class="coin" aria-label="To-Do list" aria-pressed="false" data-name="todo" data-progress="0.05">
        <div class="ring" aria-hidden="true">
          <svg viewBox="0 0 100 100"><circle class="track" cx="50" cy="50" r="46"/><circle class="arc" cx="50" cy="50" r="46" pathLength="100" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
        </div>
        <div class="flip">
          <div class="face front">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <polyline points="6.5,14 10,17.5 17.5,10"/>
            </svg>
          </div>
          <div class="face back">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="4" y="5" width="16" height="14" rx="2" ry="2"/><line x1="4" y1="8" x2="20" y2="8"/>
              <polyline points="6.5,14 10,17.5 17.5,10"/>
            </svg>
          </div>
        </div>
      </button>
    </div>

    <button id="enable" hidden>Enable motion</button>
  </main>

<script>
  /* ===== Progress rings ===== */
  const coins=[...document.querySelectorAll('.coin')];
  function updateRing(el){
    const p = Math.max(0, Math.min(1, parseFloat(el.dataset.progress ?? '0')));
    const arc = el.querySelector('.arc');
    arc.setAttribute('stroke-dasharray','100');
    arc.setAttribute('stroke-dashoffset', (100 - p*100).toFixed(2));
  }
  coins.forEach(updateRing);

  /* ===== Flip toggle + mutual exclusivity (tap again to deactivate) */
  function setActive(target){
    const already = target.classList.contains('active');
    coins.forEach(btn=>{
      const on = !already && btn===target;
      btn.classList.toggle('active', on);
      btn.setAttribute('aria-pressed', String(on));
    });
    const name = target?.dataset?.name;
    if(!already && name==='week'){ showWeek(true); }
    else if(already && name==='week'){ showWeek(false); }
    else { showWeek(false); }
  }
  document.querySelector('.coins').addEventListener('click', e=>{
    const c=e.target.closest('.coin'); if(!c) return;
    setActive(c);
  });

  /* ===== Preserve dynamic shadow physics, smoother near-vertical */
  const root=document.documentElement;
  let beta=18, gamma=0, sx=0, sy=12;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  function animate(){
    const max=34;
    const tx=clamp((gamma||0)/45, -1, 1)*max;
    const ty=clamp((beta ||0)/45, -1, 1)*max;

    sx = lerp(sx, tx, 0.12);
    sy = lerp(sy, ty+8, 0.12);

    const mag=Math.hypot(sx,sy);
    root.style.setProperty('--sx',  sx.toFixed(1)+'px');
    root.style.setProperty('--sy',  sy.toFixed(1)+'px');
    root.style.setProperty('--sblur', (12 + mag*0.45).toFixed(1)+'px');

    root.style.setProperty('--hx',  (50 - sx*1.1/max*45)+'%');
    root.style.setProperty('--hy',  (22 - sy*0.7/max*45)+'%');

    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  function startMotion(){
    window.addEventListener('deviceorientation', e=>{
      if(e.beta==null||e.gamma==null) return;
      const dz=2.0;
      beta = Math.abs(e.beta)  < dz ? 0 : e.beta;
      gamma= Math.abs(e.gamma) < dz ? 0 : e.gamma;
    }, true);
  }
  (async()=>{
    const btn=document.getElementById('enable');
    try{
      if (typeof DeviceOrientationEvent!=='undefined' &&
          typeof DeviceOrientationEvent.requestPermission==='function'){
        btn.hidden=false;
        btn.onclick=async ()=>{
          try{
            const res=await DeviceOrientationEvent.requestPermission();
            if(res==='granted'){ btn.hidden=true; startMotion(); }
          }catch{}
        };
      }else{ startMotion(); }
    }catch{ startMotion(); }
  })();

  if(!('ontouchstart' in window)){
    window.addEventListener('mousemove', e=>{
      const w=innerWidth, h=innerHeight;
      gamma=(e.clientX/w - 0.5)*90;
      beta =(0.5 - e.clientY/h)*90;
    });
  }

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js');
  }

  /* ===== Minimal Week engine (inline, UI-agnostic) ===== */
  class WeekCore {
    constructor(opts){
      this.measureGrid = opts.measureGrid;
      this.onRenderTitle = opts.onRenderTitle||(()=>{});
      this.onRenderLabels= opts.onRenderLabels||(()=>{});
      this.onRenderHours = opts.onRenderHours||(()=>{});
      this.onRenderBlocks= opts.onRenderBlocks||(()=>{});
      this.onRenderMask  = opts.onRenderMask  ||(()=>{});
      this.onRenderNowHint=opts.onRenderNowHint||(()=>{});
      this.SLOTS=96;
      this.SHORT=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      this.weekOffset=0; this.first=null;
      this._geom=null; this._slots=this._blankWeek();
      this.gotoWeek(0);
    }
    gotoWeek(delta=0){
      this.weekOffset+=delta;
      const t=new Date(); const f=new Date(t);
      f.setDate(t.getDate()-t.getDay()+this.weekOffset*7); f.setHours(0,0,0,0);
      this.first=f; this._render(true);
    }
    rebuild(){ this._render(true); }
    _blankWeek(){ return Array.from({length:7},()=>Array(this.SLOTS).fill(null)); }
    _title(){
      const a=this.first, b=new Date(a); b.setDate(a.getDate()+6);
      const m=new Intl.DateTimeFormat(undefined,{month:'short'});
      if(a.getFullYear()===b.getFullYear()){
        if(a.getMonth()===b.getMonth()) return `${m.format(a)} ${a.getDate()} – ${b.getDate()}, ${a.getFullYear()}`;
        return `${m.format(a)} ${a.getDate()} – ${m.format(b)} ${b.getDate()}, ${a.getFullYear()}`;
      }
      return `${m.format(a)} ${a.getDate()}, ${a.getFullYear()} – ${m.format(b)} ${b.getDate()}, ${b.getFullYear()}`;
    }
    _render(force){
      this.onRenderTitle(this._title());
      this.onRenderLabels(this.SHORT);
      this.onRenderHours(Array.from({length:25},(_,i)=>String(i).padStart(2,'0')+':00'));
      const box=this.measureGrid(); if(!box||!box.width||!box.height) return;
      if(force || !this._geom || this._geom.w!==box.width || this._geom.h!==box.height){
        this._geom=this._computeGeom(box.width, box.height);
        this.onRenderMask(this._geom);
      }
      // empty blocks by default (no tasks yet) — grid + labels still render
      this.onRenderBlocks(this._slots, this._geom, {});
      this.onRenderNowHint(this._nowRect(this._geom));
    }
    _computeGeom(w,h){
      const colWBase=Math.floor(w/7), extraW=w-colWBase*7;
      const colW=[], colX=[0]; for(let c=0;c<7;c++){ const W=colWBase+(c<extraW?1:0); colW.push(W); colX.push(colX[c]+W); }
      const rowHBase=Math.floor(h/24), extraH=h-rowHBase*24;
      const rowH=[], rowY=[0]; for(let r=0;r<24;r++){ const H=rowHBase+(r<extraH?1:0); rowH.push(H); rowY.push(rowY[r]+H); }
      const slotHeights=[]; for(let hr=0;hr<24;hr++){ const H=rowH[hr], b=Math.floor(H/4), e=H-b*4; const parts=[b,b,b,b]; const start=hr%4; for(let k=0;k<e;k++) parts[(start+k)%4]+=1; slotHeights.push(parts); }
      const slotY=[0]; for(let hr=0;hr<24;hr++){ for(let q=0;q<4;q++) slotY.push(slotY[slotY.length-1]+slotHeights[hr][q]); }
      return {w,h,colW,colX,rowH,rowY,slotY};
    }
    _nowRect(g){
      // only if today in visible range
      const today=new Date(); const start=new Date(this.first); start.setHours(0,0,0,0);
      const end=new Date(this.first); end.setDate(end.getDate()+6); end.setHours(0,0,0,0);
      const td=new Date(today); td.setHours(0,0,0,0);
      if(td<start || td>end) return null;
      const dow=today.getDay();
      const mins=today.getHours()*60 + today.getMinutes();
      const hr=Math.floor(mins/60); const hourTop=g.rowY[hr]; const hourH=g.rowY[hr+1]-g.rowY[hr];
      const extra=Math.min(10, Math.floor(hourH*0.25));
      const top=Math.max(0, Math.min(g.h-(hourH+extra), hourTop-Math.floor(extra/2)));
      const height=Math.min(g.h-top, hourH+extra);
      const left=g.colX[dow]; const width=(dow===6)?Math.max(0,g.colW[dow]-1):g.colW[dow];
      return {left,top,width,height};
    }
  }

  /* ===== Week render wiring ===== */
  const weekMount = document.getElementById('weekMount');
  const weekTitle = document.getElementById('weekTitle');
  const weekLabels= document.getElementById('weekLabels');
  const weekHours = document.getElementById('weekHours');
  const grid      = document.getElementById('weekGrid');
  const maskSvg   = document.getElementById('maskSvg');
  const blocksLay = document.getElementById('blocksLayer');
  const nowHint   = document.getElementById('nowHint');

  function placeEven(container, labels){
    container.innerHTML='';
    const r = container.getBoundingClientRect();
    const n = labels.length;
    labels.forEach((txt,i)=>{
      const el = document.createElement('div');
      el.textContent = txt;
      el.className = (container===weekLabels) ? 'dow' : 'tick';
      const x = (n===1?0:(i/(n-1)))*r.width;
      el.style.left = `${x}px`;
      container.appendChild(el);
    });
  }

  const core = new WeekCore({
    measureGrid: ()=> {
      const r = grid.getBoundingClientRect();
      return { width: Math.round(r.width), height: Math.round(r.height) };
    },
    onRenderTitle: (txt)=>{ weekTitle.textContent = txt; },
    onRenderLabels: (names)=>{ requestAnimationFrame(()=>placeEven(weekLabels, names)); },
    onRenderHours: (stamps)=>{ const picks=[0,6,12,18,24].map(h=>String(h).padStart(2,'0')+':00'); requestAnimationFrame(()=>placeEven(weekHours, picks)); },
    onRenderBlocks: (slots, geom, colors)=>{
      blocksLay.innerHTML='';
      // draw nothing (no tasks) — grid + mask lines provide structure
    },
    onRenderMask: (g)=>{
      // draw thin grid: vertical day separators + hourly rows
      const NS='http://www.w3.org/2000/svg';
      maskSvg.innerHTML='';
      maskSvg.setAttribute('viewBox', `0 0 ${g.w} ${g.h}`);
      maskSvg.setAttribute('preserveAspectRatio','none');
      const vGroup=document.createElementNS(NS,'g');
      vGroup.setAttribute('stroke','#cfd6e2'); vGroup.setAttribute('stroke-width','1');
      for(let d=1; d<7; d++){
        const x=g.colX[d]; const line=document.createElementNS(NS,'line');
        line.setAttribute('x1',x); line.setAttribute('x2',x);
        line.setAttribute('y1',0); line.setAttribute('y2',g.h);
        vGroup.appendChild(line);
      }
      const hGroup=document.createElementNS(NS,'g');
      hGroup.setAttribute('stroke','#dde3ee'); hGroup.setAttribute('stroke-width','1');
      for(let r=1;r<24;r++){
        const y=g.rowY[r]; const line=document.createElementNS(NS,'line');
        line.setAttribute('x1',0); line.setAttribute('x2',g.w);
        line.setAttribute('y1',y); line.setAttribute('y2',y);
        hGroup.appendChild(line);
      }
      maskSvg.appendChild(vGroup); maskSvg.appendChild(hGroup);
    },
    onRenderNowHint: (rect)=>{
      if(!rect){ nowHint.style.display='none'; return; }
      nowHint.style.left = rect.left+'px';
      nowHint.style.top = rect.top+'px';
      nowHint.style.width = rect.width+'px';
      nowHint.style.height = rect.height+'px';
      nowHint.style.display = 'block';
    }
  });

  function showWeek(on){
    weekMount.hidden = !on;
    if(on){
      // render after layout becomes measurable
      requestAnimationFrame(()=>core.rebuild());
    }
  }
  addEventListener('resize', ()=>{ if(!weekMount.hidden) core.rebuild(); }, {passive:true});
</script>
</body>
</html>
